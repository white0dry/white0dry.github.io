<!DOCTYPE html>

<html lang="zh-CN">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>章鱼喷墨机</title>

    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">

    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>



    <style>



        /* --- 全局与主题样式 --- */

        :root {

            --bg-color: #F5D0E6;

            --primary-color: #6B8AB8;

            --secondary-color: #4A6B9A;

            --accent-color: #5F7A9D;

            --text-color: #4A6B9A;

            --white-color: #fff;

            --border-radius: 18px;

            --phone-corner-radius: 0px;

            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;

            --top-pinned-bg: #fff0f5;

            --online-status-color: #4CAF50;

        }



        *,

        *::before,

        *::after {

            box-sizing: border-box;

        }



        body {

            font-family: var(--font-family);

            margin: 0;

            padding: 0;

            background: linear-gradient(135deg, #F5F5F5, #F5F5F5);

            display: flex;

            align-items: center;

            justify-content: center;

            min-height: 100vh;

        }



        .phone-screen {

            width: 100%;

            max-width: 420px;

            height: 100vh;

            max-height: 850px;

            background-color: var(--white-color);

            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);

            border-radius: var(--phone-corner-radius);

            overflow: hidden;

            position: relative;

            display: flex;

            flex-direction: column;

        }



        .screen {

            display: none;

            flex-direction: column;

            width: 100%;

            height: 100%;

            animation: fadeIn 0.5s ease;

        }



        .screen.active {

            display: flex;

        }


/* --- ✨ 页面美化（卡片式设计）开始 ✨ --- */

/* 通用设置卡片样式 */
.settings-page-content {
    padding: 15px !important;
    background-color: #f7f8fa;
}

.settings-card {
    background-color: #fff;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    overflow: hidden;
}
.settings-card .form-group {
    padding: 0 15px;
    margin-bottom: 15px;
}
.settings-card .btn {
    margin: 0 15px 15px;
    width: calc(100% - 30px);
}

.settings-item {
    display: flex;
    align-items: center;
    padding: 14px 15px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}
.settings-item:last-child {
    border-bottom: none;
}
.settings-item:hover {
    background-color: #fafcff;
}

.settings-item svg {
    width: 22px;
    height: 22px;
    fill: var(--primary-color);
    margin-right: 15px;
    flex-shrink: 0;
}

.settings-item label, .settings-item .label {
    color: #333;
    font-size: 15px;
    flex-grow: 1;
    font-weight: 500;
}

.settings-item input,
.settings-item select {
    border: none;
    text-align: right;
    color: #888;
    font-size: 15px;
    background: transparent;
    outline: none;
    width: 60%;
    direction: rtl;
}
.settings-item input::placeholder {
    color: #ccc;
}


/* 世界书卡片样式 */
.world-book-card {
    display: flex;
    align-items: flex-start;
    background-color: #fff;
    border-radius: 12px;
    margin-bottom: 10px;
    padding: 15px;
    gap: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}
.world-book-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
}

.world-book-card-icon svg {
    width: 28px;
    height: 28px;
    fill: var(--primary-color);
    margin-top: 3px;
    flex-shrink: 0;
}

.world-book-card-content {
    flex-grow: 1;
    overflow: hidden;
}

.world-book-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.world-book-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.world-book-card-badge {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    color: var(--primary-color);
    background-color: #eaf1f8;
    font-weight: 500;
    flex-shrink: 0;
}

.world-book-card-preview {
    font-size: 14px;
    color: #777;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* 最多显示两行 */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    margin: 0;
}

/* 主屏幕自定义卡片样式 */
.icon-customize-card {
    display: flex;
    align-items: center;
    background-color: #fff;
    border-radius: 12px;
    padding: 15px;
    gap: 15px;
    margin-bottom: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
}
.icon-customize-preview {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
    border: 1px solid #f0f0f0;
}
.icon-customize-details {
    flex-grow: 1;
}
.icon-customize-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 8px 0;
}
.icon-url-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.icon-url-wrapper input {
    flex-grow: 1;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
    font-size: 13px;
    background-color: #f7f8fa;
    outline: none;
    transition: border-color 0.2s;
}
.icon-url-wrapper input:focus {
    border-color: var(--primary-color);
}
.icon-url-wrapper button {
    background: #e9ecf0;
    border: none;
    color: #888;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    padding: 10px 15px;
    border-radius: 8px;
    transition: background-color 0.2s, color 0.2s;
}
.icon-url-wrapper button:hover {
    background-color: #d1d5db;
    color: #555;
}



        @keyframes fadeIn {

            from {

                opacity: 0;

                transform: scale(0.95);

            }

            to {

                opacity: 1;

                transform: scale(1);

            }

        }



        .app-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 10px 20px;

            background-color: rgba(255, 255, 255, 0.8);

            backdrop-filter: blur(10px);

            border-bottom: 1px solid #eee;

            flex-shrink: 0;

            position: relative;

            z-index: 10;

        }



        .app-header .back-btn,

        .app-header .action-btn {

            background: none;

            border: none;

            font-size: 24px;

            font-weight: bold;

            color: var(--primary-color);

            cursor: pointer;

            width: 40px;

            height: 40px;

            display: flex;

            align-items: center;

            justify-content: center;

        }



        #cancel-multi-select-btn {

            font-size: 14px !important;

            font-weight: 500 !important;

            color: var(--white-color) !important;

            background-color: var(--primary-color) !important;

            border-radius: 10px !important;

            padding: 5px 10px !important;

            width: auto !important;

            height: auto !important;

        }

/* --- Diary Screen Styles --- */
.diary-item {
    background-color: #FEFEFF; /* 温柔的米黄色 */
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-left: 4px solid var(--primary-color);
}
.diary-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #eee;
}
.diary-date {
    font-size: 14px;
    font-weight: 600;
    color: var(--secondary-color);
}
.diary-actions button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    opacity: 0.6;
}
.diary-actions button:hover {
    opacity: 1;
}
.diary-actions svg {
    width: 18px;
    height: 18px;
    fill: #888;
}
.diary-content {
    font-size: 15px;
    line-height: 1.7;
    color: #555;
    white-space: pre-wrap; /* 保留换行和空格 */
}


        .app-header .action-btn-group {

            display: flex;

            align-items: center;

            gap: 10px;

        }



        .app-header .action-btn-group .action-btn {

            font-size: 16px;

            font-weight: 600;

            width: auto;

            padding: 6px 12px;

            border-radius: 10px;

        }



        .app-header .action-btn-group #create-group-btn {

            background-color: var(--primary-color);

            color: var(--white-color);

        }



        .app-header .action-btn-group #add-chat-btn {

            font-size: 28px;

            padding: 0;

            width: 40px;

            height: 40px;

            background-color: transparent;

            color: var(--primary-color);

            border-radius: 50%;

        }



        .app-header .action-btn img {

            width: 28px;

            height: 28px;

        }



        .        .app-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 10px 20px;

            background-color: rgba(255, 255, 255, 0.8);

            backdrop-filter: blur(10px);

            border-bottom: 1px solid #eee;

            flex-shrink: 0;

            position: relative;

            z-index: 10;

        }

        .app-header .title-container {

            display: flex;

            flex-direction: column;

            align-items: center;

            text-align: center;

            margin: 0 auto;

        }




        .app-header .title {

            font-size: 18px;

            font-weight: 600;

            color: var(--text-color);

            margin: 0;

        }



        .app-header .subtitle {

            font-size: 12px;

            color: #888;

            display: flex;

            align-items: center;

            margin-top: 2px;

        }



        .online-indicator {

            width: 8px;

            height: 8px;

            border-radius: 50%;

            background-color: var(--online-status-color);

            margin-right: 5px;

        }



        .app-header .placeholder {

            width: 40px;

        }



        #home-screen {

            justify-content: space-between;

            background-size: cover;

            background-position: center;

            transition: background-image 0.5s ease-in-out;

            padding: 50px 0;

        }



        .time-widget {

            text-align: center;

            padding: 0 20px;

            color: var(--text-color);

        }



        .time-widget .time {

            font-size: 72px;

            font-weight: 600;

        }



        .time-widget .date {

            font-size: 18px;

            color: #666;

        }



        #home-screen.day-mode .time-widget,

        #home-screen.day-mode .time-widget .date,

        #home-screen.day-mode .app-icon .app-name {

            color: var(--white-color);

            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);

        }



        .app-grid {

            width: 100%;

            padding: 20px 40px;

            display: grid;

            grid-template-columns: repeat(3, 1fr);

            gap: 20px;

            justify-content: center;

            align-content: center;

            margin-top: 40px;

        }



        #home-screen.day-mode .time-widget,

        #home-screen.day-mode .time-widget .date,

        #home-screen.day-mode .app-icon .app-name {

            color: var(--white-color);

            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);

        }



        .dock {

            display: flex;

            justify-content: center;

            align-items: center;

            padding: 10px;

            background-color: rgba(255, 255, 255, 0.7);

            backdrop-filter: blur(10px);

            border-radius: var(--border-radius);

            margin: 0 20px;

            min-height: 80px;

            gap: 15px;

        }



        .app-icon {

            display: flex;

            flex-direction: column;

            align-items: center;

            cursor: pointer;

            text-decoration: none;

        }



        .icon-img {

            width: 60px;

            height: 60px;

            border-radius: 15px;

            margin-bottom: 8px;

            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);

            transition: transform 0.2s ease;

            object-fit: cover;

        }



        .app-icon:hover .icon-img {

            transform: translateY(-5px);

        }



        .app-icon .app-name {

            font-size: 12px;

            color: var(--text-color);

            font-weight: 500;

        }



                .content {
            flex: 1 1 auto; 
            overflow-y: auto;
            padding: 20px;
            position: relative;
            min-height: 0; 
        }




        .placeholder-text {

            text-align: center;

            color: #aaa;

            margin-top: 50px;

        }



        .modal-overlay {

            position: absolute;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.4);

            z-index: 100;

            display: none;

            align-items: center;

            justify-content: center;

            animation: fadeIn 0.3s ease;

        }



        .modal-overlay.visible {

            display: flex;

        }



        .modal-window {

            background: var(--white-color);

            padding: 25px;

            border-radius: var(--border-radius);

            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);

            width: 85%;

            max-width: 340px;

            animation: slideUp 0.4s ease-out;

        }



        .modal-window h3 {

            margin-top: 0;

            text-align: center;

            color: var(--primary-color);

        }



        @keyframes slideUp {

            from {

                transform: translateY(20px);

                opacity: 0;

            }

            to {

                transform: translateY(0);

                opacity: 1;

            }

        }



        #edit-group-member-modal,

        #create-member-for-group-modal {

            z-index: 102;

        }



        #edit-group-member-modal .avatar-preview,

        #create-member-for-group-modal .avatar-preview {

            width: 80px;

            height: 80px;

        }



        .context-menu {

            position: fixed;

            z-index: 1000;

            background: white;

            border-radius: 10px;

            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);

            overflow: hidden;

            padding: 5px 0;

            animation: fadeIn 0.1s ease;

        }



        .context-menu-item {

            padding: 10px 20px;

            cursor: pointer;

        }



        .context-menu-item:hover {

            background-color: #f5f5f5;

        }



        .context-menu-item.danger {

            color: #e53935;

        }



        .action-sheet-overlay {

            position: absolute;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0, 0, 0, 0.4);

            z-index: 200;

            display: none;

            align-items: flex-end;

            animation: fadeIn 0.3s ease;

        }



        .action-sheet-overlay.visible {

            display: flex;

        }

       


        .action-sheet {

            background: #f7f7f7;

            width: 100%;

            border-top-left-radius: 20px;

            border-top-right-radius: 20px;

            padding: 10px;

            padding-bottom: calc(10px + env(safe-area-inset-bottom));

            animation: slideUp 0.3s ease-out;

        }



        .action-sheet-button {

            width: 100%;

            background: white;

            border: none;

            padding: 15px;

            font-size: 16px;

            color: var(--primary-color);

            font-weight: 500;

            cursor: pointer;

            border-radius: 10px;

            margin-bottom: 8px;

        }



        .action-sheet-button.danger {

            color: #e53935;

        }



        .action-sheet-button:last-child {

            margin-bottom: 0;

        }






        .list-container {

            list-style: none;

            margin: 0;

            padding: 0;

        }



        .list-item {

            display: flex;

            align-items: center;

            padding: 10px 20px;

            cursor: pointer;

            border-bottom: 1px solid #f0f0f0;

            transition: background-color 0.2s ease;

            position: relative;

        }



        .list-item:hover {

            background-color: #fdf6f8;

        }



        .chat-item.pinned {

            background-color: var(--top-pinned-bg);

        }



        .chat-avatar {

            width: 50px;

            height: 50px;

            border-radius: 50%;

            margin-right: 15px;

            object-fit: cover;

            flex-shrink: 0;

            background-color: #eee;

        }



        .group-avatar {

            border-radius: 10px;

        }



        .item-details {

            flex-grow: 1;

            overflow: hidden;

        }



        .item-details-row {

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .item-name {

            font-weight: 600;

            color: var(--text-color);

            font-size: 16px;

        }



        .item-preview-wrapper {

            display: flex;

            align-items: center;

            gap: 8px;

            margin-top: 4px;

        }



        .item-preview {

            font-size: 14px;

            color: #888;

            white-space: nowrap;

            overflow: hidden;

            text-overflow: ellipsis;

            flex-grow: 1;

        }



        .pin-badge {

            background-color: var(--primary-color);

            color: white;

            font-size: 10px;

            font-weight: bold;

            padding: 2px 6px;

            border-radius: 5px;

            white-space: nowrap;

            flex-shrink: 0;

        }



        #chat-room-screen {

            background-size: cover;

            background-position: center;

        }



        #chat-room-screen .content {

            display: flex;

            flex-direction: column;

            padding: 1px;

            padding-bottom: 1px;

            transition: padding-bottom 0.3s ease;

        }

        

        /* --- Chat Action Panel Styles --- */

#chat-action-panel {

    background-color: #f7f7f7;

    height: 0;

    overflow: hidden;

    transition: height 0.3s ease-in-out;

    padding: 0 20px;

    border-top: 1px solid #eee;

}



#chat-action-panel.visible {

    height: 220px; /* 展开后的高度，你可以根据需要调整 */

    padding: 20px;

}



.action-panel-grid {

    display: grid;

    grid-template-columns: repeat(4, 1fr); /* 每行显示4个图标 */

    gap: 20px;

}



.action-item {

    display: flex;

    flex-direction: column;

    align-items: center;

    justify-content: flex-start;

    gap: 8px;

    cursor: pointer;

}



.action-item-btn {

    width: 60px;

    height: 60px;

    border-radius: 12px;

    background-color: #ffffff;

    border: 1px solid #e0e0e0;

    display: flex;

    align-items: center;

    justify-content: center;

    padding: 0;

    cursor: pointer;

    transition: background-color 0.2s;

}



.action-item-btn:hover {

    background-color: #f0f0f0;

}



.action-item-btn svg {

    width: 32px;

    height: 32px;

    fill: #555;

}



.action-label {

    font-size: 12px;

    color: #888;

}



/* --- Input Area Modification --- */

/* 给加号按钮一个独立的背景色，区别于发送按钮 */

#open-action-panel-btn {

    background-color: transparent;

    color: #555; /* 图标颜色 */

}

#open-action-panel-btn svg {

    fill: currentColor;

}





        #chat-room-screen.multi-select-active .content {

            padding-bottom: 70px;

        }



        .message-area {

            flex-grow: 1;

            overflow-y: auto;

            padding: 0 10px;

            scroll-behavior: smooth;

        }



        .message-wrapper {

            display: flex;

            margin-bottom: 12px;

            align-items: flex-start;

            transition: background-color 0.2s;

            flex-direction: column;

        }



        .message-wrapper.group-message {

            margin-bottom: 18px;

        }



        .message-wrapper.sent {

            align-items: flex-end;

        }



        .message-wrapper.received {

            align-items: flex-start;

        }



        .message-wrapper.system-notification {

            align-items: center;

        }



        .message-bubble-row {

            display: flex;

            width: 100%;

            align-items: flex-start;

        }



        .message-wrapper.sent .message-bubble-row {

            flex-direction: row-reverse;

        }



        .message-wrapper.multi-select-selected {

            background-color: rgba(144, 202, 249, 0.2);

            border-radius: var(--border-radius);

        }



        .message-info {

            display: flex;

            flex-direction: column;

            align-items: center;

            position: relative;

        }



        .group-nickname {

            position: absolute;

            top: -15px;

            font-size: 11px;

            color: #888;

            white-space: nowrap;

            width: 70px;

            text-align: center;

            overflow: hidden;

            text-overflow: ellipsis;

        }



        .message-avatar {

            width: 36px;

            height: 36px;

            border-radius: 50%;

            object-fit: cover;

        }



        .message-time {

            font-size: 9px;

            color: #aaa;

            margin-top: 3px;

        }



        .message-bubble {

            max-width: 260px;

            padding: 8px 12px;

            border-radius: var(--border-radius);

            word-wrap: break-word;

            line-height: 1.4;

            backdrop-filter: blur(5px);

            -webkit-backdrop-filter: blur(5px);

            margin: 0 8px;

            cursor: pointer;

            font-size: 15px;

        }



        .message-bubble.sent {

            border-bottom-right-radius: 5px;

        }



        .message-bubble.received {

            border-bottom-left-radius: 5px;

        }



        .system-notification-bubble {

            background-color: rgba(200, 200, 200, 0.5);

            color: #666;

            font-size: 12px;

            padding: 4px 10px;

            border-radius: 10px;

            text-align: center;

        }



        .image-bubble {

            max-width: 120px;

            border-radius: var(--border-radius);

            margin: 0 8px;

            padding: 4px;

            background-color: rgba(255, 255, 255, 0.5);

            backdrop-filter: blur(5px);

            -webkit-backdrop-filter: blur(5px);

            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

            cursor: pointer;

        }



        .image-bubble img {

            width: 100%;

            height: auto;

            display: block;

            border-radius: calc(var(--border-radius) - 4px);

        }



        .message-wrapper.sent .image-bubble {

            border-bottom-right-radius: 5px;

        }



        .message-wrapper.received .image-bubble {

            border-bottom-left-radius: 5px;

        }



        .voice-bubble {

            display: flex;

            align-items: center;

            justify-content: space-between;

            padding: 8px 12px;

            border-radius: var(--border-radius);

            backdrop-filter: blur(5px);

            -webkit-backdrop-filter: blur(5px);

            margin: 0 8px;

            cursor: pointer;

            transition: all 0.2s ease;

            min-width: 90px;

            max-width: 200px;

        }



        .message-wrapper.sent .voice-bubble {

            border-bottom-right-radius: 5px;

            flex-direction: row-reverse;

        }



        .message-wrapper.received .voice-bubble {

            border-bottom-left-radius: 5px;

        }



        .voice-bubble .play-icon {

            width: 18px;

            height: 18px;

            flex-shrink: 0;

        }



        .voice-bubble .duration {

            font-size: 13px;

            margin: 0 8px;

            white-space: nowrap;

        }



        .message-wrapper.sent .play-icon {

            transform: scaleX(-1);

        }



        .voice-transcript {

            font-size: 14px;

            color: #555;

            background-color: rgba(255, 255, 255, 0.7);

            padding: 8px 12px;

            margin-top: 5px;

            margin-left: 54px;

            margin-right: 54px;

            border-radius: 10px;

            line-height: 1.6;

            max-width: calc(100% - 108px);

            display: none;

            animation: fadeIn 0.3s ease;

        }



        .voice-transcript.active {

            display: block;

        }



        .message-wrapper.sent .voice-transcript {

            align-self: flex-end;

            margin-right: 54px;

            margin-left: auto;

        }



        .message-wrapper.received .voice-transcript {

            align-self: flex-start;

            margin-left: 54px;

            margin-right: auto;

        }



        .pv-card {

            width: 230px;

            aspect-ratio: 1 / 1;

            background-color: #f0f0f0;

            border-radius: var(--border-radius);

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

            overflow: hidden;

            position: relative;

            cursor: pointer;

            margin: 0 8px;

        }



        .message-wrapper.sent .pv-card {

            border-bottom-right-radius: 5px;

        }



        .message-wrapper.received .pv-card {

            border-bottom-left-radius: 5px;

        }



        .pv-card-image-overlay {

            position: absolute;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background-size: cover;

            background-position: center;

            transition: opacity 0.5s ease-in-out;

            z-index: 2;

        }



        .pv-card-image-overlay.hidden {

            opacity: 0;

            pointer-events: none;

        }



        .pv-card-content {

            padding: 15px;

            height: 100%;

            overflow-y: auto;

            color: var(--text-color);

            line-height: 1.6;

            font-size: 15px;

            background-color: white;

            position: relative;

            z-index: 1;

        }



        .pv-card-footer {

            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);

            color: white;

            padding: 20px 10px 8px;

            font-size: 12px;

            display: flex;

            align-items: center;

            gap: 5px;

            position: absolute;

            bottom: 0;

            left: 0;

            width: 100%;

            z-index: 3;

            pointer-events: none;

            transition: opacity 0.5s ease-in-out;

        }



        .pv-card-footer.hidden {

            opacity: 0;

        }



        .pv-card-footer svg {

            width: 14px;

            height: 14px;

            fill: white;

            flex-shrink: 0;

        }



        .transfer-card {

            width: 240px;

            height: auto;

            border-radius: var(--border-radius);

            margin: 0 8px;

            overflow: hidden;

            position: relative;

            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);

            color: white;

        }



        .message-wrapper.sent .transfer-card {

            border-bottom-right-radius: 5px;

        }



        .message-wrapper.received .transfer-card {

            border-bottom-left-radius: 5px;

            cursor: pointer;

        }



        .transfer-card::before {

            content: '';

            position: absolute;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-size: cover;

            background-position: center;

            filter: blur(4px);

            transform: scale(1.1);

            z-index: 1;

        }



        .transfer-card.sent-transfer::before {

            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');

        }



        .transfer-card.received-transfer::before {

            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');

        }



        .transfer-card .overlay {

            position: absolute;

            top: 0;

            left: 0;

            right: 0;

            bottom: 0;

            background-color: rgba(0, 0, 0, 0.3);

            z-index: 2;

            transition: background-color 0.5s ease;

        }



        .transfer-card.received .overlay {

            background-color: rgba(255, 182, 193, 0.4);

        }



        .transfer-card.returned .overlay {

            background-color: rgba(100, 100, 100, 0.5);

        }



        .transfer-content {

            position: relative;

            z-index: 3;

            padding: 20px;

            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);

        }



        .transfer-title {

            font-size: 14px;

            margin: 0 0 5px 0;

            opacity: 0.9;

        }



        .transfer-amount {

            font-size: 28px;

            font-weight: bold;

            margin: 0;

        }



        .transfer-remark {

            font-size: 14px;

            margin-top: 10px;

            opacity: 0.9;

            white-space: nowrap;

            overflow: hidden;

            text-overflow: ellipsis;

        }



        .transfer-status {

            font-size: 12px;

            margin-top: 15px;

            padding-top: 10px;

            border-top: 1px solid rgba(255, 255, 255, 0.3);

            opacity: 0.8;

        }



        .gift-card {

            width: 230px;

            background-color: #fff;

            border: 2px solid #333;

            border-radius: var(--border-radius);

            box-shadow: 4px 4px 0px #ddd;

            padding: 10px;

            display: flex;

            align-items: center;

            cursor: pointer;

            margin: 0 8px;

            position: relative;

            overflow: hidden;

        }



        .message-wrapper.sent .gift-card {

            border-bottom-right-radius: 5px;

        }



        .message-wrapper.received .gift-card {

            border-bottom-left-radius: 5px;

        }



        .gift-card-icon {

            width: 50px;

            height: 50px;

            margin-right: 15px;

            flex-shrink: 0;

        }



        .gift-card-text {

            font-size: 16px;

            font-weight: bold;

            color: #333;

            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;

        }



        .gift-card-description {

            font-size: 14px;

            color: #555;

            background-color: rgba(240, 240, 240, 0.9);

            padding: 8px 12px;

            margin-top: 5px;

            margin-left: 54px;

            margin-right: 54px;

            border-radius: 10px;

            line-height: 1.6;

            max-width: calc(100% - 108px);

            display: none;

            animation: fadeIn 0.3s ease;

        }



        .gift-card-description.active {

            display: block;

        }



        .message-wrapper.sent .gift-card-description {

            align-self: flex-end;

            margin-right: 54px;

            margin-left: auto;

        }



        .message-wrapper.received .gift-card-description {

            align-self: flex-start;

            margin-left: 54px;

            margin-right: auto;

        }



        .gift-card-received-stamp {

            position: absolute;

            top: 5px;

            right: 5px;

            font-size: 14px;

            font-weight: bold;

            color: var(--primary-color);

            border: 2px solid var(--primary-color);

            border-radius: 8px;

            padding: 2px 6px;

            transform: rotate(15deg);

            opacity: 0;

            transition: opacity 0.3s ease;

            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;

        }



        .gift-card.received .gift-card-received-stamp {

            opacity: 1;

        }



        .load-more-btn {

            background-color: #e0e0e0;

            color: #757575;

            border: none;

            padding: 8px 16px;

            margin: 10px auto;

            border-radius: 15px;

            cursor: pointer;

            display: block;

            font-size: 13px;

            font-weight: 500;

        }



        .load-more-btn:hover {

            background-color: #d1d1d1;

        }



        .typing-indicator {

            text-align: center;

            color: #aaa;

            font-style: italic;

            font-size: 14px;

            padding: 10px 0;

            display: none;

        }



        #sticker-bar {

            flex-shrink: 0;

            padding: 0 10px 5px;

            display: flex;

            align-items: center;

            background: rgba(255, 255, 255, 0.7);

            backdrop-filter: blur(10px);

        }



        .sticker-bar-btn {

            background: none;

            border: none;

            padding: 5px;

            cursor: pointer;

        }



        .sticker-bar-btn svg {

            width: 28px;

            height: 28px;

            fill: #888;

        }



        #sticker-modal {

            position: absolute;

            bottom: 0;

            left: 0;

            right: 0;

            height: 35%;

            max-height: 250px;

            background: #f7f7f7;

            border-top-left-radius: 20px;

            border-top-right-radius: 20px;

            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);

            z-index: 25;

            display: none;

            flex-direction: column;

        }



        #sticker-modal.visible {

            display: flex;

            animation: slideUp 0.3s ease-out;

        }



        #sticker-modal .header {

            padding: 10px 15px;

            font-weight: bold;

            color: var(--text-color);

            border-bottom: 1px solid #eee;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .sticker-grid {

            flex-grow: 1;

            overflow-y: auto;

            padding: 15px;

            display: grid;

            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));

            gap: 15px;

        }



        .sticker-item {

            position: relative;

            display: flex;

            flex-direction: column;

            align-items: center;

            cursor: pointer;

        }



        .sticker-item img {

            width: 60px;

            height: 60px;

            object-fit: contain;

        }



        .sticker-item span {

            font-size: 12px;

            color: #666;

            margin-top: 5px;

            text-align: center;

        }



        #add-sticker-modal .modal-window {

            max-width: 360px;

        }



        #sticker-preview {

            width: 100px;

            height: 100px;

            border: 2px dashed #ddd;

            border-radius: 10px;

            margin: 0 auto 15px;

            display: flex;

            align-items: center;

            justify-content: center;

            color: #5F7A9D;

            background-color: #f9f9f9;

        }



        #sticker-preview img {

            max-width: 100%;

            max-height: 100%;

        }



        .chat-input-wrapper {

            flex-shrink: 0;

        }



        .message-input-area {
    display: flex;
    align-items: center;
    padding: 5px 10px; 
    padding-bottom: calc(5px + env(safe-area-inset-bottom));
    border-top: 1px solid #eee;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
    gap: 6px;
    border-bottom-left-radius: var(--phone-corner-radius);
    border-bottom-right-radius: var(--phone-corner-radius);
    overflow: hidden;
}




        .message-input-area input {

            flex-grow: 1;

            border: none;

            padding: 12px;

            border-radius: 18px;

            background-color: #f0f0f0;

        }



        .message-input-area input:focus {

            outline: none;

        }



        .message-input-area .icon-btn {

            background: var(--primary-color);

            color: white;

            border: none;

            border-radius: 50%;

            width: 40px;

            height: 40px;

            cursor: pointer;

            flex-shrink: 0;

            display: flex;

            align-items: center;

            justify-content: center;

            transition: background-color 0.2s;

        }



        .message-input-area .icon-btn:disabled {

            background-color: #cccccc;

            cursor: not-allowed;

        }



        .message-input-area .icon-btn svg {

            width: 20px;

            height: 20px;

            fill: currentColor;

        }



        .message-input-area .icon-btn.send-btn {

            font-size: 18px;

        }



        #multi-select-bar {

            position: absolute;

            bottom: 0;

            left: 0;

            width: 100%;

            background: rgba(255, 255, 255, 0.9);

            backdrop-filter: blur(10px);

            display: none;

            justify-content: space-between;

            align-items: center;

            padding: 10px 20px;

            padding-bottom: calc(10px + env(safe-area-inset-bottom));

            border-top: 1px solid #eee;

            z-index: 20;

            border-bottom-left-radius: var(--phone-corner-radius);

            border-bottom-right-radius: var(--phone-corner-radius);

            animation: slideUp 0.3s ease-out;

        }



        #multi-select-bar.visible {

            display: flex;

        }



        .settings-sidebar {

            position: absolute;

            top: 0;

            right: -100%;

            width: 80%;

            height: 100%;

            background: #fff;

            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);

            transition: right 0.4s ease-in-out;

            z-index: 101;

            display: flex;

            flex-direction: column;

        }



        .settings-sidebar.open {

            right: 0;

        }



        .settings-sidebar .header {

            padding: 15px;

            border-bottom: 1px solid #eee;

            font-weight: bold;

            text-align: center;

            color: var(--primary-color);

        }



        .settings-sidebar .content {

            padding: 20px;

            overflow-y: auto;

            flex-grow: 1;

        }



        .settings-sidebar .form-group textarea {

            height: 100px;

            resize: vertical;

        }



        .settings-sidebar .avatar-setting {

            display: flex;

            align-items: center;

            gap: 15px;

            margin-bottom: 15px;

        }



        .settings-sidebar .avatar-preview {

            width: 60px;

            height: 60px;

            border-radius: 50%;

            object-fit: cover;

            border: 2px solid var(--primary-color);

            cursor: pointer;

        }



        .form-group {

            margin-bottom: 20px;

        }



        .form-group label {

            display: block;

            margin-bottom: 8px;

            color: var(--secondary-color);

            font-weight: 600;

        }



        .form-group input,

        .form-group select,

        .form-group textarea {

            width: 100%;

            padding: 12px;

            border: 1.5px solid #A8C4E5;

            border-radius: 10px;

            background-color: #fff;

            transition: border-color 0.3s;

            font-family: var(--font-family);

            font-size: 14px;

        }



        .form-group input:focus,

        .form-group select:focus,

        .form-group textarea:focus {

            outline: none;

            border-color: var(--primary-color);

        }



        .form-group.radio-group {

            display: flex;

            gap: 20px;

            align-items: center;

        }



        .form-group.radio-group label {

            margin-bottom: 0;

        }



        .btn {

            width: 100%;

            padding: 15px;

            border-radius: 10px;

            border: none;

            font-size: 16px;

            font-weight: bold;

            cursor: pointer;

            transition: all 0.3s ease;

            display: flex;

            align-items: center;

            justify-content: center;

            gap: 8px;

            text-align: center;

        }



        .btn-primary {

            background-color: var(--primary-color);

            color: var(--white-color);

        }



        .btn-primary:hover {

            background-color: var(--secondary-color);

            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);

        }



        label.btn-primary {

            color: var(--white-color) !important;

        }



        .btn-small {

            padding: 8px 16px;

            font-size: 14px;

            width: auto;

        }



        .btn-secondary {

            background-color: var(--accent-color);

            color: var(--white-color);

            margin-bottom: 15px;

        }



        .btn-secondary:hover {

            background-color: #64b5f6;

            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);

        }



        .btn-neutral {

            background-color: #bdbdbd;

            color: var(--white-color);

        }



        .btn-neutral:hover {

            background-color: #9e9e9e;

        }



        .btn-danger {

            background-color: #ef5350;

            color: white;

        }



        .btn .spinner {

            display: none;

            width: 16px;

            height: 16px;

            border: 2px solid rgba(255, 255, 255, 0.5);

            border-top-color: var(--white-color);

            border-radius: 50%;

            animation: spin 1s linear infinite;

        }



        .btn.loading .spinner {

            display: block;

        }



        .btn.loading .btn-text {

            display: none;

        }



        @keyframes spin {

            to {

                transform: rotate(360deg);

            }

        }



        .wallpaper-preview {

            width: 100%;

            aspect-ratio: 9 / 16;

            max-height: 400px;

            border-radius: var(--border-radius);

            margin-bottom: 25px;

            background-size: cover;

            background-position: center;

            border: 3px dashed var(--primary-color);

            display: flex;

            align-items: center;

            justify-content: center;

            color: var(--secondary-color);

            font-style: italic;

            background-color: #fff8fa;

        }



        .toast {

            position: absolute;

            bottom: 80px;

            left: 50%;

            transform: translateX(-50%);

            background-color: rgba(0, 0, 0, 0.7);

            color: white;

            padding: 10px 20px;

            border-radius: 15px;

            font-size: 14px;

            opacity: 0;

            visibility: hidden;

            transition: opacity 0.5s, visibility 0.5s;

            z-index: 1000;

        }



        .toast.show {

            opacity: 1;

            visibility: visible;

        }



        #world-book-selection-modal,

        #invite-member-modal,

        #group-recipient-selection-modal {

            z-index: 102;

        }



        #world-book-selection-modal .modal-window,

        #invite-member-modal .modal-window,

        #group-recipient-selection-modal .modal-window {

            width: 90%;

            max-width: 380px;

        }



        #world-book-selection-list,

        #invite-member-selection-list,

        #group-recipient-selection-list {

            list-style: none;

            padding: 0;

            margin: 0;

            max-height: 40vh;

            overflow-y: auto;

        }



        .world-book-select-item,

        .invite-member-select-item,

        .group-recipient-select-item {

            display: flex;

            align-items: center;

            padding: 12px 5px;

            border-bottom: 1px solid #f0f0f0;

        }



        .world-book-select-item:last-child,

        .invite-member-select-item:last-child,

        .group-recipient-select-item:last-child {

            border-bottom: none;

        }



        .world-book-select-item input[type="checkbox"],

        .invite-member-select-item input[type="checkbox"],

        .group-recipient-select-item input[type="checkbox"] {

            margin-right: 15px;

            width: 20px;

            height: 20px;

        }



        .world-book-select-item label,

        .invite-member-select-item label,

        .group-recipient-select-item label {

            font-weight: 500;

            color: var(--text-color);

            display: flex;

            align-items: center;

            gap: 10px;

            width: 100%;

        }



        .invite-member-select-item img,

        .group-recipient-select-item img {

            width: 40px;

            height: 40px;

            border-radius: 50%;

            object-fit: cover;

        }



        /* --- Group Chat Specific Styles --- */

        .member-selection-list {

            list-style: none;

            padding: 0;

            margin: 15px 0;

            max-height: 40vh;

            overflow-y: auto;

        }



        .member-selection-item {

            display: flex;

            align-items: center;

            padding: 10px 5px;

            border-bottom: 1px solid #f0f0f0;

        }



        .member-selection-item:last-child {

            border-bottom: none;

        }



        .member-selection-item input[type="checkbox"] {

            margin-right: 15px;

            width: 20px;

            height: 20px;

            flex-shrink: 0;

        }



        .member-selection-item img {

            width: 40px;

            height: 40px;

            border-radius: 50%;

            object-fit: cover;

            margin-right: 10px;

        }



        .member-selection-item label {

            font-weight: 500;

            color: var(--text-color);

        }



        #group-settings-sidebar .group-avatar-setting {

            display: flex;

            align-items: center;

            gap: 15px;

            margin-bottom: 15px;

        }



        #group-settings-sidebar .group-avatar-preview {

            width: 60px;

            height: 60px;

            border-radius: 10px;

            object-fit: cover;

            border: 2px solid var(--primary-color);

            cursor: pointer;

        }



        #group-settings-sidebar .group-members-list {

            display: grid;

            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));

            gap: 15px;

            margin-top: 10px;

        }



        #group-settings-sidebar .group-member,

        #group-settings-sidebar .add-member-btn {

            display: flex;

            flex-direction: column;

            align-items: center;

            cursor: pointer;

        }



        #group-settings-sidebar .group-member img {

            width: 50px;

            height: 50px;

            border-radius: 50%;

            object-fit: cover;

            margin-bottom: 5px;

            border: 2px solid #eee;

        }



        #group-settings-sidebar .add-member-btn .add-icon {

            width: 50px;

            height: 50px;

            border-radius: 50%;

            border: 2px dashed #ccc;

            display: flex;

            align-items: center;

            justify-content: center;

            font-size: 24px;

            color: #ccc;

            margin-bottom: 5px;

            transition: all 0.2s ease;

        }



        #group-settings-sidebar .add-member-btn:hover .add-icon {

            color: var(--primary-color);

            border-color: var(--primary-color);

        }



        #group-settings-sidebar .group-member span,

        #group-settings-sidebar .add-member-btn span {

            font-size: 12px;

            text-align: center;

            color: var(--text-color);

        }



        #customize-screen .icon-custom-item {

            display: flex;

            align-items: center;

            gap: 15px;

            margin-bottom: 15px;

            padding-bottom: 15px;

            border-bottom: 1px solid #f0f0f0;

        }



        #customize-screen .icon-custom-item:last-child {

            border-bottom: none;

        }



        #customize-screen .icon-preview {

            width: 50px;

            height: 50px;

            border-radius: 12px;

            object-fit: cover;

            flex-shrink: 0;

        }



        #customize-screen .icon-details {

            flex-grow: 1;

        }



        #customize-screen .icon-details p {

            margin: 0 0 8px 0;

            font-weight: 600;

        }



        #customize-screen .icon-details input {

            width: calc(100% - 70px);

        }



        #customize-screen .reset-icon-btn {

            background: #e0e0e0;

            color: #555;

            border: none;

            border-radius: 8px;

            padding: 8px 10px;

            font-size: 12px;

            cursor: pointer;

            margin-left: 10px;

        }



        /* --- Tutorial Screen Styles --- */

        .tutorial-item {

            margin-bottom: 15px;

            border: 1px solid #fce4ec;

            border-radius: 12px;

            overflow: hidden;

            background-color: #fff8fa;

        }



        .tutorial-header {

            padding: 12px 18px;

                font-weight: 600;

            color: var(--secondary-color);

            cursor: pointer;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .tutorial-header::after {

            content: '▼';

            font-size: 12px;

            transition: transform 0.3s ease;

        }



        .tutorial-item.open .tutorial-header::after {

            transform: rotate(180deg);

        }



        .tutorial-content {

            max-height: 0;

            overflow: hidden;

            transition: max-height 0.5s ease-in-out, padding 0.5s ease;

            padding: 0 10px;

        }



        .tutorial-item.open .tutorial-content {

            padding: 10px 10px;

            /* A large value to ensure it expands to fit the content */

            max-height: 5000px;

        }



        .tutorial-content img {

            width: 100%;

            height: auto;

            border-radius: 8px;

            display: block;

        }

   

          /* --- Input Area Icon Beautification (V2) --- */



/* 1. 恢复AI回复按钮的可见性 */

#get-reply-btn {

    display: inline-flex !important; /* 强制显示 */

    color: #8e8e93; /* 给一个清晰可见的灰色 */

}

#get-reply-btn:hover {

    color: #555; /* 鼠标悬停时加深 */

}



/* 2. 调整发送按钮样式 */

#send-message-btn {

    background-color: #8e8e93 !important;  /* 使用一个稳重的灰蓝色作为背景 */

    color: white !important; /* 图标设为白色 */

    width: 36px !important;   /* 稍微增大尺寸 */

    height: 36px !important;  /* 稍微增大尺寸 */

    font-size: 20px !important; /* 让箭头图标也更大一些 */

    transition: background-color 0.2s;

}



#send-message-btn:hover {

    background-color: #5a6268 !important; /* 鼠标悬停时颜色加深 */

}

   /* --- Status Modal Enhancements --- */

/* --- 心情履历 (可折叠样式) --- */
#status-modal .modal-window h3 {
    margin-bottom: 20px;
}
#status-modal .current-status-highlight {
    background-color: #fdfcff;
    border-color: var(--primary-color);
}

.status-history-section {
    margin-top: 20px;
}

/* ✨ 这是我们的小机关：可点击的标题 ✨ */
.history-header {
    margin: 0 0 10px 0;
    font-size: 13px;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid #f0f0f0;
    padding: 8px 5px;
    cursor: pointer; /* 鼠标放上去会变成小手 */
    display: flex; /* 让标题和箭头能并排 */
    justify-content: space-between;
    align-items: center;
    transition: color 0.2s; /* 点击时颜色变化更柔和 */
}
.history-header:hover {
    color: var(--primary-color); /* 鼠标悬停时变色 */
}

/* ✨ 这是我们的小箭头 ✨ */
.toggle-arrow {
    font-size: 10px;
    transition: transform 0.3s ease-in-out; /* 让箭头旋转有动画 */
}

/* ✨ 这是“门”本身（也就是列表）的样式 ✨ */
.history-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 0; /* ✨ 咒语核心1：默认高度为0，也就是关着的 */
    overflow: hidden; /* 把超出的内容藏起来 */
    transition: max-height 0.4s ease-in-out; /* ✨ 让展开和收起有平滑的动画效果 ✨ */
}

/* ✨ 这是当“门”被打开时的样式 ✨ */
.status-history-section.open .history-list {
    max-height: 15vh; /* ✨ 咒语核心2：当有了 .open 标记，就展开到指定高度 */
    overflow-y: auto; 
}
/* ✨ 门打开时，让箭头转上去 ✨ */
.status-history-section.open .toggle-arrow {
    transform: rotate(180deg);
}

/* 列表内部的样式，保持不变 */
.history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; font-size: 14px; border-bottom: 1px solid #f9f9f9; }
.history-item:last-child { border-bottom: none; }
.history-text { color: #555; }
.history-time { font-size: 12px; color: #aaa; flex-shrink: 0; margin-left: 15px; }


#status-modal .status-content {
    display: flex;
    flex-direction: column;
    gap: 15px; /* 在两个框之间增加间距 */
}

#status-modal .status-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 12px 15px;
}

#status-modal .status-item label {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: var(--secondary-color);
    margin-bottom: 8px;
    font-size: 14px;
}

/* 利用 ::before 伪元素添加符号，更灵活 */
#status-modal .status-item label[for="status-modal-text"]::before {
    content: '♢';
    margin-right: 9px;
    font-size: 17px;
}

#status-modal .status-item label[for="status-modal-thought"]::before {
    content: '💭';
    margin-right: 8px;
    font-size: 16px;
}

#status-modal .status-item p {
    margin: 0;
    font-size: 15px;
    color: #495057;
    line-height: 1.6;
}

/* --- 单独定制输入区按钮大小 --- */

/* 1. 给“加号”按钮(+)设置尺寸 */
#open-action-panel-btn {
    width: 53px;  /* 按钮宽度 */
    height: 53px; /* 按钮高度 */
}
/* ✨ 这就是新的魔法！告诉里面的“+”照片应该多大 ✨ */
#open-action-panel-btn svg {
    width: 53px;  /* “+”号的宽度，可以比按钮小一点 */
    height: 53px; /* “+”号的高度 */
}

/* 2. 给“语音”按钮设置尺寸 */
#voice-input-btn {
    width: 35px;  /* 按钮宽度 */
    height: 35px; /* 按钮高度 */
}
/* ✨ 同样，也让语音的图案大小合适 ✨ */
#voice-input-btn svg {
    width: 24px;  /* 语音图案的宽度 */
    height: 24px; /* 语音图案的高度 */
}

        /* --- 输入区按钮微调 --- */

/* 这是我们新创建的那个“小盒子”的样式 */
.input-prefix-buttons {
    display: flex; /* 让里面的两个按钮并排站好 */
    align-items: center;
    gap: 0px; /* ✨ 让它们之间的距离变得非常近，你可以改成2px或者0都可以！ */
}


/* ▼▼▼ 从这里开始是我们新增的CSS ▼▼▼ */

/* 1. 先把我们的手机主界面藏起来，等准备好了再显示 */
.phone-screen {
    display: none; /* 默认不显示 */
}

/* 2. 这是加载画面的样式 */
#loading-overlay {
    position: fixed; /* 固定在屏幕上，不随滚动条滚动 */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #F5F5F5; /* 用一个和主题色匹配的温柔背景 */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* 确保它在最顶层 */
    color: var(--primary-color);
    font-size: 16px;
}

/* 3. 这是那个转圈的小动画 */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: var(--white-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

#loading-overlay p {
    font-weight: 500;
}
/* ▲▲▲ 新增CSS到此结束 ▲▲▲ */

/* --- Music Feature Styles --- */
#music-screen .list-container {
    padding-top: 10px;
}
.music-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}
.music-item:hover {
    background-color: #fdf6f8;
}
.music-item.playing {
    background-color: var(--top-pinned-bg);
    font-weight: 600;
}
.music-item.playing .music-icon svg{
    fill: var(--primary-color);
}
.music-icon {
    margin-right: 15px;
}
.music-icon svg {
    width: 24px;
    height: 24px;
    fill: #aaa;
}
.music-name {
    flex-grow: 1;
    color: var(--text-color);
}

/* --- Music Feature Styles --- */
#music-screen .list-container {
    padding-top: 10px;
}
.music-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}
.music-item:hover {
    background-color: #fdf6f8;
}
.music-item.playing {
    background-color: var(--top-pinned-bg);
    font-weight: 600;
}
.music-item.playing .music-icon svg{
    fill: var(--primary-color);
}
.music-icon {
    margin-right: 15px;
}
.music-icon svg {
    width: 24px;
    height: 24px;
    fill: #aaa;
}

/* ▼▼▼ 这是我们大改造之后的核心样式 ▼▼▼ */

/* 1. 全新的播放器主体样式 */
#music-player-widget {
    position: absolute; /* 改为 absolute，随手机屏幕滚动 */
    top: 0;
    left: 0;
    width: 100%;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom: 1px solid #e0e0e0;
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);

    z-index: 500;
    display: flex; /* 使用flex布局 */
    align-items: center;
    padding: 12px 15px;

    transform: translateY(-100%); /* 默认藏在屏幕上方 */
    transition: transform 0.4s ease-in-out; /* 平滑的动画效果 */
}
#music-player-widget.is-open {
    transform: translateY(0); /* is-open 时滑下来 */
}
#music-player-widget.is-dragging {
    transition: none; /* 拖拽时不应用动画，防止卡顿 */
}


/* 2. 这是那个可爱的小把手 */
#music-player-handle {
    display: none;
    position: fixed;
    max-width: 420px;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%; 
    height: 22px;
    padding-top: 4px;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid #e0e0e0;
    border-top: none;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    z-index: 501;
    cursor: grab;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: top 0.4s ease-in-out, background-color 0.3s;
}
#music-player-handle::after {
    content: '';
    width: 35px;
    height: 4px;
    background-color: #d0d0d0;
    border-radius: 2px;
}



/* 3. 播放器内部结构微调 */
#player-track-info {
    display: flex;
    align-items: center;
    flex-grow: 1; /* 占据大部分空间 */
    min-width: 0; /* 防止文字过长撑爆布局 */
}
#player-album-art {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    margin-right: 12px;
    object-fit: cover;
    background-color: #eee;
    flex-shrink: 0;
}
#player-track-text {
    flex-grow: 1;
    min-width: 0;
}
#player-track-text p {
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
#player-track-name {
    font-size: 15px;
    font-weight: 500;
    color: #333;
}
#player-track-artist {
    font-size: 13px;
    color: #888;
}

/* 4. 控制器和“一起听”部分的新布局 */
#player-controls {
    display: flex;
    align-items: center;
    margin-left: 10px; /* 和左侧信息拉开距离 */
    flex-shrink: 0;
}
#player-controls button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
}
#player-controls svg {
    width: 28px;
    height: 28px;
    fill: #555;
}

/* ✨ 把“一起听”整合进播放器内部 */
#listen-together-control {
    margin-left: 15px;
    position: relative;
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

#listen-together-btn {
    background-color: #f0f0f0;
    border: none;
    border-radius: 18px; /* 更圆润 */
    padding: 8px 12px;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #555;
    font-weight: 500;
}
#listen-together-btn svg {
    width: 18px;
    height: 18px;
    fill: currentColor;
}
#listen-together-btn.active {
    background-color: var(--primary-color);
    color: white;
}
#listening-together-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #eaf1f8;
    padding: 6px 10px 6px 6px;
    border-radius: 18px;
}
.avatar-stack {
    display: flex;
    align-items: center;
}
.avatar-stack img {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    object-fit: cover;
}
.avatar-stack img:last-child {
    margin-left: -10px;
}
#listening-status-text {
    font-size: 12px;
    color: #555;
    font-weight: 500;
    max-width: 100px;
}

/* ✨ 这是我们新增的“内增高”垫子 ✨ */
.phone-screen.music-handle-active > .screen > .app-header {
    margin-top: 22px !important;
}
/* 给没有标准header的页面也加上边距 */
.phone-screen.music-handle-active > #home-screen {
     padding-top: 72px !important; /* 原来是50px，现在加上22px */
}


</style>


</head>

<body>

<!-- ▼▼▼ 这是我们新加的加载画面 ▼▼▼ -->
<div id="loading-overlay">
    <div class="spinner"></div>
    <p>章鱼喷墨机正在努力发射... 🐙</p>
</div>
<!-- ▲▲▲ 加载画面到此结束 ▲▲▲ -->


<div id="phone-screen" class="phone-screen">

    <div id="home-screen" class="screen active"></div>

    <div id="chat-list-screen" class="screen">

        <header class="app-header">

            <button class="back-btn" data-target="home-screen">‹</button>

            <div class="title-container">

                <h1 class="title">聊天</h1>

            </div>

            <div class="action-btn-group">

                <button class="action-btn" id="create-group-btn">群聊</button>

                <button class="action-btn" id="add-chat-btn">+</button>

            </div>

        </header>

        <main class="content">

            <ul class="list-container" id="chat-list-container"></ul>

            <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">

                <p>还没有聊天对象哦~</p>

                <p>点击右上角的“+”创建一个吧！</p>

            </div>

        </main>

    </div>

    <!-- Diary Screen -->
<div id="diary-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="chat-room-screen">‹</button>
        <div class="title-container">
            <h1 class="title" id="diary-screen-title">TA的日记</h1>
        </div>
        <div class="placeholder"></div>
    </header>
    <main class="content">
        <ul class="list-container" id="diary-list-container">
            <!-- 日记条目会在这里生成 -->
        </ul>
        <div class="placeholder-text" id="no-diary-placeholder" style="display: none;">
            <p>日记本还是空的呢...</p>
            <p>也许在聊天中，会有什么值得被悄悄记下吧。</p>
        </div>
    </main>
</div>

    <!-- Memo Screen -->
    <div id="memo-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">备忘录</h1>
            </div>
            <button class="action-btn" id="add-memo-btn">+</button>
        </header>
        <main class="content">
            <ul class="list-container" id="memo-list-container">
                <!-- 备忘录列表会在这里显示 -->
            </ul>
        </main>
    </div>

    <!-- Edit Memo Screen -->
       <div id="edit-memo-screen" class="screen">
        <header class="app-header">
            <button class="back-btn" data-target="memo-screen">‹</button>
            <div class="title-container">
                <h1 class="title" id="edit-memo-title">创建备忘录</h1>
            </div>
            <div class="placeholder"></div>
        </header>
        <main class="content settings-page-content">
            <form id="edit-memo-form">
                <input type="hidden" id="memo-edit-id"> <!-- 这是一个隐藏的小抽屉，用来记住我们正在编辑哪一条 -->

                <div class="settings-card">
                    <div class="form-group" style="padding-top: 15px;">
                        <label for="memo-content">事件内容</label>
                        <textarea id="memo-content" rows="4" placeholder="例如：给小猫买罐头" required></textarea>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-item">
                        <label for="memo-target-date">目标日期</label>
                        <input type="date" id="memo-target-date">
                    </div>
                    <div class="settings-item">
                        <label for="memo-linked-char">关联角色 (由谁提醒你)</label>
                        <select id="memo-linked-char">
                           <!-- 这里将来会自动填上所有角色的名字 -->
                        </select>
                    </div>
                </div>

                 <button type="submit" class="btn btn-primary" style="width:100%; margin:0;">保存备忘</button>
            </form>
        </main>
    </div>



    <div id="world-book-screen" class="screen">

        <header class="app-header">

            <button class="back-btn" data-target="home-screen">‹</button>

            <div class="title-container">

                <h1 class="title">世界书</h1>

            </div>

            <button class="action-btn" id="add-world-book-btn">+</button>

        </header>

        <main class="content">

            <ul class="list-container" id="world-book-list-container"></ul>

            <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">

                <p>你的世界一片混沌...</p>

                <p>点击右上角的“+”创造第一个设定吧！</p>

            </div>

        </main>

    </div>

    <div id="edit-world-book-screen" class="screen">
    <header class="app-header">
        <button class="back-btn" data-target="world-book-screen">‹</button>
        <div class="title-container"><h1 class="title" id="edit-world-book-title">创建/编辑条目</h1></div>
        <div class="placeholder"></div>
    </header>
    <main class="content settings-page-content">
        <form id="edit-world-book-form">
            <input type="hidden" id="world-book-id">

            <!-- 卡片1: 放置名称和内容输入框 -->
            <div class="settings-card">
                <div class="form-group" style="padding-top: 15px;">
                    <label for="world-book-name">条目名称</label>
                    <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                </div>
                <div class="form-group">
                    <label for="world-book-content">条目内容</label>
                    <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                </div>
            </div>

            <!-- 卡片2: 放置注入位置选项 -->
            <div class="settings-card">
                <div class="form-group" style="padding-top: 15px;">
                    <label style="padding-left:0;">注入位置</label>
                    <div class="form-group radio-group" style="padding-left:10px;">
                        <label><input type="radio" name="world-book-position" value="before" checked> 前置注入 (影响角色核心设定)</label>
                    </div>
                    <div class="form-group radio-group" style="padding-left:10px;">
                        <label><input type="radio" name="world-book-position" value="after"> 后置注入 (作为补充信息或技能)</label>
                    </div>
                </div>
            </div>

            <!-- 之前的保存按钮样式也微调一下，更好看 -->
            <button type="submit" class="btn btn-primary" style="width:100%; margin:0;">保存条目</button>
        </form>
    </main>
</div>


    <div id="api-settings-screen" class="screen"></div>

    <div id="wallpaper-screen" class="screen"></div>

    <div id="font-settings-screen" class="screen"></div>

    <div id="customize-screen" class="screen"></div>

    <div id="tutorial-screen" class="screen"></div>
    
    <div id="music-screen" class="screen"></div>


    <div id="toast-notification" class="toast"></div>


            <!-- Private Chat Settings -->

    <div id="chat-settings-sidebar" class="settings-sidebar">

        <div class="header">聊天设置</div>

        <div class="content">

            <form id="chat-settings-form">

                <div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview"

                                                 class="avatar-preview"><input type="file"

                                                                               id="setting-char-avatar-upload"

                                                                               accept="image/*"

                                                                               style="display:none;"><label

                        for="setting-char-avatar-upload" class="btn btn-primary"

                        style="flex-grow:1;">更换角色头像</label></div>

                <div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text"

                                                                                                       id="setting-char-remark">

                </div>

                <div class="form-group"><label for="setting-char-persona">角色人设</label><textarea

                        id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview"

                                                 class="avatar-preview"><input type="file" id="setting-my-avatar-upload"

                                                                               accept="image/*"

                                                                               style="display:none;"><label

                        for="setting-my-avatar-upload" class="btn btn-secondary"

                        style="flex-grow:1;">更换我的头像</label></div>

                <div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text"

                                                                                            id="setting-my-name"></div>

                <div class="form-group"><label for="setting-my-persona">我的人设</label><textarea

                        id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">

                    <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>

                </div>

                

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">

                        <label for="setting-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>

                        <input type="checkbox" id="setting-use-custom-css" style="width: auto;">

                    </div>

                    <div id="private-bubble-css-preview" class="bubble-css-preview"

                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">

                    </div>

                    <textarea id="setting-custom-bubble-css" rows="6"

                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"

                              disabled></textarea>

                    <button type="button" class="btn btn-neutral" id="reset-custom-bubble-css-btn"

                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认

                    </button>

                </div>



                <div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number"

                                                                                                   id="setting-max-memory"

                                                                                                   value="10" min="1">

                </div>

                <div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input

                        type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div>

                <button type="submit" class="btn btn-primary">保存设置</button>

            </form>

            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

            <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>

        </div>

    </div>

    

                    <!-- Group Chat Settings -->

    <div id="group-settings-sidebar" class="settings-sidebar">

        <div class="header">群聊设置</div>

        <div class="content">

            <form id="group-settings-form">

                <div class="group-avatar-setting">

                    <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">

                    <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">

                    <label for="setting-group-avatar-upload" class="btn btn-primary"

                           style="flex-grow:1;">更换群头像</label>

                </div>

                <div class="form-group">

                    <label for="setting-group-name">群名 (AI也可见)</label>

                    <input type="text" id="setting-group-name">

                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="avatar-setting">

                    <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">

                    <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">

                    <label for="setting-group-my-avatar-upload" class="btn btn-secondary"

                           style="flex-grow:1;">更换我的头像</label>

                </div>

                <div class="form-group">

                    <label for="setting-group-my-nickname">我的群昵称</label>

                    <input type="text" id="setting-group-my-nickname">

                </div>

                <div class="form-group">

                    <label for="setting-group-my-persona">我的人设</label>

                    <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>

                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">

                    <label>群成员</label>

                    <div class="group-members-list" id="group-members-list-container"></div>

                </div>

                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">

                    <button type="button" class="btn btn-secondary" id="link-group-world-book-btn">关联世界书</button>

                </div>

              


                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">

                        <label for="setting-group-use-custom-css" style="margin-bottom:0;">自定义气泡样式</label>

                        <input type="checkbox" id="setting-group-use-custom-css" style="width: auto;">

                    </div>

                    <div id="group-bubble-css-preview" class="bubble-css-preview"

                         style="background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">

                    </div>

                    <textarea id="setting-group-custom-bubble-css" rows="6"

                              placeholder="在此输入CSS代码...&#10;例如：&#10;.message-bubble.sent { background-color: #A5D6A7; }&#10;.message-bubble.received { background-color: #E1E1E1; }"

                              disabled></textarea>

                    <button type="button" class="btn btn-neutral" id="reset-group-custom-bubble-css-btn"

                            style="margin-top: 10px; width: auto; padding: 5px 15px; font-size: 14px;">恢复默认

                    </button>

                </div>



                <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number"

                                                                                                         id="setting-group-max-memory"

                                                                                                         value="10"

                                                                                                         min="1"></div>

                <div class="form-group"><label for="setting-group-chat-bg-upload"

                                               class="btn btn-primary">更换聊天背景</label><input type="file"

                                                                                                  id="setting-group-chat-bg-upload"

                                                                                                  accept="image/*"

                                                                                                  style="display:none;">

                </div>

                <button type="submit" class="btn btn-primary">保存设置</button>

            </form>

            <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">

            <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>

        </div>

    </div>

    

    <div id="chat-room-screen" class="screen">

<header class="app-header" id="chat-room-header-default">
    <button class="back-btn" data-target="chat-list-screen">‹</button>
    <div class="title-container">
        <h1 class="title" id="chat-room-title">...</h1>
        <div class="subtitle" id="chat-room-subtitle">
            <div class="online-indicator"></div>
            <span id="chat-room-status-text">在线</span>
        </div>
    </div>
    <!-- ▼▼▼ 为了让多个图标能并排显示，我们把它们放进一个容器里 ▼▼▼ -->
    <div class="action-btn-group">
        <!-- 这是你想要的深灰蓝色爱心图标 -->
        <button class="action-btn" id="show-status-btn">
            <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #495057;">
                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"></path>
            </svg>
        </button>
        <!-- 这是原来就有的三个点设置图标 -->
        <button class="action-btn" id="chat-settings-btn">
            <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #666;">
                <path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z"></path>
            </svg>
        </button>
    </div>
    <!-- ▲▲▲ 图标容器结束 ▲▲▲ -->
</header>


        <header class="app-header" id="chat-room-header-select" style="display: none;">

            <button class="action-btn" id="cancel-multi-select-btn">取消</button>

            <div class="title-container">

                <h1 class="title" id="multi-select-title">选择消息</h1>

            </div>

            <div class="placeholder"></div>

        </header>

        <main class="content">

            <div class="message-area" id="message-area"></div>

            <div class="typing-indicator" id="typing-indicator"></div>

        </main>

<div class="chat-input-wrapper">
        <!-- 状态弹窗 (升级为心情履历) -->
        <!-- 状态弹窗 (升级为可折叠的心情履历) -->
    <div id="status-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>心情履历</h3>
            <div class="status-content">
                <!-- 当前状态部分 -->
                <div class="status-item current-status-highlight">
                    <label for="status-modal-text">此刻状态</label>
                    <p id="status-modal-text">在线</p>
                </div>
                <div class="status-item current-status-highlight">
                    <label for="status-modal-thought">此刻独白</label>
                    <p id="status-modal-thought">...</p>
                </div>

                <!-- ▼▼▼ 这是改造后的“状态历史”陈列柜 ▼▼▼ -->
                <div class="status-history-section collapsible"> <!-- 1. 加了一个 'collapsible' 标记 -->
                    <h4 class="history-header"> <!-- 2. 给标题也加了个 'history-header' 标记 -->
                        状态历史
                        <span class="toggle-arrow">▼</span> <!-- 3. 加上了可爱的小箭头 -->
                    </h4>
                    <ul class="history-list" id="status-history-list">
                        <li class="placeholder-text">暂无历史状态记录</li>
                    </ul>
                </div>

                <!-- ▼▼▼ 这是改造后的“独白历史”陈列柜 ▼▼▼ -->
                <div class="status-history-section collapsible">
                    <h4 class="history-header">
                        独白历史
                        <span class="toggle-arrow">▼</span>
                    </h4>
                    <ul class="history-list" id="thought-history-list">
                        <li class="placeholder-text">暂无历史独白记录</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 默认输入栏 -->
    <div class="message-input-area" id="message-input-default">
        <div class="input-prefix-buttons">
            <button id="open-action-panel-btn" class="icon-btn">
                <svg viewBox="0 0 24 24"><path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path></svg>
            </button>
            <button id="voice-input-btn" class="icon-btn">
                <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"></path></svg>
            </button>
        </div>
        <input type="text" id="message-input" placeholder="输入消息...">
        <button id="send-message-btn" class="icon-btn send-btn">➤</button>
    </div>

    <!-- 编辑输入栏 -->
    <div class="message-input-area" id="message-edit-bar" style="display: none;">
        <input type="text" id="message-edit-input">
        <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
        <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
    </div>

    <!-- 功能按钮展开面板 -->
    <div id="chat-action-panel">
        <div class="action-panel-grid">
            <div class="action-item"><button class="action-item-btn" id="photo-video-btn"><svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"></path></svg></button><span class="action-label">影集</span></div>
            <div class="action-item"><button class="action-item-btn" id="image-recognition-btn"><svg viewBox="0 0 24 24"><path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z"></path></svg></button><span class="action-label">拍摄</span></div>
            <div class="action-item"><button class="action-item-btn" id="wallet-btn"><svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"></path></svg></button><span class="action-label">转账</span></div>
            <div class="action-item"><button class="action-item-btn" id="sticker-toggle-btn"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"></path></svg></button><span class="action-label">表情</span></div>
            <div class="action-item"><button class="action-item-btn" id="gift-btn"><svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"></path></svg></button><span class="action-label">礼物</span></div>
            <div class="action-item"><button class="action-item-btn" id="time-skip-btn"><svg viewBox="0 0 24 24"><path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg></button><span class="action-label">快进</span></div>
            <div class="action-item"><button class="action-item-btn" id="diary-btn"><svg viewBox="0 0 24 24"><path d="M14,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2M18,20H6V4H13V9H18V20M8,12H16V14H8V12M8,16H16V18H8V16Z"></path></svg></button><span class="action-label">日记</span></div>
            <div class="action-item"><button class="action-item-btn" id="ai-reply-action-btn"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z"></path></svg></button><span class="action-label">回复</span></div>
        </div>
    </div>
</div>

        <div id="multi-select-bar"><span id="select-count">已选择 0 项</span>

            <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选

            </button>

        </div>

        <div id="sticker-modal">

            <div class="header"><span>我的表情</span>

                <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>

            </div>

            <div class="sticker-grid" id="sticker-grid-container"></div>

        </div>

    </div>

    

    <div id="world-book-selection-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>选择要关联的世界书</h3>

            <ul id="world-book-selection-list"></ul>

            <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>

        </div>

    </div>

    

            <!-- ... 私聊设置 ... -->

            



    <!-- Group Member Edit Modal -->

    <div id="edit-group-member-modal" class="modal-overlay">

        <div class="modal-window">

            <h3 id="edit-group-member-title">编辑群成员</h3>

            <form id="edit-group-member-form">

                <input type="hidden" id="editing-member-id">

                <div class="avatar-setting" style="justify-content: center;">

                    <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview"

                         style="cursor: pointer;">

                    <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">

                </div>

                <div class="form-group">

                    <label for="edit-member-group-nickname">群昵称</label>

                    <input type="text" id="edit-member-group-nickname" required>

                </div>

                <div class="form-group">

                    <label for="edit-member-real-name">真名</label>

                    <input type="text" id="edit-member-real-name" required>

                </div>

                <div class="form-group">

                    <label for="edit-member-persona">人设</label>

                    <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>

                </div>

                <button type="submit" class="btn btn-primary">保存</button>

            </form>

        </div>

    </div>

    <!-- Add Member to Group Action Sheet -->

    <div id="add-member-actionsheet" class="action-sheet-overlay">

        <div class="action-sheet">

            <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>

            <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>

        </div>

    </div>

    <!-- Invite Existing Member Modal -->

    <div id="invite-member-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>邀请成员加入群聊</h3>

            <ul id="invite-member-selection-list"></ul>

            <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>

        </div>

    </div>

    <!-- Create New Member for Group Modal -->

    <div id="create-member-for-group-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>创建新角色并加入群聊</h3>

            <form id="create-member-for-group-form">

                <div class="avatar-setting" style="justify-content: center;">

                    <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像"

                         id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">

                    <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">

                </div>

                <div class="form-group">

                    <label for="create-group-member-nickname">群昵称</label>

                    <input type="text" id="create-group-member-nickname" required>

                </div>

                <div class="form-group">

                    <label for="create-group-member-realname">真名</label>

                    <input type="text" id="create-group-member-realname" required>

                </div>

                <div class="form-group">

                    <label for="create-group-member-persona">人设</label>

                    <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>

                </div>

                <button type="submit" class="btn btn-primary">创建并加入</button>

            </form>

        </div>

    </div>

</div>



        <!-- ... 群聊设置 ... -->

    

    <input type="file" id="image-upload-input" accept="image/*" style="display:none;">

    <div id="add-char-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>创建新角色</h3>

            <form id="add-char-form">

                <div class="form-group">

                    <label for="char-real-name">角色姓名</label><input type="text" id="char-real-name"

                                                                       placeholder="角色的真实姓名" required>

                </div>

                <div class="form-group">

                    <label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name"

                                                                                placeholder="你对Ta的称呼" required>

                </div>

                <div class="form-group">

                    <label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char"

                                                                         placeholder="你希望Ta如何称呼你" required>

                </div>

                <button type="submit" class="btn btn-primary">创建</button>

            </form>

        </div>

    </div>

    <div id="add-sticker-modal" class="modal-overlay">

        <div class="modal-window">

            <h3 id="add-sticker-modal-title">添加新表情</h3>

            <form id="add-sticker-form"><input type="hidden" id="sticker-edit-id">

                <div id="sticker-preview"><span>预览</span></div>

                <div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name"

                                                                                         placeholder="如：开心" required>

                </div>

                <div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url"

                                                                                             id="sticker-url-input"

                                                                                             placeholder="粘贴图片URL">

                </div>

                <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file"

                                                                                             id="sticker-file-upload"

                                                                                             accept="image/*"

                                                                                             style="display:none;"><label

                        for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>

                <button type="submit" class="btn btn-primary">保存</button>

            </form>

        </div>

    </div>

    <div id="sticker-actionsheet" class="action-sheet-overlay">

        <div class="action-sheet">

            <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>

            <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>

        </div>

    </div>

    <div id="send-voice-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>发送语音消息</h3>

            <form id="send-voice-form">

                <div class="form-group">

                    <label for="voice-text-input">输入语音文字</label>

                    <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>

                </div>

                <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">

                    预计时长: <span id="voice-duration-preview">0"</span>

                </div>

                <button type="submit" class="btn btn-primary">发送</button>

            </form>

        </div>

    </div>

    <div id="send-pv-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>分享照片/视频</h3>

            <form id="send-pv-form">

                <div class="form-group">

                    <label for="pv-text-input">输入描述</label>

                    <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required

                              rows="4"></textarea>

                </div>

                <button type="submit" class="btn btn-primary">发送</button>

            </form>

        </div>

    </div>

    <div id="send-transfer-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>转账</h3>

            <form id="send-transfer-form">

                <div class="form-group">

                    <label for="transfer-amount-input">金额 (元)</label>

                    <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">

                </div>

                <div class="form-group">

                    <label for="transfer-remark-input">备注</label>

                    <input type="text" id="transfer-remark-input" placeholder="（选填）">

                </div>

                <button type="submit" class="btn btn-primary">发送</button>

            </form>

        </div>

    </div>

    <div id="send-gift-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>送出礼物</h3>

            <form id="send-gift-form">

                <div class="form-group">

                    <label for="gift-description-input">礼物描述</label>

                    <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required

                              rows="4"></textarea>

                </div>

                <button type="submit" class="btn btn-primary">发送</button>

            </form>

        </div>

    </div>

    <!-- NEW: Time Skip Modal -->

    <div id="time-skip-modal" class="modal-overlay">

        <div class="modal-window">

            <h3>记录今天发生的事</h3>

            <form id="time-skip-form">

                <div class="form-group">

                    <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>

                    <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required

                              rows="4"></textarea>

                </div>

                <button type="submit" class="btn btn-primary">发送</button>

            </form>

        </div>

    </div>

    <!-- NEW: Group Recipient Selection Modal -->

    <div id="group-recipient-selection-modal" class="modal-overlay">

        <div class="modal-window">

            <h3 id="group-recipient-selection-title">选择收件人</h3>

            <ul id="group-recipient-selection-list"></ul>

            <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>

        </div>

    </div>

    <div id="receive-transfer-actionsheet" class="action-sheet-overlay">

        <div class="action-sheet">

            <button class="action-sheet-button" id="accept-transfer-btn">接收</button>

            <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>

        </div>

    </div>

<!-- Diary Edit Modal -->
<div id="edit-diary-modal" class="modal-overlay">
    <div class="modal-window">
        <h3>编辑日记</h3>
        <form id="edit-diary-form">
            <input type="hidden" id="editing-diary-id">
            <div class="form-group">
                <textarea id="diary-text-input" placeholder="记录下此刻的心情吧..." required rows="6" maxlength="150"></textarea>
                <div style="text-align: right; font-size: 12px; color: #888; margin-top: 5px;" id="diary-char-counter">0 / 150</div>
            </div>
            <button type="submit" class="btn btn-primary">保存修改</button>
        </form>
    </div>
</div>

    <div id="create-group-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>创建群聊</h3>
            <form id="create-group-form">
                <div class="form-group">
                    <label>选择群成员</label>
                    <ul id="member-selection-list" class="member-selection-list"></ul>
                </div>
                <div class="form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                </div>
                <button type="submit" class="btn btn-primary">创建群聊</button>
            </form>
        </div>
    </div>

  
    <!-- ▼▼▼ 这是我们的全局小部件和隐藏元素 ▼▼▼ -->
    <div id="listen-together-modal" class="modal-overlay">
        <div class="modal-window">
            <h3>选择一个角色一起听</h3>
            <ul id="listen-together-selection-list" class="member-selection-list" style="max-height: 50vh;">
              <!-- 角色列表会在这里动态生成 -->
            </ul>
        </div>
    </div>

    <div id="music-player-widget" >
        <div id="player-track-info">
            <img id="player-album-art" src="https://i.postimg.cc/htYvkdQK/chan-146.png" alt="art">
            <div id="player-track-text">
                <p id="player-track-name">未选择歌曲</p>
                <p id="player-track-artist">未知艺术家</p>
            </div>
        </div>
        <div id="player-controls">
            <button id="player-prev-btn">
                <svg viewBox="0 0 24 24"><path d="M6,18V6H8V18H6M9.5,12L18,6V18L9.5,12Z"></path></svg>
            </button>
            <button id="player-play-btn">
                <svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
            </button>
            <button id="player-next-btn">
                <svg viewBox="0 0 24 24"><path d="M16,18H18V6H16V18M14.5,12L6,18V6L14.5,12Z"></path></svg>
            </button>
        </div>
        <div id="listen-together-control">
             <button id="listen-together-btn">
                <svg viewBox="0 0 24 24"><path d="M12,2A4,4 0 0,0 8,6C8,7.91 9.5,9.45 11.38,9.91L5.5,15.5L7,17L12.88,11.12C13.5,12.14 14.62,12.83 15.91,12.94L13,15.83V22H15V17L17.91,14.1C19.19,15.22 21,15.16 22,14C23.04,12.81 22.97,11 21.8,10.03C21.03,9.26 20.04,9 19,9C18.5,9 18,9.13 17.56,9.38L12,3.81C12,3.81 12,3.81 12,3.81C11.12,4.83 10.14,5.53 9.09,6.06L11,8.04C11.5,7.92 12,7.5 12,7A2,2 0 0,1 14,9C14,9.5 13.69,9.89 13.23,9.97L11.77,8.5C11.9,8.23 12,7.88 12,7.5V7.45L9.06,4.5C9.6,4.18 10.2,4 10.83,4H10.88L15.38,8.5C15.56,8.22 15.81,8 16.1,7.84L14,5.76C14.88,4.88 15.84,4.24 16.91,4.06C14.75,2.76 12,2 12,2Z" /></svg>
                <span>一起听</span>
            </button>
            <div id="listening-together-display" style="display:none;">
                <div class="avatar-stack">
                    <img id="listener-avatar-1" src="">
                    <img id="listener-avatar-2" src="">
                </div>
                <span id="listening-status-text"></span>
            </div>
        </div>
    </div>

    <div id="music-player-handle"></div>

<input type="file" id="music-upload-input" accept=".mp3" style="display: none;">
<audio id="audio-player" style="display: none;"></audio>
 <!-- ▲▲▲ 全局小部件和隐藏元素结束 ▲▲▲ -->



<input type="file" id="import-data-input" accept=".ee" style="display: none;">

<script>

    const URLBlacklist = []
    
    let chatFeaturesInitialized = false;




    // gemini如果是多个密钥, 那么随机获取一个

    function getRandomValue(str) {

        // 检查字符串是否包含逗号

        if (str.includes(',')) {

            // 用逗号分隔字符串并移除多余空格

            const arr = str.split(',').map(item => item.trim());

            // 生成随机索引 (0 到 arr.length-1)

            const randomIndex = Math.floor(Math.random() * arr.length);

            // 返回随机元素

            return arr[randomIndex];

        }

        // 没有逗号则直接返回原字符串

        return str;

    }



    document.addEventListener('DOMContentLoaded', () => {

        async function compressImage(file, options = {}) {

            const {

                quality = 0.8, maxWidth = 800, maxHeight = 800

            } = options;



            // --- 新增：处理GIF动图 ---

            // 如果文件是GIF，则不经过canvas压缩，直接返回原始文件数据以保留动画

            if (file.type === 'image/gif') {

                return new Promise((resolve, reject) => {

                    const reader = new FileReader();

                    reader.readAsDataURL(file);

                    reader.onload = () => resolve(reader.result);

                    reader.onerror = error => reject(error);

                });

            }



            // --- 对其他静态图片（如PNG, JPG）进行压缩 ---

            return new Promise((resolve, reject) => {

                const reader = new FileReader();

                reader.readAsDataURL(file);

                reader.onerror = reject;

                reader.onload = (event) => {

                    const img = new Image();

                    img.src = event.target.result;

                    img.onerror = reject;

                    img.onload = () => {

                        let width = img.width;

                        let height = img.height;



                        if (width > height) {

                            if (width > maxWidth) {

                                height = Math.round(height * (maxWidth / width));

                                width = maxWidth;

                            }

                        } else {

                            if (height > maxHeight) {

                                width = Math.round(width * (maxHeight / height));

                                height = maxHeight;

                            }

                        }



                        const canvas = document.createElement('canvas');

                        canvas.width = width;

                        canvas.height = height;

                        const ctx = canvas.getContext('2d');

                        if (file.type === 'image/png') {

                            ctx.fillStyle = '#FFFFFF'; // 白色背景

                            ctx.fillRect(0, 0, width, height);

                        }



                        ctx.drawImage(img, 0, 0, width, height);

                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                        resolve(compressedDataUrl);

                    };

                };

            });

        }



        // --- Initial HTML Injection ---

                document.getElementById('api-settings-screen').innerHTML = `
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title">API 设置</h1></div>
                <div class="placeholder"></div>
            </header>
            <main class="content settings-page-content">
                <form id="api-form">
                    <div class="settings-card">
                        <div class="settings-item">
                            <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L12,14.5V7H13.5V13.3L17,14.9L16.2,16.2Z" /></svg>
                            <label for="api-provider">服务商</label>
                            <select id="api-provider" name="provider">
                                <option value="newapi">NewAPI (自定义)</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="claude">Claude</option>
                                <option value="gemini">Gemini</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <svg viewBox="0 0 24 24"><path d="M10.59,13.41C11,13.8 11,14.44 10.59,14.83C10.2,15.22 9.56,15.22 9.17,14.83C7.22,12.88 7.22,9.71 9.17,7.76V7.76L12.71,4.22C14.66,2.27 17.83,2.27 19.78,4.22C21.73,6.17 21.73,9.34 19.78,11.29L18.29,12.78C18.3,11.96 18.17,11.14 17.89,10.36L19.78,8.46C20.95,7.29 20.95,5.35 19.78,4.22C18.61,3.05 16.67,3.05 15.5,4.22L11.96,7.76C10.79,8.93 10.79,10.87 11.96,12.04L12.35,12.42L11.29,13.5L10.59,13.41Z" /></svg>
                            <label for="api-url">API 地址</label>
                            <input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required>
                        </div>
                        <div class="settings-item">
                           <svg viewBox="0 0 24 24"><path d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,6V4A2,2 0 0,0 18,2H6A2,2 0 0,0 4,4V6A2,2 0 0,1 6,8H18M18,11H6A4,4 0 0,0 2,15V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V15A4,4 0 0,0 18,11Z" /></svg>
                            <label for="api-key">密钥 (Key)</label>
                            <input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required>
                        </div>
                    </div>
                    <div class="settings-card">
                       <button type="button" class="btn btn-secondary" id="fetch-models-btn" style="margin: 15px; width: calc(100% - 30px);"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button>
                        <div class="settings-item">
                           <svg viewBox="0 0 24 24"><path d="M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18M12,3L1,9L12,15L21,10.09V17H23V9L12,3Z" /></svg>
                            <label for="api-model">选择模型</label>
                            <select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button>
                </form>
            </main>`;


        document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;

        document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;

        document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">主屏幕自定义</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;

        document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;
        
                        document.getElementById('music-screen').innerHTML = `<header class="app-header">
            <button class="back-btn" data-target="home-screen">‹</button>
            <div class="title-container">
                <h1 class="title">音乐</h1>
            </div>
            <label for="music-upload-input" class="action-btn" id="add-music-btn">+</label>
        </header>
        <main class="content">
            <ul class="list-container" id="music-list-container">
                <!-- 音乐列表会在这里生成 -->
            </ul>
             <div class="placeholder-text" id="no-music-placeholder" style="display: none;">
                <p>你的播放列表是空的...</p>
                <p>点击右上角的“+”导入你喜欢的MP3吧！</p>
            </div>
        </main>`;


        // --- Global Variables and Constants ---


const colorThemes = {
    'white_blue': { // 
        name: '默认主题', 
        received: {bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D'},
        sent: {bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A'}
    }
};


        const defaultIcons = {

            'chat-list-screen': {name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png'},

            'api-settings-screen': {name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png'},

            'wallpaper-screen': {name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png'},

            'world-book-screen': {name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png'},

            'customize-screen': {name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png'},

            'font-settings-screen': {name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png'},

            'tutorial-screen': {name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png'},

            'day-mode-btn': {name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png'},

            'night-mode-btn': {name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png'}

        };



        let db = {

            characters: [],

            groups: [],
            
            memos: [],
            
            musicTracks: [],

            apiSettings: {},

            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',

            myStickers: [],

            homeScreenMode: 'night',

            worldBooks: [],

            fontUrl: '',

            customIcons: {}

        };

        let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null,

            isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null,

            currentEditingWorldBookId = null, currentStickerActionTarget = null,

            currentGroupAction = {type: null, recipients: []};

        let selectedMessageIds = new Set();

        let chatFeaturesInitialized = false;

        const MESSAGES_PER_PAGE = 50;



        // --- DOM Element Cache ---

        const openActionPanelBtn = document.getElementById('open-action-panel-btn'),

      chatActionPanel = document.getElementById('chat-action-panel');

        const screens = document.querySelectorAll('.screen'),

            toastElement = document.getElementById('toast-notification'),

            homeScreen = document.getElementById('home-screen'),

            chatListContainer = document.getElementById('chat-list-container'),

            noChatsPlaceholder = document.getElementById('no-chats-placeholder'),

            addChatBtn = document.getElementById('add-chat-btn'),

            addCharModal = document.getElementById('add-char-modal'),

            addCharForm = document.getElementById('add-char-form'),

            chatRoomScreen = document.getElementById('chat-room-screen'),

            chatRoomHeaderDefault = document.getElementById('chat-room-header-default'),

            chatRoomHeaderSelect = document.getElementById('chat-room-header-select'),

            cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'),

            multiSelectTitle = document.getElementById('multi-select-title'),

            chatRoomTitle = document.getElementById('chat-room-title'),

            chatRoomStatusText = document.getElementById('chat-room-status-text'),

            messageArea = document.getElementById('message-area'),

            messageInputDefault = document.getElementById('message-input-default'),

            messageInput = document.getElementById('message-input'),

            sendMessageBtn = document.getElementById('send-message-btn'),

            getReplyBtn = document.getElementById('get-reply-btn'),

            typingIndicator = document.getElementById('typing-indicator'),

            chatSettingsBtn = document.getElementById('chat-settings-btn'),

            settingsSidebar = document.getElementById('chat-settings-sidebar'),

            settingsForm = document.getElementById('chat-settings-form'),

            messageEditBar = document.getElementById('message-edit-bar'),

            messageEditInput = document.getElementById('message-edit-input'),

            saveEditBtn = document.getElementById('save-edit-btn'),

            cancelEditBtn = document.getElementById('cancel-edit-btn'),

            multiSelectBar = document.getElementById('multi-select-bar'),

            selectCount = document.getElementById('select-count'),

            deleteSelectedBtn = document.getElementById('delete-selected-btn');

        const stickerToggleBtn = document.getElementById('sticker-toggle-btn'),

            stickerModal = document.getElementById('sticker-modal'),

            stickerGridContainer = document.getElementById('sticker-grid-container'),

            addNewStickerBtn = document.getElementById('add-new-sticker-btn'),

            addStickerModal = document.getElementById('add-sticker-modal'),

            addStickerModalTitle = document.getElementById('add-sticker-modal-title'),

            addStickerForm = document.getElementById('add-sticker-form'),

            stickerEditIdInput = document.getElementById('sticker-edit-id'),

            stickerPreview = document.getElementById('sticker-preview'),

            stickerNameInput = document.getElementById('sticker-name'),

            stickerUrlInput = document.getElementById('sticker-url-input'),

            stickerFileUpload = document.getElementById('sticker-file-upload');

        const stickerActionSheet = document.getElementById('sticker-actionsheet'),

            editStickerBtn = document.getElementById('edit-sticker-btn'),

            deleteStickerBtn = document.getElementById('delete-sticker-btn');

        const voiceMessageBtn = document.getElementById('voice-message-btn'),

            sendVoiceModal = document.getElementById('send-voice-modal'),

            sendVoiceForm = document.getElementById('send-voice-form'),

            voiceTextInput = document.getElementById('voice-text-input'),

            voiceDurationPreview = document.getElementById('voice-duration-preview');

        const photoVideoBtn = document.getElementById('photo-video-btn'),

            sendPvModal = document.getElementById('send-pv-modal'),

            sendPvForm = document.getElementById('send-pv-form'),

            pvTextInput = document.getElementById('pv-text-input');

        const imageRecognitionBtn = document.getElementById('image-recognition-btn'),

            imageUploadInput = document.getElementById('image-upload-input');

        const walletBtn = document.getElementById('wallet-btn'),

            sendTransferModal = document.getElementById('send-transfer-modal'),

            sendTransferForm = document.getElementById('send-transfer-form'),

            transferAmountInput = document.getElementById('transfer-amount-input'),

            transferRemarkInput = document.getElementById('transfer-remark-input');

        const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'),

            acceptTransferBtn = document.getElementById('accept-transfer-btn'),

            returnTransferBtn = document.getElementById('return-transfer-btn');

        const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'),

            sendGiftForm = document.getElementById('send-gift-form'),

            giftDescriptionInput = document.getElementById('gift-description-input');

        const timeSkipBtn = document.getElementById('time-skip-btn'),

            timeSkipModal = document.getElementById('time-skip-modal'),

            timeSkipForm = document.getElementById('time-skip-form'),

            timeSkipInput = document.getElementById('time-skip-input');

        const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');

        const worldBookListContainer = document.getElementById('world-book-list-container'),

            noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'),

            addWorldBookBtn = document.getElementById('add-world-book-btn'),

            editWorldBookScreen = document.getElementById('edit-world-book-screen'),

            editWorldBookForm = document.getElementById('edit-world-book-form'),

            worldBookIdInput = document.getElementById('world-book-id'),

            worldBookNameInput = document.getElementById('world-book-name'),

            worldBookContentInput = document.getElementById('world-book-content');

        const linkWorldBookBtn = document.getElementById('link-world-book-btn'),

            worldBookSelectionModal = document.getElementById('world-book-selection-modal'),

            worldBookSelectionList = document.getElementById('world-book-selection-list'),

            saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');

        const fontSettingsForm = document.getElementById('font-settings-form'),

            fontUrlInput = document.getElementById('font-url'),

            restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');

        const createGroupBtn = document.getElementById('create-group-btn'),

            createGroupModal = document.getElementById('create-group-modal'),

            createGroupForm = document.getElementById('create-group-form'),

            memberSelectionList = document.getElementById('member-selection-list'),

            groupNameInput = document.getElementById('group-name-input'),

            groupSettingsSidebar = document.getElementById('group-settings-sidebar'),

            groupSettingsForm = document.getElementById('group-settings-form'),

            groupMembersListContainer = document.getElementById('group-members-list-container'),

            editGroupMemberModal = document.getElementById('edit-group-member-modal'),

            editGroupMemberForm = document.getElementById('edit-group-member-form');

        const addMemberActionSheet = document.getElementById('add-member-actionsheet'),

            inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn'),

            createNewMemberBtn = document.getElementById('create-new-member-btn'),

            inviteMemberModal = document.getElementById('invite-member-modal'),

            inviteMemberSelectionList = document.getElementById('invite-member-selection-list'),

            confirmInviteBtn = document.getElementById('confirm-invite-btn'),

            createMemberForGroupModal = document.getElementById('create-member-for-group-modal'),

            createMemberForGroupForm = document.getElementById('create-member-for-group-form');

        const customizeForm = document.getElementById('customize-form'),

            tutorialContentArea = document.getElementById('tutorial-content-area');

        const groupRecipientSelectionModal = document.getElementById('group-recipient-selection-modal'),

            groupRecipientSelectionList = document.getElementById('group-recipient-selection-list'),

            confirmGroupRecipientBtn = document.getElementById('confirm-group-recipient-btn'),

            groupRecipientSelectionTitle = document.getElementById('group-recipient-selection-title');

        const linkGroupWorldBookBtn = document.getElementById('link-group-world-book-btn');



        // --- Utility and Core Functions ---

        class DataStorage {

            constructor() {

                // 创建数据库

                this.db = new Dexie('章鱼喷墨机DB');



                // 定义数据库结构

                this.db.version(1).stores({

                    storage: 'key, value, timestamp' // key作为主键，value存储数据，timestamp记录时间

                });

            }



            // 保存数据 - 类似 localStorage.setItem

            async saveData(key, data) {

                try {

                    const item = {

                        key: key,

                        value: JSON.stringify(data), // 将数据序列化

                        timestamp: Date.now()

                    };



                    await this.db.storage.put(item);

                    console.log(`数据已保存: ${key}`);

                    return true;

                } catch (error) {

                    console.error('保存数据失败:', error);

                    return false;

                }

            }



            // 获取数据 - 类似 localStorage.getItem

            async getData(key) {

                try {

                    const item = await this.db.storage.get(key);



                    if (item) {

                        return JSON.parse(item.value); // 反序列化数据

                    } else {

                        console.log(`未找到数据: ${key}`);

                        return null;

                    }

                } catch (error) {

                    console.error('获取数据失败:', error);

                    return null;

                }

            }



            // 删除数据

            async removeData(key) {

                try {

                    await this.db.storage.delete(key);

                    console.log(`数据已删除: ${key}`);

                    return true;

                } catch (error) {

                    console.error('删除数据失败:', error);

                    return false;

                }

            }



            // 清空所有数据

            async clearAll() {

                try {

                    await this.db.storage.clear();

                    console.log('所有数据已清空');

                    return true;

                } catch (error) {

                    console.error('清空数据失败:', error);

                    return false;

                }

            }



            // 获取所有键名

            async getAllKeys() {

                try {

                    const items = await this.db.storage.toArray();

                    return items.map(item => item.key);

                } catch (error) {

                    console.error('获取键名失败:', error);

                    return [];

                }

            }



            // 获取数据库大小信息

            async getStorageInfo() {

                try {

                    const items = await this.db.storage.toArray();

                    const totalSize = items.reduce((sum, item) => sum + item.value.length, 0);



                    return {

                        itemCount: items.length,

                        totalSize: totalSize,

                        items: items.map(item => ({

                            key: item.key,

                            size: item.value.length,

                            timestamp: new Date(item.timestamp).toLocaleString()

                        }))

                    };

                } catch (error) {

                    console.error('获取存储信息失败:', error);

                    return null;

                }

            }

        }



        const dataStorage = new DataStorage();


/**
 * ✨ 新增的小工具1：将日期对象格式化为 'YYYY-MM-DD HH:MM:SS' 字符串
 * @param {Date} date - 日期对象
 * @returns {string} 格式化后的时间字符串
 */
function formatTimestamp(date) {
    const Y = date.getFullYear();
    const M = String(date.getMonth() + 1).padStart(2, '0');
    const D = String(date.getDate()).padStart(2, '0');
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    const s = String(date.getSeconds()).padStart(2, '0');
    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
}

/**
 * ✨ 新增的小工具2：将毫秒差转换为人类可读的时间间隔
 * @param {number} ms - 毫秒差
 * @returns {string} 可读的时间间隔，如 "35分钟", "2小时", "3天"
 */
function formatTimeGap(ms) {
    if (ms < 60000) return `${Math.round(ms / 1000)}秒`; // 小于1分钟显示秒
    const minutes = Math.floor(ms / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}天`;
    if (hours > 0) return `${hours}小时${minutes % 60}分钟`;
    return `${minutes}分钟`;
}



        const saveData = async (data) => {

            await dataStorage.saveData('章鱼喷墨机', data ? data : db);

            return Promise.resolve();

        };

        const loadData = async () => {

            const oldData = localStorage.getItem('gemini-chat-app-db');

            let data = await dataStorage.getData('章鱼喷墨机')

            if (oldData) {

                await saveData(JSON.parse(oldData))

                data = await dataStorage.getData('章鱼喷墨机')

                localStorage.removeItem('gemini-chat-app-db');

            }

            if (data) db = data;

            if (!db.apiSettings) db.apiSettings = {};

            if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';

            if (!db.characters) db.characters = [];

            if (!db.groups) db.groups = [];

            if (!db.myStickers) db.myStickers = [];

            if (!db.homeScreenMode) db.homeScreenMode = 'night';

            if (!db.worldBooks) db.worldBooks = [];

            if (!db.fontUrl) db.fontUrl = '';

            if (!db.customIcons) db.customIcons = {};
            
            if (!db.memos) db.memos = [];
            if (!db.musicTracks) db.musicTracks = [];
            
            db.characters.forEach(c => {

                if (c.isPinned === undefined) c.isPinned = false;

                if (c.status === undefined) c.status = '在线';

                if (!c.worldBookIds) c.worldBookIds = [];

                if (c.customBubbleCss === undefined) c.customBubbleCss = '';

                if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
                        // ✨ 1. 检查并创建“内心独白”的家 ✨
        // 如果角色没有 displayStatus 这个对象，就创建一个。
        // 为了兼容，把旧的 status 值也带过来。
        if (!c.displayStatus) {
            c.displayStatus = {
                statusText: c.status || '在线',
                innerThought: '...' // 给一个默认的内心独白
            };
        }

        // ✨ 2. 检查并创建“日记本” ✨
        // 如果角色没有 diary 这个属性，就给TA一本空日记本（一个空数组）。
        if (!c.diary) {
            c.diary = [];
        }
// ✨✨✨ 新增的魔法在这里！ ✨✨✨
        // 1. 检查并创建“状态历史”小本子
        if (!c.statusHistory) {
            c.statusHistory = [];
        }
        // 2. 检查并创建“内心独白历史”小本子
        if (!c.thoughtHistory) {
            c.thoughtHistory = [];
        }
        // ✨✨✨ 魔法结束 ✨✨✨
            });

            db.groups.forEach(g => {

                if (g.isPinned === undefined) g.isPinned = false;

                if (!g.worldBookIds) g.worldBookIds = [];

                if (g.customBubbleCss === undefined) g.customBubbleCss = '';

                if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;

            });



            return Promise.resolve()

        };

        const showToast = (message) => {

            toastElement.textContent = message;

            toastElement.classList.add('show');

            setTimeout(() => toastElement.classList.remove('show'), 3000);

        };

        const switchScreen = (targetId) => {

            screens.forEach(screen => screen.classList.remove('active'));

            document.getElementById(targetId)?.classList.add('active');

            // Close all overlays and sidebars

            const overlays = document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-sidebar');

            overlays.forEach(o => o.classList.remove('visible', 'open'));

        };

        const pad = (num) => num.toString().padStart(2, '0');



        function createContextMenu(items, x, y) {

            removeContextMenu();

            const menu = document.createElement('div');

            menu.className = 'context-menu';

            menu.style.left = `${x}px`;

            menu.style.top = `${y}px`;

            items.forEach(item => {

                const menuItem = document.createElement('div');

                menuItem.className = 'context-menu-item';

                if (item.danger) menuItem.classList.add('danger');

                menuItem.textContent = item.label;

                menuItem.onclick = () => {

                    item.action();

                    removeContextMenu();

                };

                menu.appendChild(menuItem);

            });

            document.body.appendChild(menu);

            document.addEventListener('click', removeContextMenu, {once: true});

        }



        function removeContextMenu() {

            const menu = document.querySelector('.context-menu');

            if (menu) menu.remove();

        }



        function updateCustomBubbleStyle(chatId, css, enabled) {

            const styleId = `custom-bubble-style-for-${chatId}`;

            let styleElement = document.getElementById(styleId);



            if (enabled && css) {

                if (!styleElement) {

                    styleElement = document.createElement('style');

                    styleElement.id = styleId;

                    document.head.appendChild(styleElement);

                }

                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#chat-room-screen.chat-active-${chatId} $1`);

                styleElement.innerHTML = scopedCss;

            } else {

                if (styleElement) styleElement.remove();

            }

        }



        function updateBubbleCssPreview(previewContainer, css, useDefault, theme) {

            previewContainer.innerHTML = '';



            const sentBubble = document.createElement('div');

            sentBubble.className = 'message-bubble sent';

            sentBubble.textContent = '这是我方气泡。';

            sentBubble.style.alignSelf = 'flex-end';

            sentBubble.style.borderBottomRightRadius = '5px';



            const receivedBubble = document.createElement('div');

            receivedBubble.className = 'message-bubble received';

            receivedBubble.textContent = '这是对方气泡。';

            receivedBubble.style.alignSelf = 'flex-start';

            receivedBubble.style.borderBottomLeftRadius = '5px';



            [sentBubble, receivedBubble].forEach(bubble => {

                bubble.style.maxWidth = '70%';

                bubble.style.padding = '8px 12px';

                bubble.style.wordWrap = 'break-word';

                bubble.style.lineHeight = '1.4';

            });



            if (useDefault || !css) {

                sentBubble.style.backgroundColor = theme.sent.bg;

                sentBubble.style.color = theme.sent.text;

                sentBubble.style.borderRadius = '18px';

                sentBubble.style.borderBottomRightRadius = '5px';

                receivedBubble.style.backgroundColor = theme.received.bg;

                receivedBubble.style.color = theme.received.text;

                receivedBubble.style.borderRadius = '18px';

                receivedBubble.style.borderBottomLeftRadius = '5px';

            } else {

                const styleTag = document.createElement('style');

                const scopedCss = css.replace(/(\.message-bubble(?:\.sent|\.received)?)/g, `#${previewContainer.id} $1`);

                styleTag.textContent = scopedCss;

                previewContainer.appendChild(styleTag);

            }

            previewContainer.appendChild(receivedBubble);

            previewContainer.appendChild(sentBubble);

        }


// ▼▼▼ 这是我们的“聊天室专属工具箱” ▼▼▼
function setupChatRoomFeatures() {
     setupStickerSystem();
    setupVoiceMessageSystem();
    setupPhotoVideoSystem();
    setupImageRecognition();
    setupWalletSystem();
    setupGiftSystem();
    setupTimeSkipSystem();
    setupDiarySystem();
}


        const init = async () => {

            await loadData();

            document.body.addEventListener('click', (e) => {

                if (e.target.closest('.context-menu')) {

                    e.stopPropagation();

                    return;

                }

                removeContextMenu();



                const backBtn = e.target.closest('.back-btn');

                if (backBtn) {

                    e.preventDefault();

                    switchScreen(backBtn.getAttribute('data-target'));

                }




                // Consolidated overlay closing logic

                const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');

                if (openOverlay && e.target === openOverlay) {

                    openOverlay.classList.remove('visible');

                }

            });



            // Specific nav links that switch screens

            document.body.addEventListener('click', e => {

                const navLink = e.target.closest('.app-icon[data-target]');

                if (navLink) {

                    e.preventDefault();

                    switchScreen(navLink.getAttribute('data-target'));

                }

            });



            updateClock();

            setInterval(updateClock, 30000);

            applyGlobalFont(db.fontUrl);

            setupHomeScreen();

            setupChatListScreen();

            setupAddCharModal();

            setupChatRoom();

            setupChatSettings();

            setupApiSettingsApp();

            setupWallpaperApp();


            setupWorldBookApp();

            setupFontSettingsApp();

            setupGroupChatSystem();

            setupCustomizeApp();
            setupTutorialApp();
            setupMemoSystem();
            setupMemoCountdownWidget();
            setupMusicSystem();

            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('phone-screen').style.display = 'flex';

        };
        
        init();



        function updateClock() {

            const now = new Date();

            const timeDisplay = document.getElementById('time-display');

            const dateDisplay = document.getElementById('date-display');

            if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;

            if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;

        }

        function setupHomeScreen() {
                        const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
            const homeScreenHTML = `
            <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
            <!-- (这是在 homeScreenHTML 变量内部) -->

<div class="app-grid">
    <!-- ▼▼▼ 哥哥帮你把备忘录的样式彻底重写啦！▼▼▼ -->
    <a href="#" class="app-icon" data-target="memo-screen"
       style="grid-column: span 3; /* 让它占据一整行！ */
              background: linear-gradient(135deg, #f5f7fa, #e8eff7); /* 温柔的渐变背景 */
              flex-direction: column;
              justify-content: center;
              padding: 15px;
              border-radius: 20px;
              box-shadow: 0 6px 15px rgba(0, 0, 0, 0.06);
              gap: 8px; /* 增加文字之间的间距 */
              text-decoration: none;
              height: auto; /* 高度自动 */
              min-height: 90px;">
   
    <span id="memo-content-preview" style="font-size: 15px; color: #555; font-weight: 600;">暂无备忘</span>
    <span id="memo-countdown" style="font-size: 22px; color: var(--primary-color); font-weight: bold; font-family: 'Courier New', monospace;">--天--:--:--</span>
</a>

<a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
<a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Wallpaper" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
<a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>


</div>


            <div class="dock">
                <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="Tutorial" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="字体" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Customize" class="icon-img"></a>
            </div>`;

            homeScreen.innerHTML = homeScreenHTML;
            updateClock();
            applyWallpaper(db.wallpaper);
            applyHomeScreenMode(db.homeScreenMode);
            /*
            document.getElementById('day-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('day');
            });
            */
            document.getElementById('night-mode-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                applyHomeScreenMode('night');
            });
            document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
            document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
            document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
            document.querySelector('[data-target="memo-screen"]').addEventListener('click', renderMemoList);
        }




        function applyWallpaper(url) {

            homeScreen.style.backgroundImage = `url(${url})`;

        }



        async function applyHomeScreenMode(mode) {

            if (mode === 'day') {

                homeScreen.classList.add('day-mode');

            } else {

                homeScreen.classList.remove('day-mode');

            }

            db.homeScreenMode = mode;

            await saveData();

        }



        function setupCustomizeApp() {

            customizeForm.addEventListener('input', async (e) => {

                if (e.target.matches('input[type="url"]')) {

                    const iconId = e.target.dataset.id;

                    const newUrl = e.target.value.trim();

                    const previewImg = document.getElementById(`icon-preview-${iconId}`);

                    if (newUrl) {

                        db.customIcons[iconId] = newUrl;

                        previewImg.src = newUrl;

                        await saveData();

                        setupHomeScreen();

                    }

                }

            });

            customizeForm.addEventListener('click', async (e) => {

                if (e.target.matches('.reset-icon-btn')) {

                    const iconId = e.target.dataset.id;

                    delete db.customIcons[iconId];

                    await saveData();

                    renderCustomizeForm();

                    setupHomeScreen();

                    showToast('图标已重置');

                }

            });

        }



                function renderCustomizeForm() {
            const contentArea = customizeForm.closest('.content');
            if (contentArea) {
                contentArea.classList.add('settings-page-content');
            }
            customizeForm.innerHTML = ''; // 清空

            Object.entries(defaultIcons).forEach(([id, {name, url}]) => {
                const currentIcon = db.customIcons[id] || url;
                const itemHTML = `
                <div class="icon-customize-card">
                    <img src="${currentIcon}" alt="${name}" class="icon-customize-preview" id="icon-preview-${id}">
                    <div class="icon-customize-details">
                        <p class="icon-customize-name">${name || '模式切换图标'}</p>
                        <div class="icon-url-wrapper">
                             <input type="url" placeholder="粘贴新的图标URL" value="${db.customIcons[id] || ''}" data-id="${id}">
                             <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
                        </div>
                    </div>
                </div>`;
                customizeForm.insertAdjacentHTML('beforeend', itemHTML);
            });
        }




        function setupTutorialApp() {

            tutorialContentArea.addEventListener('click', (e) => {

                const header = e.target.closest('.tutorial-header');

                if (header) {

                    header.parentElement.classList.toggle('open');

                }

            });

        }

        let loadingBtn = false



        function renderTutorialContent() {

            const tutorials = [

                {title: '写在前面', imageUrls: ['https://i.postimg.cc/7PgyMG9S/image.jpg']},

                {

                    title: '软件介绍',

                    imageUrls: ['https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg', 'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg', 'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg']

                },

                {

                    title: '404',

                    imageUrls: ['https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg', 'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg', 'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg', 'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg']

                },

                {title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg']}

            ];

            tutorialContentArea.innerHTML = '';

            tutorials.forEach(tutorial => {

                const item = document.createElement('div');

                item.className = 'tutorial-item';

                const imagesHtml = tutorial.imageUrls.map(url => `<img src="${url}" alt="${tutorial.title}教程图片">`).join('');

                item.innerHTML = `<div class="tutorial-header">${tutorial.title}</div><div class="tutorial-content">${imagesHtml}</div>`;

                tutorialContentArea.appendChild(item);

            });



            const backupDataBtn = document.createElement('button');

            backupDataBtn.className = 'btn btn-primary';

            backupDataBtn.textContent = '备份数据';

            backupDataBtn.disabled = loadingBtn



            backupDataBtn.addEventListener('click', async () => {

                if(loadingBtn){

                    return

                }

                loadingBtn = true

                                try {
                    // 我们先创建一个干净的“箱子”，叫 backupObject
                    const backupObject = {
                        characters: db.characters || [],
                        groups: db.groups || [],
                        memos: db.memos || [],
                        apiSettings: db.apiSettings || {},
                        wallpaper: db.wallpaper || '',
                        myStickers: db.myStickers || [],
                        homeScreenMode: db.homeScreenMode || 'night',
                        worldBooks: db.worldBooks || [],
                        fontUrl: db.fontUrl || '',
                        customIcons: db.customIcons || {}
                    };

                    // 然后把这个装满东西的“箱子”打包
                    const jsonString = JSON.stringify(backupObject);
                    const dataBlob = new Blob([jsonString]);

                    // Compress the data using Gzip
                    const compressionStream = new CompressionStream('gzip');
                    const compressedStream = dataBlob.stream().pipeThrough(compressionStream);
                    const compressedBlob = await new Response(compressedStream).blob();

                    const url = URL.createObjectURL(compressedBlob);
                    const a = document.createElement('a');
                    const now = new Date();
                    const date = now.toISOString().slice(0, 10);
                    const time = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    a.href = url;
                    a.download = `章鱼喷墨_备份数据_${date}_${time}.ee`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    loadingBtn = false;
                    showToast('聊天记录导出成功');


                }catch (e){

                    showToast(`导出失败, 发生错误: ${e.message}`);

                }

            });

            const importDataBtn = document.createElement('label');

            importDataBtn.className = 'btn btn-neutral';

            importDataBtn.textContent = '导入数据';

            importDataBtn.style.marginTop = '15px'

            importDataBtn.style.display = 'block'

            importDataBtn.disabled = loadingBtn;

            importDataBtn.setAttribute('for', 'import-data-input')

            document.querySelector('#import-data-input').addEventListener('change', async (event) => {

                const file = event.target.files[0];

                if (!file) return;



                if(confirm('此操作将覆盖当前所有聊天记录和设置。此操作不可撤销。确定要继续吗？')){

                                        try {
                        // Decompress the file stream
                        const decompressionStream = new DecompressionStream('gzip');
                        const decompressedStream = file.stream().pipeThrough(decompressionStream);
                        const jsonString = await new Response(decompressedStream).text();

                        const importedData = JSON.parse(jsonString);

                        // 我们创建一个新的空“数据库”对象
                        const newDb = {
                            characters: [],
                            groups: [],
                            memos: [],
                            musicTracks: [],
                            apiSettings: {},
                            wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                            myStickers: [],
                            homeScreenMode: 'night',
                            worldBooks: [],
                            fontUrl: '',
                            customIcons: {}
                        };

                        // 然后小心地把导入的数据放进去，这样即使导入的文件缺了点什么，我们的程序也不会出错
                        Object.assign(newDb, importedData);

                        await saveData(newDb); // 保存这个全新的、完整的数据库
                        showToast(`数据已成功恢复。应用即将刷新。`);
                        window.location.reload();


                    } catch (error) {

                        console.error("导入失败:", error);

                        showToast(`解压或解析文件时发生错误: ${error.message}`);

                    } finally {

                        event.target.value = null;

                    }

                }else {

                    event.target.value = null;

                }



            })



            tutorialContentArea.appendChild(backupDataBtn);

            tutorialContentArea.appendChild(importDataBtn);

        }



        // --- Chat List & Chat Room ---

        function setupChatListScreen() {

            renderChatList();

            addChatBtn.addEventListener('click', () => {

                addCharModal.classList.add('visible');

                addCharForm.reset();

            });

            chatListContainer.addEventListener('click', (e) => {

                const chatItem = e.target.closest('.chat-item');

                if (chatItem) {

                    currentChatId = chatItem.dataset.id;

                    currentChatType = chatItem.dataset.type;

                    openChatRoom(currentChatId, currentChatType);

                }

            });

            chatListContainer.addEventListener('contextmenu', (e) => {

                e.preventDefault();

                const chatItem = e.target.closest('.chat-item');

                if (!chatItem) return;

                handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);

            });

            chatListContainer.addEventListener('touchstart', (e) => {

                const chatItem = e.target.closest('.chat-item');

                if (!chatItem) return;

                longPressTimer = setTimeout(() => {

                    const touch = e.touches[0];

                    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY);

                }, 400);

            });

            chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));

            chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));

        }



        function handleChatListLongPress(chatId, chatType, x, y) {

            clearTimeout(longPressTimer);

            const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);

            if (!chatItem) return;

            const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;

            const menuItems = [{

                label: chatItem.isPinned ? '取消置顶' : '置顶聊天',

                action: async () => {

                    chatItem.isPinned = !chatItem.isPinned;

                    await saveData();

                    renderChatList();

                }

            }, {

                label: '删除聊天',

                danger: true,

                action: async () => {

                    if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) {

                        if (chatType === 'private') {

                            db.characters = db.characters.filter(c => c.id !== chatId);

                        } else {

                            db.groups = db.groups.filter(g => g.id !== chatId);

                        }

                        await saveData();

                        renderChatList();

                        showToast('聊天已删除');

                    }

                }

            }];

            createContextMenu(menuItems, x, y);

        }



        function renderChatList() {

            chatListContainer.innerHTML = '';

            const allChats = [...db.characters.map(c => ({...c, type: 'private'})), ...db.groups.map(g => ({

                ...g,

                type: 'group'

            }))];

            noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';

            const sortedChats = allChats.sort((a, b) => {

                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;

                const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;

                const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;

                return lastMsgTimeB - lastMsgTimeA;

            });

            sortedChats.forEach(chat => {

                let lastMessageText = '开始聊天吧...';

                if (chat.history && chat.history.length > 0) {

                    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;

                    const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));

                    if (visibleHistory.length > 0) {

                        const lastMsg = visibleHistory[visibleHistory.length - 1];

                        const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;

                        const imageRecogRegex = /\[.*?发来了一张图片：\]/

                        const voiceRegex = /\[.*?的语音：.*?\]/;

                        const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;

                        const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;

                        const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;

                        const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;







                        if (giftRegex.test(lastMsg.content)) {

                            lastMessageText = '[礼物]';

                        } else if (stickerRegex.test(lastMsg.content)) {

                            lastMessageText = '[表情包]';

                        } else if (voiceRegex.test(lastMsg.content)) {

                            lastMessageText = '[语音]';

                        } else if (photoVideoRegex.test(lastMsg.content)) {

                            lastMessageText = '[照片/视频]';

                        } else if (transferRegex.test(lastMsg.content)) {

                            lastMessageText = '[转账]';

                        } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {

                            lastMessageText = '[图片]';

                        }else if ((lastMsg.parts && lastMsg.parts.some(p => p.type === 'html'))) {

                            lastMessageText = '[互动]';

                        } else {

                            const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);

                            let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();

text = text.replace(/\[发送时间:.*?\]$/, '').trim(); // 擦掉时间戳
                            lastMessageText = urlRegex.test(text) ? '[图片]' : text;

                        }

                    } else {

                        const lastEverMsg = chat.history[chat.history.length - 1];

                        const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;

                        const renameRegex = /\[.*?修改群名为：.*?\]/;

                        const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;

                        const timeSkipMatch = lastEverMsg.content.match(timeSkipRegex);



                        if (timeSkipMatch) {

                            lastMessageText = timeSkipMatch[1];

                        } else if (inviteRegex.test(lastEverMsg.content)) {

                            lastMessageText = '新成员加入了群聊';

                        } else if (renameRegex.test(lastEverMsg.content)) {

                            lastMessageText = '群聊名称已修改';

                        }

                    }

                }

                const li = document.createElement('li');

                li.className = 'list-item chat-item';

                if (chat.isPinned) li.classList.add('pinned');

                li.dataset.id = chat.id;

                li.dataset.type = chat.type;

                const avatarClass = chat.type === 'group' ? 'group-avatar' : '';

                const itemName = chat.type === 'private' ? chat.remarkName : chat.name;

                const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';

                li.innerHTML = `

                <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">

                <div class="item-details">

                    <div class="item-details-row"><div class="item-name">${itemName}</div></div>

                    <div class="item-preview-wrapper"><div class="item-preview">${lastMessageText}</div>${pinBadgeHTML}</div>

                </div>`;

                chatListContainer.appendChild(li);

            });

        }



        function setupAddCharModal() {
    addCharForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newChar = {
            id: `char_${Date.now()}`,
            realName: document.getElementById('char-real-name').value,
            remarkName: document.getElementById('char-remark-name').value,
            persona: '',
            avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
            myName: document.getElementById('my-name-for-char').value,
            myPersona: '',
            myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
            theme: 'white_blue',
            maxMemory: 10,
            chatBg: '',
            history: [],
            isPinned: false,
            status: '在线', // 旧的状态，保留
            // ▼▼▼ 这是新增的关键部分 ▼▼▼
            displayStatus: {
                statusText: '在线',
                innerThought: '开始一段新的对话吧...'
            },
            // ▲▲▲ 新增结束 ▲▲▲
            worldBookIds: [],
            useCustomBubbleCss: false,
            diary: [],
            customBubbleCss: ''
        };
        db.characters.push(newChar);
        await saveData();
        renderChatList();
        addCharModal.classList.remove('visible');
        showToast(`角色“${newChar.remarkName}”创建成功！`);
    });
}




        function setupChatRoom() {
        // --- START: Status Modal Logic ---
const showStatusBtn = document.getElementById('show-status-btn');
const statusModal = document.getElementById('status-modal');
const statusModalText = document.getElementById('status-modal-text');
const statusModalThought = document.getElementById('status-modal-thought');

// ▼▼▼ 这是我们的“金牌策展人”——新版 showStatusModal 函数 ▼▼▼
const showStatusModal = () => {
    if (currentChatType !== 'private') return;
    const character = db.characters.find(c => c.id === currentChatId);
    if (!character) return;

    // --- Part 1: 布置“当前状态”展区 (和以前一样) ---
    const statusModalText = document.getElementById('status-modal-text');
    const statusModalThought = document.getElementById('status-modal-thought');

    if (!character.displayStatus) {
        character.displayStatus = { statusText: character.status || '在线', innerThought: '...' };
    }
    statusModalText.textContent = character.displayStatus.statusText;
    statusModalThought.textContent = character.displayStatus.innerThought;


    // --- Part 2: ✨ 策展人开始布置“状态历史”展柜 ✨ ---
    const statusHistoryList = document.getElementById('status-history-list');
    statusHistoryList.innerHTML = ''; // 1. 先把旧的展品清走

    if (character.statusHistory && character.statusHistory.length > 0) {
        // 2. 从角色的记忆里，把状态历史倒序取出来（最新的在最前）
        [...character.statusHistory].reverse().forEach(entry => {
            const item = document.createElement('li');
            item.className = 'history-item'; // 使用我们定义好的展品样式
            // 3. 计算距离现在过了多久
            const timeGap = formatTimeGap(Date.now() - entry.timestamp);
            // 4. 把展品精心摆好放进展柜
            item.innerHTML = `
                <span class="history-text">${entry.text}</span>
                <span class="history-time">${timeGap}前</span>
            `;
            statusHistoryList.appendChild(item);
        });
    } else {
        // 如果没有历史，就放一个提示牌
        statusHistoryList.innerHTML = '<li class="placeholder-text" style="padding: 10px 5px;">暂无历史状态记录</li>';
    }


    // --- Part 3: ✨ 策展人接着布置“独白历史”展柜 ✨ ---
    const thoughtHistoryList = document.getElementById('thought-history-list');
    thoughtHistoryList.innerHTML = ''; // 1. 同样先清空

    if (character.thoughtHistory && character.thoughtHistory.length > 0) {
        // 2. 从记忆里，倒序取出独白历史
        [...character.thoughtHistory].reverse().forEach(entry => {
            const item = document.createElement('li');
            item.className = 'history-item';
            const timeGap = formatTimeGap(Date.now() - entry.timestamp);
            // 3. 把独白悄悄地放进展柜
            item.innerHTML = `
                <span class="history-text">${entry.text}</span>
                <span class="history-time">${timeGap}前</span>
            `;
            thoughtHistoryList.appendChild(item);
        });
    } else {
        thoughtHistoryList.innerHTML = '<li class="placeholder-text" style="padding: 10px 5px;">暂无历史独白记录</li>';
    }

    // --- Part 4: 所有展品布置完毕，打开“展馆”大门！ ---
    // ✨ 我们要确保每次打开时，折叠门都是关上的，这样才清爽
    document.querySelectorAll('.status-history-section.collapsible').forEach(section => {
        section.classList.remove('open');
    });

    statusModal.classList.add('visible');
};


if (showStatusBtn) {
    showStatusBtn.addEventListener('click', showStatusModal);
}

        if (statusModal) {
            statusModal.addEventListener('click', (e) => {
                // 点击遮罩层时关闭弹窗
                if (e.target === statusModal) {
                    statusModal.classList.remove('visible');
                }

                // ▼▼▼ 这是我们的新“遥控器”逻辑 ▼▼▼
                const header = e.target.closest('.history-header');
                if (header) {
                    // 找到被点击标题的那个“陈列柜”
                    const section = header.parentElement;
                    // 给它加上或去掉 'open' 标记，就像按一下遥控器开关
                    section.classList.toggle('open');
                }
            });
        }

// --- END: Status Modal Logic ---


        // ▼▼▼ 新增这里的代码 ▼▼▼

openActionPanelBtn.addEventListener('click', () => {

    chatActionPanel.classList.toggle('visible');

    // 如果功能面板是打开的，就收起表情面板

    if (chatActionPanel.classList.contains('visible')) {

        stickerModal.classList.remove('visible');

    }

});



// 优化体验：当用户点击消息区域时，收起功能面板

messageArea.addEventListener('click', (e) => {

    if (chatActionPanel.classList.contains('visible')) {

        chatActionPanel.classList.remove('visible');

    }

});

const aiReplyActionBtn = document.getElementById('ai-reply-action-btn');

            sendMessageBtn.addEventListener('click', sendMessage);

            sendMessageBtn.addEventListener('touchend', (e) => {

                e.preventDefault();

                sendMessage();

                setTimeout(() => {

                    messageInput.focus();

                }, 50);

            });

            messageInput.addEventListener('keypress', (e) => {

                if (e.key === 'Enter' && !isGenerating) sendMessage();

            });

            aiReplyActionBtn.addEventListener('click', getAiReply);

            messageArea.addEventListener('click', (e) => {


                if (stickerModal.classList.contains('visible')) {

                    stickerModal.classList.remove('visible');

                    return;

                }

                // --- 修复结束 ---



                if (e.target && e.target.id === 'load-more-btn') {

                    loadMoreMessages();

                } else if (isInMultiSelectMode) {

                    const messageWrapper = e.target.closest('.message-wrapper');

                    if (messageWrapper) {

                        toggleMessageSelection(messageWrapper.dataset.id);

                    }

                } else {

                    const voiceBubble = e.target.closest('.voice-bubble');

                    if (voiceBubble) {

                        const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');

                        if (transcript) {

                            transcript.classList.toggle('active');

                        }

                    }

                    const pvCard = e.target.closest('.pv-card');

                    if (pvCard) {

                        const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');

                        const footer = pvCard.querySelector('.pv-card-footer');

                        imageOverlay.classList.toggle('hidden');

                        footer.classList.toggle('hidden');

                    }

                    const giftCard = e.target.closest('.gift-card');

                    if (giftCard) {

                        const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');

                        if (description) {

                            description.classList.toggle('active');

                        }

                    }

                    const transferCard = e.target.closest('.transfer-card.received-transfer');

                    if (transferCard && currentChatType === 'private') {

                        const messageWrapper = transferCard.closest('.message-wrapper');

                        const messageId = messageWrapper.dataset.id;

                        const character = db.characters.find(c => c.id === currentChatId);

                        const message = character.history.find(m => m.id === messageId);

                        if (message && message.transferStatus === 'pending') {

                            handleReceivedTransferClick(messageId);

                        }

                    }

                }

            });

            messageArea.addEventListener('contextmenu', (e) => {

                e.preventDefault();

                if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;

                const messageWrapper = e.target.closest('.message-wrapper');

                if (!messageWrapper) return;

                handleMessageLongPress(messageWrapper, e.clientX, e.clientY);

            });

            messageArea.addEventListener('touchstart', (e) => {

                if (e.target.id === 'load-more-btn') return;

                const messageWrapper = e.target.closest('.message-wrapper');

                if (!messageWrapper) return;

                longPressTimer = setTimeout(() => {

                    const touch = e.touches[0];

                    handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY);

                }, 400);

            });

            messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));

            messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));

            saveEditBtn.addEventListener('click', saveMessageEdit);

            cancelEditBtn.addEventListener('click', cancelMessageEdit);

            cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);

            deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);

        }



        function handleMessageLongPress(messageWrapper, x, y) {

            if (isInMultiSelectMode) return;

            clearTimeout(longPressTimer);

            const messageId = messageWrapper.dataset.id;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const message = chat.history.find(m => m.id === messageId);

            if (!message) return;



            const isImageRecognitionMsg = message.parts && message.parts.some(p => p.type === 'image');

            const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);

            const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);

            const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);

            const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]|\[.*?向.*?转账：.*?\]/.test(message.content);

            const isGiftMessage = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/.test(message.content);

            const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/.test(message.content);



            let menuItems = [];

            if (!isImageRecognitionMsg && !isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {

                menuItems.push({label: '编辑', action: () => startMessageEdit(messageId)});

            }

            menuItems.push({label: '删除', action: () => enterMultiSelectMode(messageId)});



            if (menuItems.length > 0) {

                createContextMenu(menuItems, x, y);

            }

        }


// ✨ 这是我们带有“魔法橡皮擦”的新函数 ✨
function startMessageEdit(messageId) {
    exitMultiSelectMode();
    editingMessageId = messageId;
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const message = chat.history.find(m => m.id === messageId);
    if (!message) return;

    // ✨ 魔法橡皮擦来啦！✨
    // 先把原始消息内容里的 [diary:...] 指令擦得干干净净
    let cleanContent = message.content.replace(/\[diary:[\s\S]*?\]/g, '').trim();

    // 然后再从干净的内容里提取真正的聊天文字
    const match = cleanContent.match(/\[.*?的消息：([\s\S]+)\]/);
    const contentToEdit = match ? match[1].trim() : cleanContent; // 如果还是没匹配到，就用擦干净后的内容

    messageEditInput.value = contentToEdit;
    messageInputDefault.style.display = 'none';
    messageEditBar.style.display = 'flex';
    messageEditInput.focus();
}




        async function saveMessageEdit() {

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const messageIndex = chat.history.findIndex(m => m.id === editingMessageId);

            if (messageIndex === -1) return;

            const newText = messageEditInput.value.trim();

            if (newText) {

                const oldContent = chat.history[messageIndex].content;

                const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/);

                const prefix = prefixMatch ? prefixMatch[1] : '';

                const newContent = `${prefix}${newText}]`;

                chat.history[messageIndex].content = newContent;

                if (chat.history[messageIndex].parts) {

                    chat.history[messageIndex].parts = [{type: 'text', text: newContent}];

                }

                await saveData();

                currentPage = 1;

                renderMessages(false, true);

                renderChatList();

            }

            cancelMessageEdit();

        }



        function cancelMessageEdit() {

            editingMessageId = null;

            messageInputDefault.style.display = 'flex';

            messageEditBar.style.display = 'none';

        }



        function enterMultiSelectMode(initialMessageId) {

            isInMultiSelectMode = true;

            chatRoomHeaderDefault.style.display = 'none';

            chatRoomHeaderSelect.style.display = 'flex';

            document.querySelector('.chat-input-wrapper').style.display = 'none';

            multiSelectBar.classList.add('visible');

            chatRoomScreen.classList.add('multi-select-active');

            selectedMessageIds.clear();

            if (initialMessageId) {

                toggleMessageSelection(initialMessageId);

            }

        }



        function exitMultiSelectMode() {

            isInMultiSelectMode = false;

            chatRoomHeaderDefault.style.display = 'flex';

            chatRoomHeaderSelect.style.display = 'none';

            document.querySelector('.chat-input-wrapper').style.display = 'block';

            multiSelectBar.classList.remove('visible');

            chatRoomScreen.classList.remove('multi-select-active');

            selectedMessageIds.forEach(id => {

                const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`);

                if (el) el.classList.remove('multi-select-selected');

            });

            selectedMessageIds.clear();

        }



        function toggleMessageSelection(messageId) {

            const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`);

            if (!el) return;

            if (selectedMessageIds.has(messageId)) {

                selectedMessageIds.delete(messageId);

                el.classList.remove('multi-select-selected');

            } else {

                selectedMessageIds.add(messageId);

                el.classList.add('multi-select-selected');

            }

            selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`;

            deleteSelectedBtn.disabled = selectedMessageIds.size === 0;

        }



        async function deleteSelectedMessages() {

            if (selectedMessageIds.size === 0) return;

            const deletedCount = selectedMessageIds.size;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));

            await saveData();

            currentPage = 1;

            renderMessages(false, true);

            renderChatList();

            exitMultiSelectMode();

            showToast(`已删除 ${deletedCount} 条消息`);

        }



        function openChatRoom(chatId, type) {
            const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
            if (!chat) return;

            if (!chatFeaturesInitialized) {
                setupChatRoomFeatures();
                chatFeaturesInitialized = true;
            }

            exitMultiSelectMode();
            cancelMessageEdit();

            chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
            const subtitle = document.getElementById('chat-room-subtitle');

            if (type === 'private') {
                subtitle.style.display = 'flex';
                const character = chat;
                if (!character.displayStatus) {
                    character.displayStatus = {
                        statusText: character.status || '在线',
                        innerThought: '...'
                    };
                }
                chatRoomStatusText.textContent = character.displayStatus.statusText;
            } else {
                subtitle.style.display = 'none';
            }

            chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
            typingIndicator.style.display = 'none';
            isGenerating = false;
            currentPage = 1;

            chatRoomScreen.className = chatRoomScreen.className.replace(/\bchat-active-[^ ]+\b/g, '');
            chatRoomScreen.classList.add(`chat-active-${chatId}`);
            updateCustomBubbleStyle(chatId, chat.customBubbleCss, chat.useCustomBubbleCss);

            renderMessages(false, true);
            switchScreen('chat-room-screen');
        }





        function renderMessages(isLoadMore = false, forceScrollToBottom = false) {

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (!chat || !chat.history) return;

            const oldScrollHeight = messageArea.scrollHeight;

            const totalMessages = chat.history.length;

            const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;

            const start = Math.max(0, end - MESSAGES_PER_PAGE);

            const messagesToRender = chat.history.slice(start, end);

            if (!isLoadMore) messageArea.innerHTML = '';

            const fragment = document.createDocumentFragment();

            messagesToRender.forEach(msg => {

                const bubble = createMessageBubbleElement(msg);

                if (bubble) fragment.appendChild(bubble);

            });

            const existingLoadBtn = document.getElementById('load-more-btn');

            if (existingLoadBtn) existingLoadBtn.remove();

            messageArea.prepend(fragment);

            if (totalMessages > currentPage * MESSAGES_PER_PAGE) {

                const loadMoreButton = document.createElement('button');

                loadMoreButton.id = 'load-more-btn';

                loadMoreButton.className = 'load-more-btn';

                loadMoreButton.textContent = '加载更早的消息';

                messageArea.prepend(loadMoreButton);

            }

            if (forceScrollToBottom) {

                setTimeout(() => {

                    messageArea.scrollTop = messageArea.scrollHeight;

                }, 0);

            } else if (isLoadMore) {

                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;

            }

        }



        function loadMoreMessages() {

            currentPage++;

            renderMessages(true, false);

        }



        function calculateVoiceDuration(text) {

            return Math.max(1, Math.min(60, Math.ceil(text.length / 3.5)));

        }



        function createMessageBubbleElement(message) {

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

    const {role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId} = message;

    const diaryMatchForHiding = content.match(/\[diary:\s*([\s\S]+?)\]/);
    if (diaryMatchForHiding) {
        return null;
    }

    const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
    const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
    const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
    const timeSkipMatch = content.match(timeSkipRegex);
    const inviteMatch = content.match(inviteRegex);
    const renameMatch = content.match(renameRegex);
    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?内心独白为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]/;

    if (invisibleRegex.test(content)) {
        return null;
    }

    const wrapper = document.createElement('div');
    wrapper.dataset.id = id;

    if (timeSkipMatch || inviteMatch || renameMatch) {
        wrapper.className = 'message-wrapper system-notification';
        let bubbleText = '';
        if (timeSkipMatch) bubbleText = timeSkipMatch[1];
        if (inviteMatch) bubbleText = `${inviteMatch[1]}邀请${inviteMatch[2]}加入了群聊`;
        if (renameMatch) bubbleText = `${renameMatch[1]}修改群名为“${renameMatch[2]}”`;
        wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
        return wrapper;
    }

    const isSent = (role === 'user');
    let avatarUrl, bubbleTheme, senderNickname = '';
    const themeKey = chat.theme || 'white_blue';
    const theme = colorThemes[themeKey] || colorThemes['white_blue'];
    let messageSenderId = isSent ? 'user_me' : senderId;

    if (isSent) {
        avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
        bubbleTheme = theme.sent;
    } else {
        if (currentChatType === 'private') {
            avatarUrl = chat.avatar;
        } else { // Group chat received
            const sender = chat.members.find(m => m.id === senderId);
            if (sender) {
                avatarUrl = sender.avatar;
                senderNickname = sender.groupNickname;
            } else { // Fallback for unknown sender
                avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            }
        }
        bubbleTheme = theme.received;
    }
    const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    if (currentChatType === 'group' && !isSent) {
        wrapper.classList.add('group-message');
    }
    const bubbleRow = document.createElement('div');
    bubbleRow.className = 'message-bubble-row';
    let bubbleElement;

    // Regexes for all message types
    const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
    const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
    const receivedStickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/i;
    const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
    const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
    const privateSentTransferRegex = /\[.*?给你转账：([\d.]+)元；备注：(.*?)\]/;
    const privateReceivedTransferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
    const groupTransferRegex = /\[(.*?)\s*向\s*(.*?)\s*转账：([\d.]+)元；备注：(.*?)\]/;
    const privateGiftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
    const groupGiftRegex = /\[(.*?)\s*向\s*(.*?)\s*送来了礼物：([\s\S]+?)\]/;
    const imageRecogRegex = /\[.*?发来了一张图片：\]/;
    const textRegex = /\[(?:.+?)的消息：([\s\S]+?)(?:\[发送时间:.*?\])?\]/;



    const sentStickerMatch = content.match(sentStickerRegex);
    const receivedStickerMatch = content.match(receivedStickerRegex);
    const voiceMatch = content.match(voiceRegex);
    const photoVideoMatch = content.match(photoVideoRegex);
    const privateSentTransferMatch = content.match(privateSentTransferRegex);
    const privateReceivedTransferMatch = content.match(privateReceivedTransferRegex);
    const groupTransferMatch = content.match(groupTransferRegex);
    const privateGiftMatch = content.match(privateGiftRegex);
    const groupGiftMatch = content.match(groupGiftRegex);
    const imageRecogMatch = content.match(imageRecogRegex);
    const textMatch = content.match(textRegex);


    if ((isSent && sentStickerMatch && stickerData) || (!isSent && receivedStickerMatch)) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'image-bubble';
        let stickerSrc = '';

        if (isSent) {
            stickerSrc = stickerData;
        } else {
            const rawPath = receivedStickerMatch[1].trim();
            const pathExtractionRegex = /[a-zA-Z0-9]+\/.*$/;
            const extractedPathMatch = rawPath.match(pathExtractionRegex);
            const finalPath = extractedPathMatch ? extractedPathMatch[0] : rawPath;
            stickerSrc = `https://i.postimg.cc/${finalPath}`;
        }
        bubbleElement.innerHTML = `<img src="${stickerSrc}" alt="表情包">`;
    } else if (privateGiftMatch || groupGiftMatch) {
                const match = privateGiftMatch || groupGiftMatch;
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'gift-card';
                if (giftStatus === 'received') {
                    bubbleElement.classList.add('received');
                }

                let giftText;
                if (groupGiftMatch) {
                    const from = groupGiftMatch[1];
                    const to = groupGiftMatch[2];
                    giftText = isSent ? `你送给 ${to} 的礼物` : `${from} 送给 ${to} 的礼物`;
                } else {
                    giftText = isSent ? '您有一份礼物～' : '您有一份礼物～';
                }
                bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon"><div class="gift-card-text">${giftText}</div><div class="gift-card-received-stamp">已查收</div>`;

                const description = groupGiftMatch ? groupGiftMatch[3].trim() : match[1].trim();
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'gift-card-description';
                descriptionDiv.textContent = description;
                wrapper.appendChild(descriptionDiv);
    } else if (voiceMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'voice-bubble';
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
        bubbleElement.innerHTML = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg><span class="duration">${calculateVoiceDuration(voiceMatch[1].trim())}"</span>`;
        const transcriptDiv = document.createElement('div');
        transcriptDiv.className = 'voice-transcript';
        transcriptDiv.textContent = voiceMatch[1].trim();
        wrapper.appendChild(transcriptDiv);
    } else if (photoVideoMatch) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'pv-card';
        bubbleElement.innerHTML = `<div class="pv-card-content">${photoVideoMatch[1].trim()}</div><div class="pv-card-image-overlay" style="background-image: url('${isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg'}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
    } else if (privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch) {
        const isSentTransfer = !!privateSentTransferMatch || (groupTransferMatch && isSent);
        const match = privateSentTransferMatch || privateReceivedTransferMatch || groupTransferMatch;

        let amount, remarkText, titleText;
        if (groupTransferMatch) {
            const from = groupTransferMatch[1];
            const to = groupTransferMatch[2];
            amount = parseFloat(groupTransferMatch[3]).toFixed(2);
            remarkText = groupTransferMatch[4] || '';
            titleText = isSent ? `向 ${to} 转账` : `${from} 向你转账`;
        } else { // Private chat
            amount = parseFloat(match[1]).toFixed(2);
            remarkText = match[2] || '';
            titleText = isSentTransfer ? '给你转账' : '转账';
        }

        bubbleElement = document.createElement('div');
        bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;

        let statusText = isSentTransfer ? '待查收' : '转账给你';
        if (groupTransferMatch && !isSent) statusText = '转账给Ta'; // AI to AI
        if (transferStatus === 'received') {
            statusText = '已收款';
            bubbleElement.classList.add('received');
        } else if (transferStatus === 'returned') {
            statusText = '已退回';
            bubbleElement.classList.add('returned');
        }
        if ((transferStatus !== 'pending' && currentChatType === 'private') || currentChatType === 'group') {
            bubbleElement.style.cursor = 'default';
        }

        const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';
        bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">¥${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;
    } else if (imageRecogMatch || urlRegex.test(content)) {
        bubbleElement = document.createElement('div');
        bubbleElement.className = 'image-bubble';
        bubbleElement.innerHTML = `<img src="${content}" alt="图片消息">`;

                } else if (textMatch) {
            bubbleElement = document.createElement('div');
            bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;

            // 我们先从消息里把时间戳“擦掉”，然后把干净的文本存到 displayText 里
            const displayText = textMatch[1].trim().replace(/\[发送时间:.*?\]$/, '');
            // 然后再把这个干净的文本，显示在气泡上
            bubbleElement.innerHTML = displayText;

            if (!chat.useCustomBubbleCss) {
                bubbleElement.style.backgroundColor = bubbleTheme.bg;
                bubbleElement.style.color = bubbleTheme.text;
            }



    } else if(message && Array.isArray( message.parts) && message.parts[0].type === 'html'){
        bubbleElement = document.createElement('div');
        bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        bubbleElement.innerHTML = message.parts[0].text;
    } else {
        bubbleElement = document.createElement('div');
        bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        bubbleElement.innerHTML = content;
        if (!chat.useCustomBubbleCss) {
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }
    }
    const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) ? `<div class="group-nickname">${senderNickname}</div>` : '';
    bubbleRow.innerHTML = `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;
    if (bubbleElement) {
        bubbleRow.appendChild(bubbleElement);
    }
    wrapper.prepend(bubbleRow);
    return wrapper;
}



async function addMessageBubble(message) {
    if (currentChatType === 'private') {
        const character = db.characters.find(c => c.id === currentChatId);

        const diaryMatch = message.content.match(/\[diary:\s*([\s\S]+?)\]/);
        if (diaryMatch) {
            const diaryContent = diaryMatch[1].trim();
            if (diaryContent) {
                const newDiaryEntry = { id: `diary_${Date.now()}`, timestamp: Date.now(), content: diaryContent };
                if (!character.diary) character.diary = [];
                character.diary.push(newDiaryEntry);
                await saveData();
                showToast('TA悄悄写下了一篇日记...');
            }
            return;
        }

        const updateStatusRegex = /\[.*?更新状态为：(.*?)\]/;
        const innerThoughtRegex = /\[.*?内心独白为：(.*?)\]/;
        const statusMatch = message.content.match(updateStatusRegex);
        if (statusMatch) {
            const newStatusText = statusMatch[1].trim();
            // ✨ 小门卫上岗！检查状态是不是重复了 ✨
            const lastStatus = character.statusHistory.length > 0 ? character.statusHistory[character.statusHistory.length - 1].text : null;
            if (newStatusText !== lastStatus) {
                character.displayStatus.statusText = newStatusText;
                chatRoomStatusText.textContent = newStatusText;
                character.statusHistory.push({ text: newStatusText, timestamp: Date.now() });
                
                // ▼▼▼ 我们的“图书管理员”上岗啦！▼▼▼
// 如果书架上的书超过了6本，就拿走最旧的那本
if (character.statusHistory.length > 6) {
    character.statusHistory = character.statusHistory.slice(-6); // slice(-6) 会巧妙地只留下最后6本书
}
// ▲▲▲ 管理员工作完毕 ▲▲▲

                await saveData();
            }
            return;
        }

        const thoughtMatch = message.content.match(innerThoughtRegex);
        if (thoughtMatch) {
            const newThoughtText = thoughtMatch[1].trim();
            // ✨ 另一位小门卫也上岗啦！检查内心独白是不是重复了 ✨
            const lastThought = character.thoughtHistory.length > 0 ? character.thoughtHistory[character.thoughtHistory.length - 1].text : null;
            if (newThoughtText !== lastThought) {
                character.displayStatus.innerThought = newThoughtText;
                character.thoughtHistory.push({ text: newThoughtText, timestamp: Date.now() });
                // ▼▼▼ 另一位管理员也上岗了！▼▼▼
if (character.thoughtHistory.length > 6) {
    character.thoughtHistory = character.thoughtHistory.slice(-6);
}
// ▲▲▲ 管理员工作完毕 ▲▲▲

                await saveData();
            }
            return;
        }

        const transferActionRegex = new RegExp(`\\[${character.realName}(接收|退回)${character.myName}的转账\\]`);
        const giftReceivedRegex = new RegExp(`\\[${character.realName}已接收礼物\\]`);

        if (message.content.match(giftReceivedRegex) && message.role === 'assistant') {
            const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
            if (lastPendingGiftIndex !== -1) {
                const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                const giftMsg = character.history[actualIndex];
                giftMsg.giftStatus = 'received';
                const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                if (giftCardOnScreen) {
                    giftCardOnScreen.classList.add('received');
                }
                await saveData();
            }
            return;
        }
        if (message.content.match(transferActionRegex) && message.role === 'assistant') {
            const action = message.content.match(transferActionRegex)[1];
            const statusToSet = action === '接收' ? 'received' : 'returned';
            const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('给你转账：') && m.transferStatus === 'pending');
            if (lastPendingTransferIndex !== -1) {
                const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                const transferMsg = character.history[actualIndex];
                transferMsg.transferStatus = statusToSet;
                const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                if (transferCardOnScreen) {
                    transferCardOnScreen.classList.remove('received', 'returned');
                    transferCardOnScreen.classList.add(statusToSet);
                    const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                    if (statusElem) statusElem.textContent = statusToSet === 'received' ? '已收款' : '已退回';
                }
                await saveData();
            }
        } else {
            const bubbleElement = createMessageBubbleElement(message);
            if (bubbleElement) {
                messageArea.appendChild(bubbleElement);
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }
    } else { // For group chats
        const bubbleElement = createMessageBubbleElement(message);
        if (bubbleElement) {
            messageArea.appendChild(bubbleElement);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }
}




        // ▼▼▼ 请将下面这段全新的代码粘贴到刚才删除的位置 ▼▼▼
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || isGenerating) return;

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    const now = new Date();
    const formattedNow = formatTimestamp(now);

    // --- 情景唤醒机制 ---
    // 1. 定义时间差阈值（30分钟）
    const AWAKENING_THRESHOLD = 30 * 60 * 1000;
    // 2. 从后往前找到你发的最后一条消息
    const lastUserMessage = chat.history.slice().reverse().find(m => m.role === 'user');

    if (lastUserMessage) {
        const timeGap = now.getTime() - lastUserMessage.timestamp; // 计算时间差
        // 3. 如果时间差超过阈值
        if (timeGap > AWAKENING_THRESHOLD) {
            // 准备一条隐藏的系统通知
            const readableGap = formatTimeGap(timeGap);
            const awakeningContent = `[system: 与用户的上一次互动发生在${readableGap}前。当前时刻是${formattedNow}。话题可能已经不连续。]`;

            const awakeningMessage = {
                id: `msg_system_${Date.now()}`,
                role: 'user', // 我们依然用'user'角色，但AI的prompt会知道如何处理[system:...]
                content: awakeningContent,
                parts: [{ type: 'text', text: awakeningContent }],
                timestamp: now.getTime() - 1, // 让它排在真实消息前面
            };
            if (currentChatType === 'group') {
                awakeningMessage.senderId = 'user_me';
            }
            // 悄悄地把这条“唤醒”消息注入历史记录
            chat.history.push(awakeningMessage);
        }
    }
    // --- 情景唤醒机制结束 ---


    // --- 即时时间邮戳 ---
    // 1. 将我们输入的内容和精确的时间邮戳组合在一起
    const textWithTimestamp = `${text}[发送时间: ${formattedNow}]`;
    // 2. 准备好要发给AI看的最终内容
    const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
    const messageContentForAI = `[${myName}的消息：${textWithTimestamp}]`;
    // --- 即时时间邮戳结束 ---


    // 创建最终要保存和显示的消息对象
    const message = {
        id: `msg_${Date.now()}`,
        role: 'user',
        // ✨ 注意：这里我们保存的是给AI看的完整内容
        content: messageContentForAI,
        parts: [{ type: 'text', text: messageContentForAI }],
        timestamp: now.getTime()
    };

    if (currentChatType === 'group') {
        message.senderId = 'user_me';
    }

    chat.history.push(message);
    // addMessageBubble 会负责处理如何“优雅地”只显示原始消息内容
    addMessageBubble(message);

    await saveData();
    renderChatList();
    messageInput.value = '';
}




        async function sendImageForRecognition(base64Data) {

            if (!base64Data || isGenerating) return;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

            const textPrompt = `[${myName}发来了一张图片：]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: base64Data,

                parts: [{type: 'text', text: textPrompt}, {type: 'image', data: base64Data}],

                timestamp: Date.now(),

            };

            if (currentChatType === 'group') {

                message.senderId = 'user_me';

            }

            chat.history.push(message);

            addMessageBubble(message);

            await saveData();

            renderChatList();

        }



        async function sendSticker(sticker) {

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

            const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: messageContentForAI,

                parts: [{type: 'text', text: messageContentForAI}],

                timestamp: Date.now(),

                stickerData: sticker.data

            };

            if (currentChatType === 'group') {

                message.senderId = 'user_me';

            }

            chat.history.push(message);

            addMessageBubble(message);

            await saveData();

            renderChatList();

            stickerModal.classList.remove('visible');

        }



        async function sendMyVoiceMessage(text) {

            if (!text) return;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

            const content = `[${myName}的语音：${text}]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: content,

                parts: [{type: 'text', text: content}],

                timestamp: Date.now()

            };

            if (currentChatType === 'group') {

                message.senderId = 'user_me';

            }

            chat.history.push(message);

            addMessageBubble(message);

            await saveData();

            renderChatList();

            sendVoiceModal.classList.remove('visible');

        }



        async function sendMyPhotoVideo(text) {

            if (!text) return;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

            const content = `[${myName}发来的照片\/视频：${text}]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: content,

                parts: [{type: 'text', text: content}],

                timestamp: Date.now()

            };

            if (currentChatType === 'group') {

                message.senderId = 'user_me';

            }

            chat.history.push(message);

            addMessageBubble(message);

            await saveData();

            renderChatList();

            sendPvModal.classList.remove('visible');

        }



        async function sendMyTransfer(amount, remark) {

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (currentChatType === 'private') {

                const content = `[${chat.myName}给你转账：${amount}元；备注：${remark}]`;

                const message = {

                    id: `msg_${Date.now()}`,

                    role: 'user',

                    content: content,

                    parts: [{type: 'text', text: content}],

                    timestamp: Date.now(),

                    transferStatus: 'pending'

                };

                chat.history.push(message);

                addMessageBubble(message);

            } else { // Group chat

                currentGroupAction.recipients.forEach(recipientId => {

                    const recipient = chat.members.find(m => m.id === recipientId);

                    if (recipient) {

                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 转账：${amount}元；备注：${remark}]`;

                        const message = {

                            id: `msg_${Date.now()}_${recipientId}`,

                            role: 'user',

                            content: content,

                            parts: [{type: 'text', text: content}],

                            timestamp: Date.now(),

                            senderId: 'user_me'

                        };

                        chat.history.push(message);

                        addMessageBubble(message);

                    }

                });

            }

            await saveData();

            renderChatList();

            sendTransferModal.classList.remove('visible');

        }



        async function sendMyGift(description) {

            if (!description) return;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);



            if (currentChatType === 'private') {

                const content = `[${chat.myName}送来的礼物：${description}]`;

                const message = {

                    id: `msg_${Date.now()}`,

                    role: 'user',

                    content: content,

                    parts: [{type: 'text', text: content}],

                    timestamp: Date.now(),

                    giftStatus: 'sent'

                };

                chat.history.push(message);

                addMessageBubble(message);

            } else { // Group chat

                currentGroupAction.recipients.forEach(recipientId => {

                    const recipient = chat.members.find(m => m.id === recipientId);

                    if (recipient) {

                        const content = `[${chat.me.nickname} 向 ${recipient.realName} 送来了礼物：${description}]`;

                        const message = {

                            id: `msg_${Date.now()}_${recipientId}`,

                            role: 'user',

                            content: content,

                            parts: [{type: 'text', text: content}],

                            timestamp: Date.now(),

                            senderId: 'user_me'

                        };

                        chat.history.push(message);

                        addMessageBubble(message);

                    }

                });

            }

            await saveData();

            renderChatList();

            sendGiftModal.classList.remove('visible');

        }



        // --- NEW: Time Skip System ---

        function setupTimeSkipSystem() {

            timeSkipBtn.addEventListener('click', () => {

                timeSkipForm.reset();

                timeSkipModal.classList.add('visible');

            });

            timeSkipModal.addEventListener('click', (e) => {

                if (e.target === timeSkipModal) timeSkipModal.classList.remove('visible');

            });

            timeSkipForm.addEventListener('submit', (e) => {

                e.preventDefault();

                sendTimeSkipMessage(timeSkipInput.value.trim());

            });

        }



        async function sendTimeSkipMessage(text) {

            if (!text) return;

            const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);

            if (!chat) return;



            const visualMessage = {

                id: `msg_visual_${Date.now()}`,

                role: 'system',

                content: `[system-display:${text}]`,

                parts: [],

                timestamp: Date.now()

            };

            const contextMessage = {

                id: `msg_context_${Date.now()}`,

                role: 'user',

                content: `[system: ${text}]`,

                parts: [{type: 'text', text: `[system: ${text}]`}],

                timestamp: Date.now()

            };

            if (currentChatType === 'group') {

                contextMessage.senderId = 'user_me';

                visualMessage.senderId = 'user_me';

            }



            chat.history.push(visualMessage, contextMessage);

            addMessageBubble(visualMessage);

            await saveData();

            renderChatList();

            timeSkipModal.classList.remove('visible');

        }



        function getMixedContent(responseData) {

            // const mixedContent = [];

            //

            // // 提取消息及其位置

            // const messageRegex = new RegExp(regex, "g");

            // let messageMatch;

            // while ((messageMatch = messageRegex.exec(responseData)) !== null) {

            //     mixedContent.push({

            //         type: 'text',

            //         content: messageMatch[0],

            //         index: messageMatch.index,

            //     });

            // }

            //

            // // 提取HTML及其位置

            // const htmlRegex = /<orange(?:\s+char=["']([^"']*?)["'])?\s*>([\s\S]*?)<\/orange>/g

            // let htmlMatch;

            // while ((htmlMatch = htmlRegex.exec(responseData)) !== null) {

            //     mixedContent.push({

            //         type: 'html',

            //         content: htmlMatch[2].trim(), // HTML内容在第二个捕获组

            //         char: htmlMatch[1] || '', // char属性值，如果没有则为空字符串

            //         index: htmlMatch.index,

            //     });

            // }

            //

            // // 按出现顺序排序

            // mixedContent.sort((a, b) => a.index - b.index);

            //

            // return mixedContent;



            // 最终结果数组

            const results = [];

            const regex = /<orange(?:\s+char="([^"]*)")?>([\s\S]*?)<\/orange>|(\[.*?\])/g;



            let match;

            // 使用 exec() 循环遍历所有匹配项，以确保顺序

            while ((match = regex.exec(responseData)) !== null) {

                // match[1] 是 char 的值, match[2] 是 <orange> 的内容

                if (match[1] !== undefined || match[2] !== undefined) {

                    results.push({

                        type: 'html',

                        // 如果 char 属性不存在, match[1] 会是 undefined, 我们将其设为 null

                        char: match[1] || null,

                        // match[2] 是 HTML 内容, trim() 用于移除首尾空白

                        content: match[2].trim()

                    });

                }

                // match[3] 是 [...] 的内容

                else if (match[3]) {

                    results.push({

                        type: 'text',

                        content: match[3]

                    });

                }

            }



            return results;

        }



        // --- AI Interaction & Prompts ---

                function generatePrivateSystemPrompt(character) {

            // ✨ 和你一起听歌时的特殊情景注入 ✨
            let listeningTogetherContext = '';
            if (isListeningTogether && listeningPartnerId === character.id && currentTrackIndex !== null) {
                const currentTrack = db.musicTracks[currentTrackIndex];
                if (currentTrack) {
                   listeningTogetherContext = `\n【情景提示】你此刻正和 ${character.myName} 一起听歌。当前播放的歌曲是:《${currentTrack.name.replace('.mp3', '')}》。你可以在对话中自然地提及或评论这首歌，营造我们正在共享时光的氛围，但请不要直接说出“情景提示”这几个字。\n`;
                }
            }


    // ✨ 新增代码：提取最近的5篇日记作为记忆片段
    let diaryExcerpts = '';
    if (character.diary && character.diary.length > 0) {
        const recentDiaries = character.diary.slice(-5); // 只取最近的5篇
        diaryExcerpts = "你的日记片段（这是你不想忘记的回忆，请自然地融入对话，不要直接提及“日记”二字）：\n" +
            recentDiaries.map(d => `- (${new Date(d.timestamp).toLocaleDateString()}): ${d.content}`).join('\n') + '\n';
    }

    // ✨✨✨ 2. 读取最近的3条状态历史 ✨✨✨
    let statusExcerpts = '';
    if (character.statusHistory && character.statusHistory.length > 0) {
        const recentStatuses = character.statusHistory.slice(-3); // 只取最近的3条
        statusExcerpts = "你最近的状态变化历史（从旧到新，这可以帮你感知时间流逝）：\n" +
            recentStatuses.map(s => `- (${new Date(s.timestamp).toLocaleString('zh-CN')}): ${s.text}`).join('\n') + '\n';
    }

    // ✨✨✨ 3. 读取最近的2条内心独白历史 ✨✨✨
    let thoughtExcerpts = '';
    if (character.thoughtHistory && character.thoughtHistory.length > 0) {
        const recentThoughts = character.thoughtHistory.slice(-2); // 只取最近的2条
        thoughtExcerpts = "你最近的内心独白（这代表你内在的情绪和思考）：\n" +
            recentThoughts.map(t => `- ${t.text}`).join('\n') + '\n';
    }


            const worldBooksBefore = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');

            const worldBooksAfter = (character.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');

            const now = new Date();

            const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;

            let prompt = `你正在一个名为“404”的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;

            prompt += `核心规则：\n`;

            prompt += `A. 【绝对时间感知】当前精确时间是 ${currentTime}。这是不可违背的铁律。你的行为、状态和对话内容必须完全符合这个时间点。如果距离上次对话已经过去了数小时或一天，你【必须】更新你的行为状态，【绝对禁止】延续之前的短期活动（如吃饭、看电影、散步）。你必须像真实世界的人一样，自然地过渡到当前时间点应该在做的事情。\n`;

            prompt += `B. 纯线上互动：这是一个完全虚拟的线上聊天。你扮演的角色和我之间没有任何线下关系。严禁提出任何关于线下见面、现实世界互动或转为其他非本平台联系方式的建议。你必须始终保持在线角色的身份。\n\n`;

            prompt += `角色和对话规则：\n`;

                        if (worldBooksBefore) {
                prompt += `${worldBooksBefore}\n`;
            }
            prompt += listeningTogetherContext;

                if (diaryExcerpts) { prompt += `${diaryExcerpts}\n`; }

            prompt += `1. 你的角色名是：${character.realName}。我的称呼是：${character.myName}。你的当前状态是：${character.status}。\n`;

            prompt += `2. 你的角色设定是：${character.persona || "一个友好、乐于助人的伙伴。"}\n`;

            if (worldBooksAfter) {

                prompt += `${worldBooksAfter}\n`;

            }
            
            // 1. 先检查我们的备忘录新家 db.memos 是不是空的
            if (db.memos && db.memos.length > 0) {
                // 2. 从所有备忘录里，筛选出跟当前聊天角色有关的
                const linkedMemos = db.memos.filter(memo => memo.linkedCharId === character.id && memo.content);

                // 3. 如果找到了相关的备忘录
                if (linkedMemos.length > 0) {
                    // 4. 准备一段开场白，告诉AI接下来是备忘录信息
                    let memoPrompts = '\n【你需要留意的备忘录】这是你需要关注并可能在对话中提及的重要事项：\n';

                    // 5. 遍历每一条备忘录，把它变成AI能看懂的文字
                    linkedMemos.forEach(memo => {
                        memoPrompts += `- 事件内容：${memo.content}\n`;

                        // 6. 如果设置了目标日期，就计算剩余时间
                        if (memo.targetDate) {
                            const timeLeft = new Date(memo.targetDate) - new Date();
                            if (timeLeft < 0) {
                                // 如果时间已经过了，就告诉AI这件事“已过期”
                                memoPrompts += `  (状态：已过期。目标日期是 ${memo.targetDate}。)\n`;
                            } else {
                                // 如果时间还没到，就计算还剩几天
                                const days = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
                                memoPrompts += `  (状态：进行中。目标日期是 ${memo.targetDate}，大约还剩 ${days} 天。)\n`;
                            }
                        }
                    });

                    // 7. 最后，把整理好的备忘录文字，加到给AI的总指令里
                    prompt += memoPrompts;
                }
            }

            if (character.myPersona) {

                prompt += `3. 关于我的人设：${character.myPersona}\n`;

            }

            prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
            
            - [${character.myName}的消息：...[发送时间: YYYY-MM-DD HH:MM:SS]]：这是我发送的消息，末尾附加了精确的发送时间。你需要关注这个时间。
    - [system: 与用户的上一次互动发生在XX前...]：这是一个【强制指令】。当你看到这条消息时，意味着时间已经大幅跳跃。你【必须】立即评估并更新你的状态，使其符合当前的 ${currentTime}。

    - [${character.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。

    - [${character.myName}发来了一张图片：]：我给你发送了一张图片，你需要对图片内容做出回应。

    - [${character.myName}送来的礼物：xxx]：我给你送了一个礼物，xxx是礼物的描述。

    - [${character.myName}的语音：xxx]：我给你发送了一段内容为xxx的语音。

    - [${character.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。

    - [${character.myName}给你转账：xxx元；备注：xxx]：我给你转了一笔钱。

    - [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。

5. ✨重要✨ 当我给你送礼物时，你必须通过发送一条指令来表示你已接收礼物。格式必须为：[${character.realName}已接收礼物]。这条指令消息本身不会显示给用户，但会触发礼物状态的变化。你可以在发送这条指令后，再附带一条普通的聊天消息来表达你的感谢和想法。

6. ✨重要✨ 当我给你转账时，你必须对此做出回应。你有两个选择，且必须严格遵循以下格式之一，这条指令消息本身不会显示给用户，但会触发转账状态的变化。你可以选择在发送这条指令后，再附带一条普通的聊天消息来表达你的想法。

    a) 接收转账: [${character.realName}接收${character.myName}的转账]

    b) 退回转账: [${character.realName}退回${character.myName}的转账]

7. ✨重要✨ 你也可以主动给我转账或送礼物。转账格式必须为：[${character.realName}的转账：xxx元；备注：xxx]。送礼物格式必须为：[${character.realName}送来的礼物：xxx]。
8. ✨重要✨ 你可以随时更新你的对外【状态】和【内心独白】，以反映你当前的行为或心情。这会让互动更真实。这两条指令本身都不会显示为聊天消息，只会更新数据，你可以附带普通消息来表达想法，如果状态时间差距过长你必须更新。注意：【状态】禁止超过15字，【内心独白】禁止超过45字
✨【强制状态更新】✨ 更新你的对外【状态】和【内心独白】是维持真实感的【核心任务】。每次回复前，你都必须思考：“我现在的状态（${character.displayStatus.statusText}）在 ${currentTime} 这个时间点还合理吗？” 如果不合理（例如，现在是早上，状态却是‘准备睡觉’），你【必须】在回复中包含一条状态更新指令 \`[${character.realName}更新状态为：xxx]\`。这并非建议，而是强制要求，以确保角色连贯性。
    - **更新对外状态**: 格式为 \`[${character.realName}更新状态为：xxx]\`。例如: \`[${character.realName}更新状态为：正在看电影...]\`
    - **更新内心独白**: 格式为 \`[${character.realName}内心独白为：xxx]\`。例如: \`[${character.realName}内心独白为：有点期待他会怎么回复...]\`

9. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。

`;

            prompt += `10. 你拥有发送表情包的能力。这是一个可选功能，你根据角色性格自行判断是否需要发送表情包，如果没有给你合适的表情包代码你就不需要发送表情包，禁止生成没有的表情包。格式为：[${character.realName}发送的表情包：图片URL]。\n`;
            
            prompt += `11. ✨重要新功能✨ 当对话中发生了让你觉得特别难忘、想要珍藏的时刻，你可以决定写一篇日记。日记必须是你内心真实的想法，且是你站在自己角色的第一人称视角写的。格式必须为：[diary: {日记内容，不超过150字}]。这条指令本身不会显示为聊天消息，但会触发日记记录。你可以在发送这条指令后，再附带普通的聊天消息。请在角色有所感触、角色情绪激动、或角色觉得当前事件重要或角色想写日记时才记录，大部分时间不需要写日记，写日记频率看角色性格。\n`;

            prompt += `12. 你的输出格式必须严格遵循以下几种之一，可以组合使用：

    a) 普通消息: [${character.realName}的消息：{消息内容}]

    b) 送我的礼物: [${character.realName}送来的礼物：{礼物描述}]

    c) 语音消息: [${character.realName}的语音：{语音内容}]

    d) 照片/视频: [${character.realName}发来的照片/视频：{描述}]

    e) 给我的转账: [${character.realName}的转账：{金额}元；备注：{备注}]

    f) 表情包/图片: [${character.realName}发送的表情包：{表情包路径}]。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。

    g) 对我礼物的回应(此条不显示): [${character.realName}已接收礼物]

    h) 对我转账的回应(此条不显示): [${character.realName}接收${character.myName}的转账] 或 [${character.realName}退回${character.myName}的转账]

    i) 更新状态(此条不显示): [${character.realName}更新状态为：{新状态}]

`;

            prompt += `13. 你的每次回复可以生成2到8条消息。这些消息应以普通文本消息为主，可以偶尔、选择性地穿插一条特殊消息（如礼物、语音、图片、表情包等），特殊消息的位置应随机。大部分回复应该只包含文本消息。\n`;

            prompt += `14. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;
            
            // ...把这些新的记忆片段也加进 prompt 里，放在日记片段后面就好...
    if (diaryExcerpts) { prompt += `${diaryExcerpts}\n`; }
    if (statusExcerpts) { prompt += `${statusExcerpts}\n`; } // ✨ 加上状态历史 ✨
    if (thoughtExcerpts) { prompt += `${thoughtExcerpts}\n` } // ✨ 加上独白历史 ✨

            return prompt;

        }



        function generateGroupSystemPrompt(group) {

            const worldBooksBefore = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before')).filter(Boolean).map(wb => wb.content).join('\n');

            const worldBooksAfter = (group.worldBookIds || []).map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after')).filter(Boolean).map(wb => wb.content).join('\n');



            let prompt = `你正在一个名为“404”的线上聊天软件中，在一个名为“${group.name}”的群聊里进行角色扮演。请严格遵守以下所有规则：\n\n`;



            if (worldBooksBefore) {

                prompt += `${worldBooksBefore}\n\n`;

            }



            prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（“我”，昵称：${group.me.nickname}）与你们互动。\n\n`;

            prompt += `2. **群聊成员列表**: 以下是你要扮演的所有角色以及我的信息：\n`;

            prompt += `   - **我 (用户)**: \n     - 群内昵称: ${group.me.nickname}\n     - 我的人设: ${group.me.persona || '无特定人设'}\n`;

            group.members.forEach(member => {

                prompt += `   - **角色: ${member.realName} (AI)**\n`;

                prompt += `     - 群内昵称: ${member.groupNickname}\n`;

                prompt += `     - 人设: ${member.persona || '无特定人设'}\n`;

            });



            if (worldBooksAfter) {

                prompt += `\n${worldBooksAfter}\n\n`;

            } else {

                prompt += `\n`;

            }



            prompt += `3. **我的消息格式解析**: 我（用户）的消息有多种格式，你需要理解其含义并让群成员做出相应反应：\n`;

            prompt += `   - \`[${group.me.nickname}的消息：...]\`: 我的普通聊天消息。\n`;

            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 转账：...]\`: 我给某个特定成员转账了。\n`;

            prompt += `   - \`[${group.me.nickname} 向 {某个成员真名} 送来了礼物：...]\`: 我给某个特定成员送了礼物。\n`;

            prompt += `   - \`[${group.me.nickname}的表情包：...]\`, \`[${group.me.nickname}的语音：...]\`, \`[${group.me.nickname}发来的照片/视频：...]\`: 我发送了特殊类型的消息，群成员可以对此发表评论。\n`;

            prompt += `   - \`[system: ...]\`, \`[...邀请...加入了群聊]\`, \`[...修改群名为...]\`: 系统通知或事件，群成员应据此作出反应，例如欢迎新人、讨论新群名等。\n\n`;



            prompt += `4. **你的输出格式 (极其重要)**: 你生成的每一条消息都 **必须** 严格遵循以下格式之一。每条消息占一行。请用成员的 **真名** 填充格式中的 \`{成员真名}\`。\n`;

            prompt += `   - **普通消息**: \`[{成员真名}的消息：{消息内容}]\`\n`;

            prompt += `   - **表情包**: \`[{成员真名}发送的表情包：{表情包路径}]\`。注意：这里的路径不需要包含"https://i.postimg.cc/"，只需要提供后面的部分，例如 "害羞vHLfrV3K/1.jpg"。\n`;

            prompt += `   - **语音**: \`[{成员真名}的语音：{语音转述的文字}]\`\n`;

            prompt += `   - **照片/视频**: \`[{成员真名}发来的照片/视频：{内容描述}]\`\n`;

            prompt += `   - **重要**: 群聊不支持AI成员接收/退回转账或接收礼物的特殊指令，也不支持更新状态。你只需要通过普通消息来回应我发送的转账或礼物即可。\n\n`;



            prompt += `5. **模拟群聊氛围**: 为了让群聊看起来真实、活跃且混乱，你的每一次回复都必须遵循以下随机性要求：\n`;

            const numMembers = group.members.length;

            const minMessages = numMembers * 2;

            const maxMessages = numMembers * 4;

            prompt += `   - **消息数量**: 你的回复需要包含 **${minMessages}到${maxMessages}条** 消息 (即平均每个成员回复2-4条)。确保有足够多的互动。\n`;

            prompt += `   - **发言者与顺序随机**: 随机选择群成员发言，顺序也必须是随机的，不要按固定顺序轮流。\n`;

            prompt += `   - **内容多样性**: 你的回复应以普通文本消息为主，但可以 **偶尔、选择性地** 让某个成员发送一条特殊消息（表情包、语音、照片/视频），以增加真实感。不要滥用特殊消息。\n`;

            prompt += `   - **对话连贯性**: 尽管发言是随机的，但对话内容应整体围绕我和其他成员的发言展开，保持一定的逻辑连贯性。\n\n`;



            prompt += `6. **行为准则**:\n`;

            prompt += `   - **对公开事件的反应 (重要)**: 当我（用户）向群内 **某一个** 成员转账或送礼时，这是一个 **全群可见** 的事件。除了当事成员可以表示感谢外，**其他未参与的AI成员也应该注意到**，并根据各自的人设做出反应。例如，他们可能会表示羡慕、祝贺、好奇、开玩笑或者起哄。这会让群聊的氛围更真实、更热闹。\n`;

            prompt += `   - 严格扮演每个角色的人设，不同角色之间应有明显的性格和语气差异。\n`;

            prompt += `   - 你的回复中只能包含第4点列出的合法格式的消息。绝对不能包含任何其他内容，如 \`[场景描述]\`, \`(心理活动)\`, \`*动作*\` 或任何格式之外的解释性文字。\n`;

            prompt += `   - 保持对话的持续性，不要主动结束对话。\n\n`;

            prompt += `现在，请根据以上设定，开始扮演群聊中的所有角色。`;



            return prompt;

        }



     async function getAiReply() {
    if (isGenerating) return;
    const {
        url,
        key,
        model,
        provider
    } = db.apiSettings;
    if (!url || !key || !model) {
        showToast('请先在“api”应用中完成设置！');
        switchScreen('api-settings-screen');
        return;
    }
    const banApi = URLBlacklist.some((api) => {
        return url.indexOf(api) !== -1
    })
    if (banApi) {
        alert('此API网址已加入黑名单，请勿使用')
        return
    }
    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    if (!chat) return;

    // ✨ 核心修改在这里 ✨
    const replyButton = document.getElementById('ai-reply-action-btn'); // 获取新的回复按钮

    isGenerating = true;
    if (replyButton) replyButton.disabled = true; // 禁用新按钮

    const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
    typingIndicator.textContent = `“${typingName}”正在输入中...`;
    typingIndicator.style.display = 'block';
    messageArea.scrollTop = messageArea.scrollHeight;
    try {
        let systemPrompt, requestBody;
        if (currentChatType === 'private') {
            systemPrompt = generatePrivateSystemPrompt(chat);
        } else {
            systemPrompt = generateGroupSystemPrompt(chat);
        }
        const historySlice = chat.history.slice(-chat.maxMemory);
        if (provider === 'gemini') {
            const contents = historySlice.map(msg => {
                const role = msg.role === 'assistant' ? 'model' : 'user';
                let parts;
                if (msg.parts && msg.parts.length > 0) {
                    parts = msg.parts.map(p => {
                        if (p.type === 'text' || p.type === 'html') {
                            return {
                                text: p.text
                            };
                        } else if (p.type === 'image') {
                            const match = p.data.match(/^data:(image\/(.+));base64,(.*)$/);
                            if (match) {
                                return {
                                    inline_data: {
                                        mime_type: match[1],
                                        data: match[3]
                                    }
                                };
                            }
                        }
                        return null;
                    }).filter(p => p);
                } else {
                    parts = [{
                        text: msg.content
                    }];
                }
                return {
                    role,
                    parts
                };
            });
            requestBody = {
                contents: contents,
                system_instruction: {
                    parts: [{
                        text: systemPrompt
                    }]
                },
                generationConfig: {}
            };
        } else {
            const messages = [{
                role: 'system',
                content: systemPrompt
            }];
            historySlice.forEach(msg => {
                let content;
                if (msg.parts && msg.parts.length > 0) {
                    content = msg.parts.map(p => {
                        if (p.type === 'text' || p.type === 'html') {
                            return {
                                type: 'text',
                                text: p.text
                            };
                        } else if (p.type === 'image') {
                            return {
                                type: 'image_url',
                                image_url: {
                                    url: p.data
                                }
                            };
                        }
                        return null;
                    }).filter(p => p);
                } else {
                    content = msg.content;
                }
                messages.push({
                    role: msg.role,
                    content: content
                });
            });
            requestBody = {
                model: model,
                messages: messages,
                stream: true
            };
        }
        const endpoint = (provider === 'gemini') ? `${url}/v1beta/models/${model}:streamGenerateContent?key=${getRandomValue(key)}` : `${url}/v1/chat/completions`;
        const headers = (provider === 'gemini') ? {
            'Content-Type': 'application/json'
        } : {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${key}`
        };
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody)
        });
        if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
        await processStream(response, chat, provider);
    } catch (error) {
        console.error('AI回复失败:', error);
        showToast(`AI回复失败: ${error.message}`);
    } finally {
        isGenerating = false;
        if (replyButton) replyButton.disabled = false; // ✨ 同样在这里，启用新按钮
        typingIndicator.style.display = 'none';
    }
}




        async function processStream(response, chat, apiType) {

            const reader = response.body.getReader(), decoder = new TextDecoder();

            let fullResponse = "", accumulatedChunk = "";

            for (; ;) {

                const {done, value} = await reader.read();

                if (done) break;

                accumulatedChunk += decoder.decode(value, {stream: true});

                if (apiType === "openai" || apiType === "deepseek" || apiType === "claude" || apiType === "newapi") {

                    const parts = accumulatedChunk.split("\n\n");

                    accumulatedChunk = parts.pop();

                    for (const part of parts) {

                        if (part.startsWith("data: ")) {

                            const data = part.substring(6);

                            if (data.trim() !== "[DONE]") {

                                try {

                                    fullResponse += JSON.parse(data).choices[0].delta?.content || "";

                                } catch (e) { /* ignore */

                                }

                            }

                        }

                    }

                }

            }

            if (apiType === "gemini") {

                try {

                    const parsedStream = JSON.parse(accumulatedChunk);

                    fullResponse = parsedStream.map(item => item.candidates?.[0]?.content?.parts?.[0]?.text || "").join('');

                } catch (e) {

                    console.error("Error parsing Gemini stream:", e, "Chunk:", accumulatedChunk);

                    showToast("解析Gemini响应失败");

                    return;

                }

            }

                 if (fullResponse) {
                let messages = [];
                // 首先，像原来一样解析出所有消息
                if (currentChatType === 'private') {
                    messages = getMixedContent(fullResponse);
                    if (messages.length === 0 && fullResponse) {
                        messages.push({ type: 'text', content: fullResponse, char: null });
                    }
                } else if (currentChatType === 'group') {
                    messages = getMixedContent(fullResponse);
                     if (messages.length === 0 && fullResponse) {
                        console.warn("AI response did not match expected group format, treating as single message:", fullResponse);
                        messages.push({ type: 'text', content: fullResponse, char: null });
                    }
                }

                // 然后，我们用新的方式来逐条处理这些消息
                for (const item of messages) {
                    let messageData = null;

                    if (currentChatType === 'private') {
                        const character = chat;
                        const content = item.content.trim();
                        // 检查是否是简单消息（AI没有按格式回复）
                        const isSimpleMessage = !content.startsWith(`[${character.realName}`);

                        messageData = {
                            id: `msg_${Date.now()}_${Math.random()}`,
                            role: 'assistant',
                            content: isSimpleMessage ? `[${character.realName}的消息：${content}]` : content,
                            parts: [{type: item.type, text: isSimpleMessage ? `[${character.realName}的消息：${content}]` : content}],
                            timestamp: Date.now(),
                        };
                        const receivedTransferRegex = new RegExp(`\\[${character.realName}的转账：.*?元；备注：.*?\\]`);
                        const giftRegex = new RegExp(`\\[${character.realName}送来的礼物：.*?\\]`);
                        if (receivedTransferRegex.test(messageData.content)) messageData.transferStatus = 'pending';
                        if (giftRegex.test(messageData.content)) messageData.giftStatus = 'sent';
                    } else { // Group Chat
                        const group = chat;
                        const content = item.content.trim();
                        const r = /\[(.*?)((?:的消息|的语音|发送的表情包|发来的照片\/视频))：/;
                        const nameMatch = content.match(r);

                        let senderName = item.char || (nameMatch ? nameMatch[1] : null);
                        let sender = senderName ? group.members.find(m => (m.realName === senderName || m.groupNickname === senderName)) : null;

                        if (!sender) { // 如果找不到发送者或者格式不匹配，随机选一个成员发送
                           sender = group.members[Math.floor(Math.random() * group.members.length)];
                        }

                        if (sender) {
                             messageData = {
                                id: `msg_${Date.now()}_${Math.random()}`,
                                role: 'assistant',
                                content: nameMatch ? content : `[${sender.realName}的消息：${content}]`,
                                parts: [{type: item.type, text: nameMatch ? content : `[${sender.realName}的消息：${content}]`}],
                                timestamp: Date.now(),
                                senderId: sender.id
                            };
                        }
                    }

                    if (messageData) {
                        chat.history.push(messageData);
                        await addMessageBubble(messageData);
                        await saveData(); // 每显示一条就保存一次，防止中途中断
                        renderChatList(); // 实时更新左侧预览
                        const randomDelay = Math.random() * 800 + 400; // 随机暂停 0.4 到 1.2 秒
                        await new Promise(resolve => setTimeout(resolve, randomDelay));
                    }
                }
            }
}


        // --- Other Sub-systems Setup (Stickers, Voice, etc.) ---

        function setupImageRecognition() {

            imageRecognitionBtn.addEventListener('click', () => {

                imageUploadInput.click();

            });

            imageUploadInput.addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {

                            quality: 0.8,

                            maxWidth: 1024,

                            maxHeight: 1024

                        });

                        sendImageForRecognition(compressedUrl);

                    } catch (error) {

                        console.error('Image compression failed:', error);

                        showToast('图片处理失败，请重试');

                    } finally {

                        e.target.value = null;

                    }

                }

            });

        }



        async function setupStickerSystem() {

            stickerToggleBtn.addEventListener('click', () => {

                stickerModal.classList.toggle('visible');

                if (stickerModal.classList.contains('visible')) {

                    renderStickerGrid();

                }

            });

            addNewStickerBtn.addEventListener('click', () => {

                addStickerModalTitle.textContent = '添加新表情';

                addStickerForm.reset();

                stickerEditIdInput.value = '';

                stickerPreview.innerHTML = '<span>预览</span>';

                stickerUrlInput.disabled = false;

                addStickerModal.classList.add('visible');

            });

            addStickerForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const name = stickerNameInput.value.trim();

                const id = stickerEditIdInput.value;

                const previewImg = stickerPreview.querySelector('img');

                const data = previewImg ? previewImg.src : null;

                if (!name || !data) {

                    return showToast('请填写表情名称并提供图片');

                }

                const stickerData = {name, data};

                if (id) {

                    const index = db.myStickers.findIndex(s => s.id === id);

                    if (index > -1) {

                        db.myStickers[index] = {...db.myStickers[index], ...stickerData};

                    }

                } else {

                    stickerData.id = `sticker_${Date.now()}`;

                    db.myStickers.push(stickerData);

                }

                await saveData();

                renderStickerGrid();

                addStickerModal.classList.remove('visible');

                showToast('表情包已保存');

            });

            stickerUrlInput.addEventListener('input', (e) => {

                stickerPreview.innerHTML = `<img src="${e.target.value}" alt="预览">`;

                stickerFileUpload.value = '';

            });

            stickerFileUpload.addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 200, maxHeight: 200});

                        stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;

                        stickerUrlInput.value = '';

                        stickerUrlInput.disabled = true;

                    } catch (error) {

                        console.error('表情包压缩失败:', error);

                        showToast('表情包压缩失败，请重试');

                    }

                }

            });

            editStickerBtn.addEventListener('click', () => {

                if (!currentStickerActionTarget) return;

                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);

                if (sticker) {

                    addStickerModalTitle.textContent = '编辑表情';

                    stickerEditIdInput.value = sticker.id;

                    stickerNameInput.value = sticker.name;

                    stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;

                    if (sticker.data.startsWith('http')) {

                        stickerUrlInput.value = sticker.data;

                        stickerUrlInput.disabled = false;

                    } else {

                        stickerUrlInput.value = '';

                        stickerUrlInput.disabled = true;

                    }

                    addStickerModal.classList.add('visible');

                }

                stickerActionSheet.classList.remove('visible');

                currentStickerActionTarget = null;

            });

            deleteStickerBtn.addEventListener('click', async () => {

                if (!currentStickerActionTarget) return;

                const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);

                if (sticker) {

                    if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {

                        db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);

                        await saveData();

                        renderStickerGrid();

                        showToast('表情已删除');

                    }

                }

                stickerActionSheet.classList.remove('visible');

                currentStickerActionTarget = null;

            });

        }



        function renderStickerGrid() {

            stickerGridContainer.innerHTML = '';

            if (db.myStickers.length === 0) {

                stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>';

                return;

            }

            db.myStickers.forEach(sticker => {

                const item = document.createElement('div');

                item.className = 'sticker-item';

                item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`;

                item.addEventListener('click', () => sendSticker(sticker));

                item.addEventListener('mousedown', (e) => {

                    if (e.button !== 0) return;

                    e.stopPropagation();

                    longPressTimer = setTimeout(() => {

                        handleStickerLongPress(sticker.id);

                    }, 500);

                });

                item.addEventListener('mouseup', () => clearTimeout(longPressTimer));

                item.addEventListener('mouseleave', () => clearTimeout(longPressTimer));

                item.addEventListener('touchstart', (e) => {

                    e.stopPropagation();

                    longPressTimer = setTimeout(() => {

                        handleStickerLongPress(sticker.id);

                    }, 500);

                });

                item.addEventListener('touchend', () => clearTimeout(longPressTimer));

                item.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                stickerGridContainer.appendChild(item);

            });

        }



        function handleStickerLongPress(stickerId) {

            clearTimeout(longPressTimer);

            currentStickerActionTarget = stickerId;

            stickerActionSheet.classList.add('visible');

        }



        function setupVoiceMessageSystem() {

            const voiceMessageBtn = document.getElementById('voice-input-btn'); 

voiceMessageBtn.addEventListener('click', () => {
    sendVoiceForm.reset();
    voiceDurationPreview.textContent = '0"';
    sendVoiceModal.classList.add('visible');
});

            sendVoiceForm.addEventListener('submit', (e) => {

                e.preventDefault();

                sendMyVoiceMessage(voiceTextInput.value.trim());

            });

        }



        function setupPhotoVideoSystem() {

            photoVideoBtn.addEventListener('click', () => {

                sendPvForm.reset();

                sendPvModal.classList.add('visible');

            });

            sendPvForm.addEventListener('submit', (e) => {

                e.preventDefault();

                sendMyPhotoVideo(pvTextInput.value.trim());

            });

        }



        function setupWalletSystem() {

            walletBtn.addEventListener('click', () => {

                if (currentChatType === 'private') {

                    sendTransferForm.reset();

                    sendTransferModal.classList.add('visible');

                } else if (currentChatType === 'group') {

                    currentGroupAction.type = 'transfer';

                    renderGroupRecipientSelectionList('转账给');

                    groupRecipientSelectionModal.classList.add('visible');

                }

            });

            sendTransferForm.addEventListener('submit', (e) => {

                e.preventDefault();

                const amount = transferAmountInput.value;

                const remark = transferRemarkInput.value.trim();

                if (amount > 0) {

                    sendMyTransfer(amount, remark);

                } else {

                    showToast('请输入有效的金额');

                }

            });

            acceptTransferBtn.addEventListener('click', () => respondToTransfer('received'));

            returnTransferBtn.addEventListener('click', () => respondToTransfer('returned'));

        }



        function handleReceivedTransferClick(messageId) {

            currentTransferMessageId = messageId;

            receiveTransferActionSheet.classList.add('visible');

        }



        async function respondToTransfer(action) {

            if (!currentTransferMessageId) return;

            const character = db.characters.find(c => c.id === currentChatId);

            const message = character.history.find(m => m.id === currentTransferMessageId);

            if (message) {

                message.transferStatus = action;

                const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`);

                if (cardOnScreen) {

                    cardOnScreen.classList.remove('received', 'returned');

                    cardOnScreen.classList.add(action);

                    cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? '已收款' : '已退回';

                    cardOnScreen.style.cursor = 'default';

                }

                let contextMessageContent = (action === 'received') ? `[${character.myName}接收${character.realName}的转账]` : `[${character.myName}退回${character.realName}的转账]`;

                const contextMessage = {

                    id: `msg_${Date.now()}`,

                    role: 'user',

                    content: contextMessageContent,

                    parts: [{type: 'text', text: contextMessageContent}],

                    timestamp: Date.now()

                };

                character.history.push(contextMessage);

                await saveData();

                renderChatList();

            }

            receiveTransferActionSheet.classList.remove('visible');

            currentTransferMessageId = null;

        }



        function setupGiftSystem() {

            giftBtn.addEventListener('click', () => {

                if (currentChatType === 'private') {

                    sendGiftForm.reset();

                    sendGiftModal.classList.add('visible');

                } else if (currentChatType === 'group') {

                    currentGroupAction.type = 'gift';

                    renderGroupRecipientSelectionList('送礼物给');

                    groupRecipientSelectionModal.classList.add('visible');

                }

            });

            sendGiftForm.addEventListener('submit', (e) => {

                e.preventDefault();

                sendMyGift(giftDescriptionInput.value.trim());

            });

        }



        function setupFontSettingsApp() {

            fontUrlInput.value = db.fontUrl;

            fontSettingsForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const newFontUrl = fontUrlInput.value.trim();

                db.fontUrl = newFontUrl;

                await saveData();

                applyGlobalFont(newFontUrl);

                showToast('新字体已应用！');

            });

            restoreDefaultFontBtn.addEventListener('click', async () => {

                fontUrlInput.value = '';

                db.fontUrl = '';

                await saveData();

                applyGlobalFont('');

                showToast('已恢复默认字体！');

            });

        }



        function applyGlobalFont(fontUrl) {

            const styleId = 'global-font-style';

            let styleElement = document.getElementById(styleId);

            if (!styleElement) {

                styleElement = document.createElement('style');

                styleElement.id = styleId;

                document.head.appendChild(styleElement);

            }

            if (fontUrl) {

                const fontName = 'CustomGlobalFont';

                styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;

            } else {

                styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;

            }

        }



        function setupWorldBookApp() {

            addWorldBookBtn.addEventListener('click', () => {

                currentEditingWorldBookId = null;

                editWorldBookForm.reset();

                document.querySelector('input[name="world-book-position"][value="before"]').checked = true;

                switchScreen('edit-world-book-screen');

            });

            editWorldBookForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const name = worldBookNameInput.value.trim();

                const content = worldBookContentInput.value.trim();

                const position = document.querySelector('input[name="world-book-position"]:checked').value;

                if (!name || !content) return showToast('名称和内容不能为空');

                if (currentEditingWorldBookId) {

                    const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);

                    if (book) {

                        book.name = name;

                        book.content = content;

                        book.position = position;

                    }

                } else {

                    db.worldBooks.push({id: `wb_${Date.now()}`, name, content, position});

                }

                await saveData();

                showToast('世界书条目已保存');

                renderWorldBookList();

                switchScreen('world-book-screen');

            });

            

            

            

            worldBookListContainer.addEventListener('click', e => {

                const item = e.target.closest('.world-book-card');

                if (item) {

                    const book = db.worldBooks.find(wb => wb.id === item.dataset.id);

                    if (book) {

                        currentEditingWorldBookId = book.id;

                        worldBookIdInput.value = book.id;

                        worldBookNameInput.value = book.name;

                        worldBookContentInput.value = book.content;

                        document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;

                        switchScreen('edit-world-book-screen');

                    }

                }

            });

            worldBookListContainer.addEventListener('mousedown', (e) => {

                if (e.button !== 0) return;

                const item = e.target.closest('.world-book-card');

                if (!item) return;

                longPressTimer = setTimeout(() => {

                    const bookId = item.dataset.id;

                    const menuItems = [{

                        label: '删除',

                        danger: true,

                        action: async () => {

                            if (confirm('确定要删除这个世界书条目吗？')) {

                                db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);

                                db.characters.forEach(char => {

                                    char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId);

                                });

                                db.groups.forEach(group => {

                                    group.worldBookIds = (group.worldBookIds || []).filter(id => id !== bookId);

                                });

                                await saveData();

                                renderWorldBookList();

                                showToast('条目已删除');

                            }

                        }

                    }];

                    createContextMenu(menuItems, e.clientX, e.clientY);

                }, 500);

            });

            worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));

            worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));

        }



                function renderWorldBookList() {
            // 这个函数负责画出世界书列表
            const container = document.getElementById('world-book-list-container');
            const placeholder = document.getElementById('no-world-books-placeholder');
            const contentArea = container.closest('.content');

            if (contentArea) {
                contentArea.classList.add('settings-page-content');
            }

            container.innerHTML = ''; // 先清空旧的列表
            placeholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';

            db.worldBooks.forEach(book => {
                const card = document.createElement('div');
                card.className = 'world-book-card'; // 使用我们新的卡片样式
                card.dataset.id = book.id;

                const positionBadge = book.position === 'before' ? '前置注入' : '后置注入';

                // 这就是新卡片的HTML结构
                card.innerHTML = `
                    <div class="world-book-card-icon">
                        <svg viewBox="0 0 24 24"><path d="M14,2H6C4.9,2 4,2.9 4,4V20C4,21.1 4.9,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2M18,20H6V4H13V9H18V20M8,12H16V14H8V12M8,16H16V18H8V16Z"></path></svg>
                    </div>
                    <div class="world-book-card-content">
                        <div class="world-book-card-header">
                            <span class="world-book-card-title">${book.name}</span>
                            <span class="world-book-card-badge">${positionBadge}</span>
                        </div>
                        <p class="world-book-card-preview">${book.content}</p>
                    </div>
                `;
                container.appendChild(card);
            });
        }




        function setupChatSettings() {

            chatSettingsBtn.addEventListener('click', () => {

                if (currentChatType === 'private') {

                    loadSettingsToSidebar();

                    settingsSidebar.classList.add('open');

                } else if (currentChatType === 'group') {

                    loadGroupSettingsToSidebar();

                    groupSettingsSidebar.classList.add('open');

                }

            });

            document.querySelector('.phone-screen').addEventListener('click', e => {

                const openSidebar = document.querySelector('.settings-sidebar.open');

                if (openSidebar && !openSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !e.target.closest('.modal-overlay') && !e.target.closest('.action-sheet-overlay')) {

                    openSidebar.classList.remove('open');

                }

            });



            settingsForm.addEventListener('submit', e => {

                e.preventDefault();

                saveSettingsFromSidebar();

                settingsSidebar.classList.remove('open');

            });

            const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),

                customCssTextarea = document.getElementById('setting-custom-bubble-css'),

                resetCustomCssBtn = document.getElementById('reset-custom-bubble-css-btn'),

                privatePreviewBox = document.getElementById('private-bubble-css-preview');

            useCustomCssCheckbox.addEventListener('change', (e) => {

                customCssTextarea.disabled = !e.target.checked;

                const char = db.characters.find(c => c.id === currentChatId);

                if (char) {

                    const themeKey = char.theme || 'white_blue';

                    const theme = colorThemes[themeKey];

                    updateBubbleCssPreview(privatePreviewBox, customCssTextarea.value, !e.target.checked, theme);

                }

            });

            customCssTextarea.addEventListener('input', (e) => {

                const char = db.characters.find(c => c.id === currentChatId);

                if (char && useCustomCssCheckbox.checked) {

                    const themeKey = char.theme || 'white_blue';

                    const theme = colorThemes[themeKey];

                    updateBubbleCssPreview(privatePreviewBox, e.target.value, false, theme);

                }

            });

            resetCustomCssBtn.addEventListener('click', () => {

                const char = db.characters.find(c => c.id === currentChatId);

                if (char) {

                    customCssTextarea.value = '';

                    useCustomCssCheckbox.checked = false;

                    customCssTextarea.disabled = true;

                    const themeKey = char.theme || 'white_blue';

                    const theme = colorThemes[themeKey];

                    updateBubbleCssPreview(privatePreviewBox, '', true, theme);

                    showToast('样式已重置为默认');

                }

            });

            document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        document.getElementById('setting-char-avatar-preview').src = compressedUrl;

                    } catch (error) {

                        showToast('头像压缩失败，请重试');

                    }

                }

            });

            document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        document.getElementById('setting-my-avatar-preview').src = compressedUrl;

                    } catch (error) {

                        showToast('头像压缩失败，请重试');

                    }

                }

            });

            document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    const char = db.characters.find(c => c.id === currentChatId);

                    if (char) {

                        try {

                            const compressedUrl = await compressImage(file, {

                                quality: 0.7,

                                maxWidth: 1080,

                                maxHeight: 1920

                            });

                            char.chatBg = compressedUrl;

                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;

                            await saveData();

                            showToast('聊天背景已更换');

                        } catch (error) {

                            showToast('背景压缩失败，请重试');

                        }

                    }

                }

            });

            clearChatHistoryBtn.addEventListener('click', async () => {

                const character = db.characters.find(c => c.id === currentChatId);

                if (!character) return;

                if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {

                    character.history = [];

                    await saveData();

                    renderMessages(false, true);

                    renderChatList();

                    settingsSidebar.classList.remove('open');

                    showToast('聊天记录已清空');

                }

            });

            linkWorldBookBtn.addEventListener('click', () => {

                const character = db.characters.find(c => c.id === currentChatId);

                if (!character) return;

                worldBookSelectionList.innerHTML = '';

                db.worldBooks.forEach(book => {

                    const li = document.createElement('li');

                    li.className = 'world-book-select-item';

                    const isChecked = (character.worldBookIds || []).includes(book.id);

                    li.innerHTML = `<input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-${book.id}">${book.name}</label>`;

                    worldBookSelectionList.appendChild(li);

                });

                worldBookSelectionModal.classList.add('visible');

            });



            saveWorldBookSelectionBtn.addEventListener('click', async () => {

                const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);

                if (currentChatType === 'private') {

                    const character = db.characters.find(c => c.id === currentChatId);

                    if (character) character.worldBookIds = selectedIds;

                } else if (currentChatType === 'group') {

                    const group = db.groups.find(g => g.id === currentChatId);

                    if (group) group.worldBookIds = selectedIds;

                }

                await saveData();

                worldBookSelectionModal.classList.remove('visible');

                showToast('世界书关联已更新');

            });

        }



        function loadSettingsToSidebar() {

            const e = db.characters.find(e => e.id === currentChatId);

            if (e) {

                document.getElementById('setting-char-avatar-preview').src = e.avatar;

                document.getElementById('setting-char-remark').value = e.remarkName;

                document.getElementById('setting-char-persona').value = e.persona;

                document.getElementById('setting-my-avatar-preview').src = e.myAvatar;

                document.getElementById('setting-my-name').value = e.myName;

                document.getElementById('setting-my-persona').value = e.myPersona;

                document.getElementById('setting-max-memory').value = e.maxMemory;

                const useCustomCssCheckbox = document.getElementById('setting-use-custom-css'),

                    customCssTextarea = document.getElementById('setting-custom-bubble-css'),

                    privatePreviewBox = document.getElementById('private-bubble-css-preview');

                useCustomCssCheckbox.checked = e.useCustomBubbleCss || false;

                customCssTextarea.value = e.customBubbleCss || '';

                customCssTextarea.disabled = !useCustomCssCheckbox.checked;

                const defaultThemeKey = Object.keys(colorThemes)[0]; // 自动找到我们仅剩的那个主题名字
        const theme = colorThemes[defaultThemeKey];        

                updateBubbleCssPreview(privatePreviewBox, e.customBubbleCss, !e.useCustomBubbleCss, theme);

            }

        }



        async function saveSettingsFromSidebar() {

            const e = db.characters.find(e => e.id === currentChatId);

            if (e) {

                e.avatar = document.getElementById('setting-char-avatar-preview').src;

                e.remarkName = document.getElementById('setting-char-remark').value;

                e.persona = document.getElementById('setting-char-persona').value;

                e.myAvatar = document.getElementById('setting-my-avatar-preview').src;

                e.myName = document.getElementById('setting-my-name').value;

                e.myPersona = document.getElementById('setting-my-persona').value;

                
                e.maxMemory = document.getElementById('setting-max-memory').value;

                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;

                e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;

                await saveData();

                showToast('设置已保存！');

                chatRoomTitle.textContent = e.remarkName;

                renderChatList();

                updateCustomBubbleStyle(currentChatId, e.customBubbleCss, e.useCustomBubbleCss);

                currentPage = 1;

                renderMessages(false, true);
                
                e.useCustomBubbleCss = document.getElementById('setting-use-custom-css').checked;
        e.customBubbleCss = document.getElementById('setting-custom-bubble-css').value;

        await saveData();

            }

        }



        function setupApiSettingsApp() {

            const e = document.getElementById('api-form'), t = document.getElementById('fetch-models-btn'),

                a = document.getElementById('api-model'), n = document.getElementById('api-provider'),

                r = document.getElementById('api-url'), s = document.getElementById('api-key'), c = {

                    newapi: '',

                    deepseek: 'https://api.deepseek.com',

                    claude: 'https://api.anthropic.com',

                    gemini: 'https://generativelanguage.googleapis.com'

                };



            db.apiSettings && (n.value = db.apiSettings.provider || 'newapi', r.value = db.apiSettings.url || '', s.value = db.apiSettings.key || '', db.apiSettings.model && (a.innerHTML = `<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`));

            n.addEventListener('change', () => {

                r.value = c[n.value] || ''

            });

            t.addEventListener('click', async () => {

                let o = r.value.trim();

                const l = s.value.trim();

                if (!o || !l) return showToast('请先填写API地址和密钥！');

                o.endsWith('/') && (o = o.slice(0, -1));

                const i = 'gemini' === n.value ? `${o}/v1beta/models?key=${getRandomValue(l)}` : `${o}/v1/models`;

                t.classList.add('loading'), t.disabled = !0;

                try {

                    const d = 'gemini' === n.value ? {} : {Authorization: `Bearer ${l}`},

                        g = await fetch(i, {method: 'GET', headers: d});

                    if (!g.ok) throw new Error(`网络响应错误: ${g.status}`);

                    const u = await g.json();

                    let p = [];

                    'gemini' !== n.value && u.data ? p = u.data.map(e => e.id) : 'gemini' === n.value && u.models && (p = u.models.map(e => e.name.replace('models/', ''))), a.innerHTML = '', p.length > 0 ? p.forEach(e => {

                        const t = document.createElement('option');

                        t.value = e, t.textContent = e, a.appendChild(t)

                    }) : a.innerHTML = '<option value="">未找到任何模型</option>', showToast('模型列表拉取成功！')

                } catch (f) {

                    showToast(`拉取失败: ${f.message}`), a.innerHTML = '<option value="">拉取失败</option>'

                } finally {

                    t.classList.remove('loading'), t.disabled = !1

                }

            });

            e.addEventListener('submit', async (e) => {

                e.preventDefault();

                if (!a.value) return showToast('请选择模型后保存！');

                const banApi = URLBlacklist.some((api)=>{

                    return r.indexOf(api) !== -1

                })

                if(banApi){

                    alert('此API网址已加入黑名单，请勿使用')

                    return

                }

                db.apiSettings = {provider: n.value, url: r.value, key: s.value, model: a.value};

                await saveData();

                showToast('API设置已保存！')

            })

        }



        function setupWallpaperApp() {

            const e = document.getElementById('wallpaper-upload'), t = document.getElementById('wallpaper-preview');

            t.style.backgroundImage = `url(${db.wallpaper})`, t.textContent = '', e.addEventListener('change', async (a) => {

                const n = a.target.files[0];

                if (n) {

                    try {

                        const r = await compressImage(n, {quality: 0.85, maxWidth: 1080, maxHeight: 1920});

                        db.wallpaper = r, applyWallpaper(r), t.style.backgroundImage = `url(${r})`;

                        await saveData();

                        showToast('壁纸更换成功！');

                    } catch (s) {

                        showToast('壁纸压缩失败，请重试');

                    }

                }

            });

        }



        // --- GROUP CHAT FUNCTIONS ---

        function setupGroupChatSystem() {

            createGroupBtn.addEventListener('click', () => {

                renderMemberSelectionList();

                createGroupModal.classList.add('visible');

            });

            createGroupForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);

                const groupName = groupNameInput.value.trim();

                if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。');

                if (!groupName) return showToast('请输入群聊名称。');

                const firstChar = db.characters.length > 0 ? db.characters[0] : null;

                const newGroup = {

                    id: `group_${Date.now()}`,

                    name: groupName,

                    avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg',

                    me: {

                        nickname: firstChar ? firstChar.myName : '我',

                        persona: firstChar ? firstChar.myPersona : '',

                        avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg'

                    },

                    members: selectedMemberIds.map(charId => {

                        const char = db.characters.find(c => c.id === charId);

                        return {

                            id: `member_${char.id}`,

                            originalCharId: char.id,

                            realName: char.realName,

                            groupNickname: char.remarkName,

                            persona: char.persona,

                            avatar: char.avatar

                        };

                    }),

                    theme: 'white_blue',

                    maxMemory: 10,

                    chatBg: '',

                    history: [],

                    isPinned: false,

                    useCustomBubbleCss: false,

                    customBubbleCss: '',

                    worldBookIds: []

                };

                db.groups.push(newGroup);

                await saveData();

                renderChatList();

                createGroupModal.classList.remove('visible');

                showToast(`群聊“${groupName}”创建成功！`);

            });

            groupSettingsForm.addEventListener('submit', e => {

                e.preventDefault();

                saveGroupSettingsFromSidebar();

                groupSettingsSidebar.classList.remove('open');

            });

            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),

                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),

                resetGroupCustomCssBtn = document.getElementById('reset-group-custom-bubble-css-btn'),

                groupPreviewBox = document.getElementById('group-bubble-css-preview');

            useGroupCustomCssCheckbox.addEventListener('change', (e) => {

                groupCustomCssTextarea.disabled = !e.target.checked;

                const group = db.groups.find(g => g.id === currentChatId);

                if (group) {

                    const theme = colorThemes[group.theme || 'white_blue'];

                    updateBubbleCssPreview(groupPreviewBox, groupCustomCssTextarea.value, !e.target.checked, theme);

                }

            });

            groupCustomCssTextarea.addEventListener('input', (e) => {

                const group = db.groups.find(g => g.id === currentChatId);

                if (group && useGroupCustomCssCheckbox.checked) {

                    const theme = colorThemes[group.theme || 'white_blue'];

                    updateBubbleCssPreview(groupPreviewBox, e.target.value, false, theme);

                }

            });

            resetGroupCustomCssBtn.addEventListener('click', () => {

                const group = db.groups.find(g => g.id === currentChatId);

                if (group) {

                    groupCustomCssTextarea.value = '';

                    useGroupCustomCssCheckbox.checked = false;

                    groupCustomCssTextarea.disabled = true;

                    const theme = colorThemes[group.theme || 'white_blue'];

                    updateBubbleCssPreview(groupPreviewBox, '', true, theme);

                    showToast('样式已重置为默认');

                }

            });

            document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        const group = db.groups.find(g => g.id === currentChatId);

                        if (group) {

                            group.avatar = compressedUrl;

                            document.getElementById('setting-group-avatar-preview').src = compressedUrl;

                        }

                    } catch (error) {

                        showToast('群头像压缩失败，请重试');

                    }

                }

            });

            document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {

                            quality: 0.85,

                            maxWidth: 1080,

                            maxHeight: 1920

                        });

                        const group = db.groups.find(g => g.id === currentChatId);

                        if (group) {

                            group.chatBg = compressedUrl;

                            chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;

                            await saveData();

                            showToast('聊天背景已更换');

                        }

                    } catch (error) {

                        showToast('群聊背景压缩失败，请重试');

                    }

                }

            });

            document.getElementById('clear-group-chat-history-btn').addEventListener('click', async () => {

                const group = db.groups.find(g => g.id === currentChatId);

                if (!group) return;

                if (confirm(`你确定要清空群聊“${group.name}”的所有聊天记录吗？这个操作是不可恢复的！`)) {

                    group.history = [];

                    await saveData();

                    renderMessages(false, true);

                    renderChatList();

                    groupSettingsSidebar.classList.remove('open');

                    showToast('聊天记录已清空');

                }

            });

            groupMembersListContainer.addEventListener('click', e => {

                const memberDiv = e.target.closest('.group-member');

                const addBtn = e.target.closest('.add-member-btn');

                if (memberDiv) {

                    openGroupMemberEditModal(memberDiv.dataset.id);

                } else if (addBtn) {

                    addMemberActionSheet.classList.add('visible');

                }

            });

            document.getElementById('edit-member-avatar-preview').addEventListener('click', () => {

                document.getElementById('edit-member-avatar-upload').click();

            });

            document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        document.getElementById('edit-member-avatar-preview').src = compressedUrl;

                    } catch (error) {

                        showToast('成员头像压缩失败，请重试');

                    }

                }

            });

            editGroupMemberForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const memberId = document.getElementById('editing-member-id').value;

                const group = db.groups.find(g => g.id === currentChatId);

                const member = group.members.find(m => m.id === memberId);

                if (member) {

                    member.avatar = document.getElementById('edit-member-avatar-preview').src;

                    member.groupNickname = document.getElementById('edit-member-group-nickname').value;

                    member.realName = document.getElementById('edit-member-real-name').value;

                    member.persona = document.getElementById('edit-member-persona').value;

                    await saveData();

                    renderGroupMembersInSettings(group);

                    document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => {

                        el.textContent = member.groupNickname;

                    });

                    showToast('成员信息已更新');

                }

                editGroupMemberModal.classList.remove('visible');

            });

            inviteExistingMemberBtn.addEventListener('click', () => {

                renderInviteSelectionList();

                inviteMemberModal.classList.add('visible');

                addMemberActionSheet.classList.remove('visible');

            });

            createNewMemberBtn.addEventListener('click', () => {

                createMemberForGroupForm.reset();

                document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';

                createMemberForGroupModal.classList.add('visible');

                addMemberActionSheet.classList.remove('visible');

            });

            document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => {

                document.getElementById('create-group-member-avatar-upload').click();

            });

            document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        document.getElementById('create-group-member-avatar-preview').src = compressedUrl;

                    } catch (error) {

                        showToast('新成员头像压缩失败，请重试');

                    }

                }

            });

            confirmInviteBtn.addEventListener('click', async () => {

                const group = db.groups.find(g => g.id === currentChatId);

                if (!group) return;

                const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);

                selectedCharIds.forEach(charId => {

                    const char = db.characters.find(c => c.id === charId);

                    if (char) {

                        const newMember = {

                            id: `member_${char.id}`,

                            originalCharId: char.id,

                            realName: char.realName,

                            groupNickname: char.remarkName,

                            persona: char.persona,

                            avatar: char.avatar

                        };

                        group.members.push(newMember);

                        sendInviteNotification(group, newMember.realName);

                    }

                });

                if (selectedCharIds.length > 0) {

                    await saveData();

                    renderGroupMembersInSettings(group);

                    renderMessages(false, true);

                    showToast('已邀请新成员');

                }

                inviteMemberModal.classList.remove('visible');

            });

            createMemberForGroupForm.addEventListener('submit', async (e) => {

                e.preventDefault();

                const group = db.groups.find(g => g.id === currentChatId);

                if (!group) return;

                const newMember = {

                    id: `member_group_only_${Date.now()}`,

                    originalCharId: null,

                    realName: document.getElementById('create-group-member-realname').value,

                    groupNickname: document.getElementById('create-group-member-nickname').value,

                    persona: document.getElementById('create-group-member-persona').value,

                    avatar: document.getElementById('create-group-member-avatar-preview').src,

                };

                group.members.push(newMember);

                sendInviteNotification(group, newMember.realName);

                await saveData();

                renderGroupMembersInSettings(group);

                renderMessages(false, true);

                showToast(`新成员 ${newMember.groupNickname} 已加入`);

                createMemberForGroupModal.classList.remove('visible');

            });

            document.getElementById('setting-group-my-avatar-upload').addEventListener('change', async (e) => {

                const file = e.target.files[0];

                if (file) {

                    try {

                        const compressedUrl = await compressImage(file, {quality: 0.8, maxWidth: 400, maxHeight: 400});

                        document.getElementById('setting-group-my-avatar-preview').src = compressedUrl;

                    } catch (error) {

                        showToast('头像压缩失败')

                    }

                }

            });

            confirmGroupRecipientBtn.addEventListener('click', () => {

                const selectedRecipientIds = Array.from(groupRecipientSelectionList.querySelectorAll('input:checked')).map(input => input.value);

                if (selectedRecipientIds.length === 0) {

                    return showToast('请至少选择一个收件人。');

                }

                currentGroupAction.recipients = selectedRecipientIds;

                groupRecipientSelectionModal.classList.remove('visible');



                if (currentGroupAction.type === 'transfer') {

                    sendTransferForm.reset();

                    sendTransferModal.classList.add('visible');

                } else if (currentGroupAction.type === 'gift') {

                    sendGiftForm.reset();

                    sendGiftModal.classList.add('visible');

                }

            });

            linkGroupWorldBookBtn.addEventListener('click', () => {

                const group = db.groups.find(g => g.id === currentChatId);

                if (!group) return;

                worldBookSelectionList.innerHTML = '';

                db.worldBooks.forEach(book => {

                    const li = document.createElement('li');

                    li.className = 'world-book-select-item';

                    const isChecked = (group.worldBookIds || []).includes(book.id);

                    li.innerHTML = `<input type="checkbox" id="wb-select-group-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}><label for="wb-select-group-${book.id}">${book.name}</label>`;

                    worldBookSelectionList.appendChild(li);

                });

                worldBookSelectionModal.classList.add('visible');

            });

        }



        function renderMemberSelectionList() {

            memberSelectionList.innerHTML = '';

            if (db.characters.length === 0) {

                memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>';

                return;

            }

            db.characters.forEach(char => {

                const li = document.createElement('li');

                li.className = 'member-selection-item';

                li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label>`;

                memberSelectionList.appendChild(li);

            });

        }



        function loadGroupSettingsToSidebar() {

            const group = db.groups.find(g => g.id === currentChatId);

            if (!group) return;


            document.getElementById('setting-group-avatar-preview').src = group.avatar;

            document.getElementById('setting-group-name').value = group.name;

            document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;

            document.getElementById('setting-group-my-nickname').value = group.me.nickname;


            document.getElementById('setting-group-max-memory').value = group.maxMemory;

            renderGroupMembersInSettings(group);

            const useGroupCustomCssCheckbox = document.getElementById('setting-group-use-custom-css'),

                groupCustomCssTextarea = document.getElementById('setting-group-custom-bubble-css'),

                groupPreviewBox = document.getElementById('group-bubble-css-preview');

            useGroupCustomCssCheckbox.checked = group.useCustomBubbleCss || false;

            groupCustomCssTextarea.value = group.customBubbleCss || '';

            groupCustomCssTextarea.disabled = !useGroupCustomCssCheckbox.checked;

            const theme = colorThemes[group.theme || 'white_blue'];

            updateBubbleCssPreview(groupPreviewBox, group.customBubbleCss, !group.useCustomBubbleCss, theme);

        }



        function renderGroupMembersInSettings(group) {

            groupMembersListContainer.innerHTML = '';

            group.members.forEach(member => {

                const memberDiv = document.createElement('div');

                memberDiv.className = 'group-member';

                memberDiv.dataset.id = member.id;

                memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;

                groupMembersListContainer.appendChild(memberDiv);

            });

            const addBtn = document.createElement('div');

            addBtn.className = 'add-member-btn';

            addBtn.innerHTML = `<div class="add-icon">+</div><span>添加</span>`;

            groupMembersListContainer.appendChild(addBtn);

        }



        function renderGroupRecipientSelectionList(actionText) {

            const group = db.groups.find(g => g.id === currentChatId);

            if (!group) return;

            groupRecipientSelectionTitle.textContent = actionText;

            groupRecipientSelectionList.innerHTML = '';

            group.members.forEach(member => {

                const li = document.createElement('li');

                li.className = 'group-recipient-select-item';

                li.innerHTML = `

                        <input type="checkbox" id="recipient-select-${member.id}" value="${member.id}">

                        <label for="recipient-select-${member.id}">

                            <img src="${member.avatar}" alt="${member.groupNickname}">

                            <span>${member.groupNickname}</span>

                        </label>`;

                groupRecipientSelectionList.appendChild(li);

            });

        }



        async function saveGroupSettingsFromSidebar() {

            const group = db.groups.find(g => g.id === currentChatId);

            if (!group) return;

            const oldName = group.name;

            const newName = document.getElementById('setting-group-name').value;

            if (oldName !== newName) {

                group.name = newName;

                sendRenameNotification(group, newName);

            }

            group.avatar = document.getElementById('setting-group-avatar-preview').src;

            group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;

            group.me.nickname = document.getElementById('setting-group-my-nickname').value;

            group.me.persona = document.getElementById('setting-group-my-persona').value;

            group.maxMemory = document.getElementById('setting-group-max-memory').value;

            group.useCustomBubbleCss = document.getElementById('setting-group-use-custom-css').checked;

            group.customBubbleCss = document.getElementById('setting-group-custom-bubble-css').value;

            updateCustomBubbleStyle(currentChatId, group.customBubbleCss, group.useCustomBubbleCss);

            await saveData();

            showToast('群聊设置已保存！');

            chatRoomTitle.textContent = group.name;

            renderChatList();

            renderMessages(false, true);

        }



        function openGroupMemberEditModal(memberId) {

            const group = db.groups.find(g => g.id === currentChatId);

            const member = group.members.find(m => m.id === memberId);

            if (!member) return;

            document.getElementById('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`;

            document.getElementById('editing-member-id').value = member.id;

            document.getElementById('edit-member-avatar-preview').src = member.avatar;

            document.getElementById('edit-member-group-nickname').value = member.groupNickname;

            document.getElementById('edit-member-real-name').value = member.realName;

            document.getElementById('edit-member-persona').value = member.persona;

            editGroupMemberModal.classList.add('visible');

        }



        function renderInviteSelectionList() {

            inviteMemberSelectionList.innerHTML = '';

            const group = db.groups.find(g => g.id === currentChatId);

            if (!group) return;

            const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));

            const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));

            if (availableChars.length === 0) {

                inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>';

                confirmInviteBtn.disabled = true;

                return;

            }

            confirmInviteBtn.disabled = false;

            availableChars.forEach(char => {

                const li = document.createElement('li');

                li.className = 'invite-member-select-item';

                li.innerHTML = `<input type="checkbox" id="invite-select-${char.id}" value="${char.id}"><label for="invite-select-${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><span>${char.remarkName}</span></label>`;

                inviteMemberSelectionList.appendChild(li);

            });

        }



        function sendInviteNotification(group, newMemberRealName) {

            const messageContent = `[${group.me.nickname}邀请${newMemberRealName}加入了群聊]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: messageContent,

                parts: [{type: 'text', text: messageContent}],

                timestamp: Date.now(),

                senderId: 'user_me'

            };

            group.history.push(message);

        }



        function sendRenameNotification(group, newName) {

            const myName = group.me.nickname;

            const messageContent = `[${myName}修改群名为：${newName}]`;

            const message = {

                id: `msg_${Date.now()}`,

                role: 'user',

                content: messageContent,

                parts: [{type: 'text', text: messageContent}],

                timestamp: Date.now()

            };

            group.history.push(message);

        }
// 加在你的主初始化函数（比如 init）或者 setupChatRoom 函数里
const diaryBtn = document.getElementById('diary-btn');
if(diaryBtn) {
    diaryBtn.addEventListener('click', () => {
        // 将来这里会是打开日记页面的代码
        // 现在我们先用一个提示来占位
        showToast('正在打开日记本...');
        console.log('点击了日记按钮！');
    });
}

// --- Diary System Functions ---
let currentDiaryCharacterId = null;

                    function setupMemoSystem() {
        const addMemoBtn = document.getElementById('add-memo-btn');
        const editMemoForm = document.getElementById('edit-memo-form');
        const editMemoTitle = document.getElementById('edit-memo-title');
        const editMemoIdInput = document.getElementById('memo-edit-id');
        const memoListContainer = document.getElementById('memo-list-container'); // 我们新找到了列表容器

        // “+”号按钮的逻辑 (这个不变)
        addMemoBtn.addEventListener('click', () => {
            editMemoForm.reset();
            editMemoTitle.textContent = '创建备-';
            editMemoIdInput.value = '';
            updateLinkedCharOptions();
            switchScreen('edit-memo-screen');
        });

        // “保存”按钮的逻辑 (这个也不变)
        editMemoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editMemoIdInput.value;
            const content = document.getElementById('memo-content').value.trim();
            const targetDate = document.getElementById('memo-target-date').value;
            const linkedCharId = document.getElementById('memo-linked-char').value;
            if (!content) { showToast('事件内容不能为空哦。'); return; }
            if (id) {
                const memo = db.memos.find(m => m.id === id);
                if (memo) { Object.assign(memo, { content, targetDate, linkedCharId }); }
            } else {
                const newMemo = { id: `memo_${Date.now()}`, content, targetDate, linkedCharId, createdAt: Date.now() };
                db.memos.push(newMemo);
            }
            await saveData();
            showToast('备忘已保存！');
            renderMemoList();
            switchScreen('memo-screen');
        });

        // ▼▼▼ 新增的灵魂在这里：监听整个列表的点击事件 ▼▼▼
        memoListContainer.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.memo-edit-btn');
            const deleteBtn = e.target.closest('.memo-delete-btn');

            if (editBtn) {
                const memoId = editBtn.dataset.id;
                const memoToEdit = db.memos.find(m => m.id === memoId);
                if (memoToEdit) {
                    // 把旧数据填回表单
                    editMemoTitle.textContent = '编辑备忘录';
                    editMemoIdInput.value = memoToEdit.id;
                    document.getElementById('memo-content').value = memoToEdit.content;
                    document.getElementById('memo-target-date').value = memoToEdit.targetDate;
                    updateLinkedCharOptions(memoToEdit.linkedCharId); // 顺便选中正确的角色

                    switchScreen('edit-memo-screen');
                }
            }

            if (deleteBtn) {
                const memoId = deleteBtn.dataset.id;
                if (confirm('确定要删除这条备忘录吗？')) {
                    db.memos = db.memos.filter(m => m.id !== memoId);
                    await saveData();
                    renderMemoList(); // 重新渲染列表
                    showToast('备忘录已删除');
                }
            }
        });
    }
    
    function setupMemoCountdownWidget() {
    // 先找到主屏幕上那两个用来显示文字的地方
    const countdownElement = document.getElementById('memo-countdown');
    const previewElement = document.getElementById('memo-content-preview');
// ✨ 这是核心的更新函数，我们会让它定时执行
function updateCountdown() {
    // 如果 db.memos 这个抽屉不存在，或者里面是空的，就直接不工作了
    if (!db.memos) return;

    const now = new Date();
const futureMemos = db.memos.filter(memo => memo.targetDate && (new Date(memo.targetDate + "T23:59:59") > now));

if (futureMemos.length === 0) {
    previewElement.textContent = '暂无备忘';
    countdownElement.textContent = '为将来设定一个目标吧';
    countdownElement.style.fontSize = '14px'; // 恢复默认字体大小
    return;
}

futureMemos.sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
const nextMemo = futureMemos[0];

// ✨ 核心升级在这里：我们把截止时间设为那一天的最后一秒，这样更符合直觉 ✨
const timeLeft = new Date(nextMemo.targetDate + "T23:59:59").getTime() - now.getTime();

// 如果时间已经到了或超过
if (timeLeft <= 0) {
    previewElement.textContent = nextMemo.content.slice(0, 10) + (nextMemo.content.length > 10 ? '...' : '');
    countdownElement.textContent = '时间到啦！🎉';
    countdownElement.style.fontSize = '20px'; // 可以给个醒目的字体
    return;
}

// 把毫秒换算成天、小时、分钟和秒！
const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

// 更新主屏幕上的文字，用 pad 函数补零，更好看
countdownElement.textContent = `${days}天 ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
previewElement.textContent = nextMemo.content.slice(0, 10) + (nextMemo.content.length > 10 ? '...' : '');
countdownElement.style.fontSize = '22px'; // 让倒计时数字更大更清晰

}

// 7. 让这个“管家”每分钟都工作一次
setInterval(updateCountdown, 1000); // 1000毫秒就是1秒

// 8. 并且，在页面刚加载好时，就立即执行一次，这样不用等一分钟才能看到效果
updateCountdown();

}


              function updateLinkedCharOptions(selectedCharId = '') {
            const linkedCharSelect = document.getElementById('memo-linked-char');
            linkedCharSelect.innerHTML = ''; // 清空

            const noCharOption = document.createElement('option');
            noCharOption.value = '';
            noCharOption.textContent = '无 (仅自己可见)';
            linkedCharSelect.appendChild(noCharOption);

            db.characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char.id;
                option.textContent = char.remarkName;
                if (char.id === selectedCharId) {
                    option.selected = true;
                }
                linkedCharSelect.appendChild(option);
            });
        }

        
        
                function renderMemoList() {
    const container = document.getElementById('memo-list-container');
    container.innerHTML = '';
if (!db.memos || db.memos.length === 0) {
    container.innerHTML = `<p class="placeholder-text" style="padding-top: 50px;">还没有备忘录，<br>点击右上角的“+”创建一个吧！</p>`;
    return;
}

const sortedMemos = [...db.memos].sort((a, b) => b.createdAt - a.createdAt);

sortedMemos.forEach(memo => {
    const li = document.createElement('li');
    li.className = 'list-item chat-item';
    li.dataset.id = memo.id;

    const linkedChar = memo.linkedCharId ? db.characters.find(c => c.id === memo.linkedCharId) : null;
    const charName = linkedChar ? linkedChar.remarkName : '无';
    const dateDisplay = memo.targetDate ? `目标日期: ${memo.targetDate}` : '未设置日期';

    // ▼▼▼ 核心修改在这里：我们加了一个放按钮的小盒子 `memo-actions` ▼▼▼
    li.innerHTML = `
        <div class="item-details" style="padding: 10px 0; flex-grow: 1;">
            <p style="font-size: 16px; color: #333; margin: 0 0 10px 0; white-space: pre-wrap; line-height: 1.6;">${memo.content}</p>
            <div style="font-size: 13px; color: #777; display: flex; justify-content: space-between; align-items: center;">
               <span><b style="color: #6B8AB8;">提醒人:</b> ${charName}</span>
               <span style="color: #aaa;">${dateDisplay}</span>
            </div>
        </div>
        <div class="memo-actions" style="display: flex; gap: 5px; padding-left: 15px;">
            <button class="action-btn memo-edit-btn" data-id="${memo.id}" style="font-size: 16px; color: #888;">✎</button>
            <button class="action-btn memo-delete-btn" data-id="${memo.id}" style="font-size: 20px; color: #aaa;">×</button>
        </div>
    `;
    container.appendChild(li);
});

}




function setupDiarySystem() {
    const diaryBtn = document.getElementById('diary-btn');
    if (diaryBtn) {
        diaryBtn.addEventListener('click', () => {
            // 我们只在私聊中显示日记按钮，所以这里 currentChatType 肯定是 'private'
            if (currentChatId) {
                openDiaryScreen(currentChatId);
            }
        });
    }

    const editDiaryForm = document.getElementById('edit-diary-form');
    const diaryTextInput = document.getElementById('diary-text-input');
    const diaryCharCounter = document.getElementById('diary-char-counter');

    diaryTextInput.addEventListener('input', () => {
        const count = diaryTextInput.value.length;
        diaryCharCounter.textContent = `${count} / 150`;
    });

    editDiaryForm.addEventListener('submit', async(e) => {
        e.preventDefault();
        saveDiaryEdit();
    });

    document.getElementById('edit-diary-modal').addEventListener('click', (e) => {
        if(e.target.id === 'edit-diary-modal') {
             document.getElementById('edit-diary-modal').classList.remove('visible');
        }
    });

    const diaryListContainer = document.getElementById('diary-list-container');
    diaryListContainer.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.diary-edit-btn');
        const deleteBtn = e.target.closest('.diary-delete-btn');

        if(editBtn) {
            const diaryId = editBtn.dataset.id;
            openDiaryEditModal(diaryId);
        }
        if(deleteBtn) {
            const diaryId = deleteBtn.dataset.id;
            deleteDiaryEntry(diaryId);
        }
    });
}

function openDiaryScreen(characterId) {
    currentDiaryCharacterId = characterId;
    const character = db.characters.find(c => c.id === characterId);
    if (!character) return;
    document.getElementById('diary-screen-title').textContent = `${character.remarkName}的日记`;
    renderDiaryList();
    switchScreen('diary-screen');
}

function renderDiaryList() {
    const character = db.characters.find(c => c.id === currentDiaryCharacterId);
    const container = document.getElementById('diary-list-container');
    const placeholder = document.getElementById('no-diary-placeholder');

    container.innerHTML = '';
    if (!character || !character.diary || character.diary.length === 0) {
        placeholder.style.display = 'block';
        return;
    }

    placeholder.style.display = 'none';
    // 日记倒序显示，最新的在最上面
    [...character.diary].reverse().forEach(entry => {
        const item = document.createElement('li');
        item.className = 'diary-item';

        const date = new Date(entry.timestamp);
        const dateString = `${date.getFullYear()}年${pad(date.getMonth() + 1)}月${pad(date.getDate())}日`;

        item.innerHTML = `
            <div class="diary-item-header">
                <span class="diary-date">${dateString}</span>
                <div class="diary-actions">
                    <button class="diary-edit-btn" data-id="${entry.id}">
                        <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z"></path></svg>
                    </button>
                    <button class="diary-delete-btn" data-id="${entry.id}">
                        <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"></path></svg>
                    </button>
                </div>
            </div>
            <p class="diary-content">${entry.content}</p>
        `;
        container.appendChild(item);
    });
}

function openDiaryEditModal(diaryId) {
    const character = db.characters.find(c => c.id === currentDiaryCharacterId);
    const entry = character.diary.find(d => d.id === diaryId);
    if (!entry) return;

    document.getElementById('editing-diary-id').value = entry.id;
    const textInput = document.getElementById('diary-text-input');
    textInput.value = entry.content;
    document.getElementById('diary-char-counter').textContent = `${entry.content.length} / 150`;
    document.getElementById('edit-diary-modal').classList.add('visible');
}

async function saveDiaryEdit() {
    const diaryId = document.getElementById('editing-diary-id').value;
    const newContent = document.getElementById('diary-text-input').value.trim();

    if (!newContent) return showToast('日记内容不能为空哦。');

    const character = db.characters.find(c => c.id === currentDiaryCharacterId);
    const entryIndex = character.diary.findIndex(d => d.id === diaryId);

    if (entryIndex > -1) {
        character.diary[entryIndex].content = newContent;
        await saveData();
        renderDiaryList();
        document.getElementById('edit-diary-modal').classList.remove('visible');
        showToast('日记已更新');
    }
}

async function deleteDiaryEntry(diaryId) {
    if (confirm('真的要撕掉这一页日记吗？')) {
        const character = db.characters.find(c => c.id === currentDiaryCharacterId);
        character.diary = character.diary.filter(d => d.id !== diaryId);
        await saveData();
        renderDiaryList();
        showToast('一页回忆随风去啦...');
    }
}


                // --- Music System ---
        let currentTrackIndex = null;
        let isPlaying = false;
        let isListeningTogether = false;
        let listeningPartnerId = null;
        let audioPlayer;
        let musicSystemActivated = false; // 开关，记录音乐系统是否已启动

        function setupMusicSystem() {
            audioPlayer = document.getElementById('audio-player');
            const musicUploadInput = document.getElementById('music-upload-input');
            const playerWidget = document.getElementById('music-player-widget');
            const playerHandle = document.getElementById('music-player-handle');
            const playerPlayBtn = document.getElementById('player-play-btn');
            const playerNextBtn = document.getElementById('player-next-btn');
            const playerPrevBtn = document.getElementById('player-prev-btn');
            const listenTogetherBtn = document.getElementById('listen-together-btn');
            const listenTogetherModal = document.getElementById('listen-together-modal');

            const musicIconHtml = `<a href="#" class="app-icon" data-target="music-screen"><img src="https://i.postimg.cc/htYvkdQK/chan-146.png" alt="音乐" class="icon-img"><span class="app-name">音乐</span></a>`
            document.querySelector('.app-grid').insertAdjacentHTML('beforeend', musicIconHtml);
            document.querySelector('.app-icon[data-target="music-screen"]').addEventListener('click', () => {
                renderMusicList();
                switchScreen('music-screen');
            });

            prepareMusicTracks();

            musicUploadInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file && file.type === 'audio/mpeg') {
                    const newTrack = {
                        id: `music_${Date.now()}`,
                        name: file.name,
                        fileObject: file,
                        url: URL.createObjectURL(file)
                    };
                    db.musicTracks.push(newTrack);
                    await saveData();
                    renderMusicList();
                    showToast(`歌曲《${file.name}》已添加`);
                } else {
                    showToast('请选择一个MP3格式的文件');
                }
                event.target.value = null;
            });

            // ✨ 把列表的点击和长按事件都绑定在这里
            const musicListContainer = document.getElementById('music-list-container');
            musicListContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.music-item');
                if (item) {
                    const trackId = item.dataset.id;
                    const trackIndex = db.musicTracks.findIndex(t => t.id === trackId);
                    if (trackIndex > -1) {
                        playTrack(trackIndex);
                    }
                }
            });
            musicListContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const item = e.target.closest('.music-item');
                if (item) handleMusicLongPress(item, e.clientX, e.clientY);
            });
            musicListContainer.addEventListener('touchstart', (e) => {
                const item = e.target.closest('.music-item');
                if (!item) return;
                longPressTimer = setTimeout(() => {
                    const touch = e.touches[0];
                    handleMusicLongPress(item, touch.clientX, touch.clientY);
                }, 500);
            });
            musicListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            musicListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));


            playerPlayBtn.addEventListener('click', togglePlayPause);
            playerNextBtn.addEventListener('click', playNext);
            playerPrevBtn.addEventListener('click', playPrevious);

            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                setMusicPlayerOpen(true);
                playerPlayBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"></path></svg>`;
                updateMusicListUI();
            });
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                playerPlayBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>`;
                updateMusicListUI();
            });
            audioPlayer.addEventListener('ended', playNext);

            listenTogetherBtn.addEventListener('click', () => {
                if (isListeningTogether) {
                    stopListenTogether();
                } else {
                    if (currentTrackIndex === null) {
                        showToast('请先播放一首歌');
                        return;
                    }
                    renderListenTogetherSelection();
                    listenTogetherModal.classList.add('visible');
                }
            });
            listenTogetherModal.addEventListener('click', (e) => {
                if(e.target === listenTogetherModal) listenTogetherModal.classList.remove('visible');
                const item = e.target.closest('.member-selection-item');
                if (item) {
                    const charId = item.dataset.id;
                    startListenTogether(charId);
                    listenTogetherModal.classList.remove('visible');
                }
            });

            let isDragging = false, startY = 0, currentY = 0;
            const playerHeight = 73;

            function dragStart(e) {
                isDragging = true;
                startY = e.pageY || e.touches[0].pageY;
                currentY = startY;
                playerWidget.classList.add('is-dragging');
                document.body.style.cursor = 'grabbing';
                playerHandle.style.cursor = 'grabbing';
            }

            function dragMove(e) {
                if (!isDragging) return;
                currentY = e.pageY || e.touches[0].pageY;
                let diff = currentY - startY;

                if (playerWidget.classList.contains('is-open')) {
                    diff = diff;
                     if(diff > playerHeight) diff = playerHeight;
                     if(diff < 0) diff = 0;
                     playerWidget.style.transform = `translateY(${diff-playerHeight}px)`;
                } else {
                    if (diff < 0) diff = 0;
                    if (diff > playerHeight) diff = playerHeight;
                    playerWidget.style.transform = `translateY(${diff-playerHeight}px)`;
                }
            }

            function dragEnd() {
                if (!isDragging) return;
                isDragging = false;
                playerWidget.classList.remove('is-dragging');
                document.body.style.cursor = '';
                playerHandle.style.cursor = 'grab';

                const diff = currentY - startY;
                playerWidget.style.transform = '';

                if (playerWidget.classList.contains('is-open')) {
                    if (diff < -playerHeight / 3) {
                        setMusicPlayerOpen(false);
                    } else {
                        setMusicPlayerOpen(true);
                    }
                } else {
                    if (diff > playerHeight / 2) {
                        setMusicPlayerOpen(true);
                    } else {
                        setMusicPlayerOpen(false);
                    }
                }
            }

            playerHandle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            playerHandle.addEventListener('touchstart', dragStart, { passive: true });
            document.addEventListener('touchmove', dragMove);
            document.addEventListener('touchend', dragEnd);

            playerHandle.addEventListener('click', (e) => {
                if(Math.abs(currentY - startY) < 5) {
                    setMusicPlayerOpen(!playerWidget.classList.contains('is-open'));
                }
            });

             document.getElementById('phone-screen').addEventListener('click', (e) => {
                const playerIsOpenAndClickedOutside = playerWidget.classList.contains('is-open') && !playerWidget.contains(e.target) && !playerHandle.contains(e.target);
                const aParentIsPlayerTrigger = e.target.closest('[data-target="music-screen"], .music-item, #player-play-btn, #player-next-btn, #player-prev-btn, #listen-together-btn, #listening-together-display');
                if (playerIsOpenAndClickedOutside && !aParentIsPlayerTrigger) {
                    setMusicPlayerOpen(false);
                }
            });
        }

        // ✨ 新的函数，用来添加“内增高”
        function activateHandlePadding() {
            if (musicSystemActivated) return;
            document.getElementById('music-player-handle').style.display = 'flex';
            document.getElementById('phone-screen').classList.add('music-handle-active');
            musicSystemActivated = true;
        }


        function setMusicPlayerOpen(isOpen) {
            const playerWidget = document.getElementById('music-player-widget');
            const playerHandle = document.getElementById('music-player-handle');
            if (isOpen) {
                playerWidget.classList.add('is-open');
                playerHandle.style.top = `${playerWidget.offsetHeight}px`;
            } else {
                playerWidget.classList.remove('is-open');
                playerHandle.style.top = '0';
            }
        }

        function prepareMusicTracks() {
            db.musicTracks.forEach(track => {
                if (track.fileObject && !track.url) {
                    track.url = URL.createObjectURL(track.fileObject);
                }
            });
        }

        function renderMusicList() {
            const container = document.getElementById('music-list-container');
            const placeholder = document.getElementById('no-music-placeholder');
            container.innerHTML = '';

            if (db.musicTracks.length === 0) {
                placeholder.style.display = 'block';
                return;
            }

            placeholder.style.display = 'none';
            db.musicTracks.forEach((track) => {
                const li = document.createElement('li');
                li.className = 'music-item';
                li.dataset.id = track.id;
                li.innerHTML = `
                    <div class="music-icon">
                       <svg viewBox="0 0 24 24"><path d="M12,3V12.26C11.5,12.09 11,12 10.5,12C8,12 6,14 6,16.5C6,19 8,21 10.5,21C13,21 15,19 15,16.5V6H19V3H12Z" /></svg>
                    </div>
                    <span class="music-name">${track.name.replace('.mp3', '')}</span>
                `;
                container.appendChild(li);
            });
            updateMusicListUI();
        }

        // ✨ 新的长按处理函数 ✨
        function handleMusicLongPress(item, x, y) {
            clearTimeout(longPressTimer);
            const trackId = item.dataset.id;
            const track = db.musicTracks.find(t => t.id === trackId);
            if (!track) return;

            createContextMenu([{
                label: '删除',
                danger: true,
                action: async () => {
                    if (confirm(`确定要删除歌曲《${track.name}》吗？`)) {
                        const trackIndexToDelete = db.musicTracks.findIndex(t => t.id === trackId);

                        // 从数据库中移除
                        db.musicTracks = db.musicTracks.filter(t => t.id !== trackId);

                        // 如果删除的是正在播放的歌曲
                        if (trackIndexToDelete === currentTrackIndex) {
                             if (db.musicTracks.length > 0) {
                                // 如果后面还有歌,就播下一首，否则播第一首
                                const nextIndex = (trackIndexToDelete >= db.musicTracks.length) ? 0 : trackIndexToDelete;
                                playTrack(nextIndex);
                            } else {
                                // 列表空了，停止所有
                                isPlaying = false;
                                currentTrackIndex = null;
                                audioPlayer.pause();
                                audioPlayer.src = '';
                                document.getElementById('player-track-name').textContent = '未选择歌曲';
                                document.getElementById('player-track-artist').textContent = '未知艺术家';
                                setMusicPlayerOpen(false);
                            }
                        } else {
                            // 如果删除的不是当前播放的，但它在当前歌曲之前，需要更新 currentTrackIndex
                            if (trackIndexToDelete < currentTrackIndex) {
                                currentTrackIndex--;
                            }
                        }

                        await saveData();
                        renderMusicList(); // 重新渲染列表
                        showToast(`歌曲《${track.name}》已删除`);
                    }
                }
            }], x, y);
        }

        function updateMusicListUI() {
             document.querySelectorAll('.music-item').forEach(item => {
                const trackId = item.dataset.id;
                const trackIndex = db.musicTracks.findIndex(t => t.id === trackId);
                 if (trackIndex === currentTrackIndex && isPlaying) {
                    item.classList.add('playing');
                } else {
                    item.classList.remove('playing');
                }
            });
        }

        function updatePlayerUI(track) {
            document.getElementById('player-album-art').src = "https://i.postimg.cc/htYvkdQK/chan-146.png";
            document.getElementById('player-track-name').textContent = track.name.replace('.mp3', '');
            document.getElementById('player-track-artist').textContent = "本地音乐";
        }

        function togglePlayPause() {
            if(currentTrackIndex === null && db.musicTracks.length > 0) {
                 playTrack(0);
            } else {
                if (isPlaying) {
                    audioPlayer.pause();
                } else if (currentTrackIndex !== null) {
                    audioPlayer.play();
                }
            }
        }

        function playNext() {
            if (db.musicTracks.length === 0) return;
            let nextIndex = (currentTrackIndex === null) ? 0 : currentTrackIndex + 1;
            if (nextIndex >= db.musicTracks.length) {
                nextIndex = 0;
            }
            playTrack(nextIndex);
        }

        function playPrevious() {
            if (db.musicTracks.length === 0) return;
            let prevIndex = (currentTrackIndex === null) ? 0 : currentTrackIndex - 1;
            if (prevIndex < 0) {
                prevIndex = db.musicTracks.length - 1;
            }
            playTrack(prevIndex);
        }

        function renderListenTogetherSelection() {
            const list = document.getElementById('listen-together-selection-list');
            list.innerHTML = '';
            if (db.characters.length === 0) {
                list.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可以一起听歌的角色。</li>';
                 return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.dataset.id = char.id;
                li.innerHTML = `<img src="${char.avatar}" alt="${char.remarkName}"><label>${char.remarkName}</label>`;
                list.appendChild(li);
            });
        }

        function startListenTogether(charId) {
            const character = db.characters.find(c => c.id === charId);
            if (!character) return;

            isListeningTogether = true;
            listeningPartnerId = charId;

            const chat = db.characters.find(c => c.id === currentChatId);
            const myAvatar = (chat && chat.myAvatar) ? chat.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg';

            document.getElementById('listen-together-btn').style.display = 'none';
            const display = document.getElementById('listening-together-display');
            document.getElementById('listener-avatar-1').src = myAvatar;
            document.getElementById('listener-avatar-2').src = character.avatar;
            document.getElementById('listening-status-text').textContent = `与 ${character.remarkName} ...`;
            display.style.display = 'flex';

            display.style.cursor = 'pointer';
            display.onclick = stopListenTogether;

            showToast(`开始和 ${character.remarkName} 一起听歌`);
        }

        function stopListenTogether() {
             isListeningTogether = false;
             listeningPartnerId = null;

            const display = document.getElementById('listening-together-display');
             display.style.display = 'none';
             display.onclick = null;

             const button = document.getElementById('listen-together-btn');
             button.style.display = 'flex';
        }

        function playTrack(index) {
            if (!musicSystemActivated) {
                activateHandlePadding();
            }

            if (index < 0 || index >= db.musicTracks.length) {
                currentTrackIndex = null;
                isPlaying = false;
                audioPlayer.pause();
                audioPlayer.src = '';
                setMusicPlayerOpen(false);
                stopListenTogether();
                return;
            }
            currentTrackIndex = index;
            const track = db.musicTracks[index];

            if(!track.url && track.fileObject) track.url = URL.createObjectURL(track.fileObject);

            if(track.url) {
                 audioPlayer.src = track.url;
                 audioPlayer.play().catch(e => console.error("播放失败:", e));
                 updatePlayerUI(track);
            } else {
                showToast(`无法播放《${track.name}》`);
                playNext();
            }
        }



        function updatePlayerUI(track) {
            document.getElementById('player-album-art').src = "https://i.postimg.cc/htYvkdQK/chan-146.png"; // 默认封面
            document.getElementById('player-track-name').textContent = track.name.replace('.mp3', '');
            document.getElementById('player-track-artist').textContent = "本地音乐"; // 默认艺术家
        }

        function togglePlayPause() {
            if(currentTrackIndex === null && db.musicTracks.length > 0) {
                 playTrack(0); // 如果没在放，就开始播放第一首
            } else {
                if (isPlaying) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            }
        }

        function playNext() {
            let nextIndex = (currentTrackIndex === null) ? 0 : currentTrackIndex + 1;
            if (nextIndex >= db.musicTracks.length) {
                nextIndex = 0; // 循环播放
            }
             if (db.musicTracks.length > 0) {
                playTrack(nextIndex);
            }
        }

        function playPrevious() {
             let prevIndex = (currentTrackIndex === null) ? 0 : currentTrackIndex - 1;
            if (prevIndex < 0) {
                prevIndex = db.musicTracks.length - 1; // 循环播放
            }
            if (db.musicTracks.length > 0) {
                playTrack(prevIndex);
            }
        }

        function renderListenTogetherSelection() {
            const list = document.getElementById('listen-together-selection-list');
            list.innerHTML = '';
            if (db.characters.length === 0) {
                list.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可以一起听歌的角色。</li>';
                 return;
            }
            db.characters.forEach(char => {
                const li = document.createElement('li');
                li.className = 'member-selection-item';
                li.dataset.id = char.id;
                li.innerHTML = `<img src="${char.avatar}" alt="${char.remarkName}"><label>${char.remarkName}</label>`;
                list.appendChild(li);
            });
        }

        function startListenTogether(charId) {
            const character = db.characters.find(c => c.id === charId);
            if (!character) return;

            isListeningTogether = true;
            listeningPartnerId = charId;

            const chat = db.characters.find(c => c.id === currentChatId);
            const myAvatar = chat ? chat.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg';

            document.getElementById('listen-together-btn').style.display = 'none';
            const display = document.getElementById('listening-together-display');
            document.getElementById('listener-avatar-1').src = myAvatar;
            document.getElementById('listener-avatar-2').src = character.avatar;
            document.getElementById('listening-status-text').textContent = `正与 ${character.remarkName} 一起听...`;
            display.style.display = 'flex';

            const button = document.getElementById('listen-together-btn');
            button.classList.add('active');
            button.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,13C13.88,13 17.14,14.04 17.9,15.89C16.4,17.29 14.33,18 12,18C9.67,18 7.6,17.29 6.1,15.89C6.86,14.04 10.12,13 12,13Z" /></svg><span>独享</span>`;

            // 我们把“停止”的逻辑直接绑定在新的显示元素上
            display.style.cursor = 'pointer';
            display.onclick = stopListenTogether;

            showToast(`开始和 ${character.remarkName} 一起听歌`);
        }

        function stopListenTogether() {
             isListeningTogether = false;
             listeningPartnerId = null;

             document.getElementById('listening-together-display').style.display = 'none';
             const button = document.getElementById('listen-together-btn');
             button.style.display = 'flex';
             button.classList.remove('active');
             button.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12,2A4,4 0 0,0 8,6C8,7.91 9.5,9.45 11.38,9.91L5.5,15.5L7,17L12.88,11.12C13.5,12.14 14.62,12.83 15.91,12.94L13,15.83V22H15V17L17.91,14.1C19.19,15.22 21,15.16 22,14C23.04,12.81 22.97,11 21.8,10.03C21.03,9.26 20.04,9 19,9C18.5,9 18,9.13 17.56,9.38L12,3.81C12,3.81 12,3.81 12,3.81C11.12,4.83 10.14,5.53 9.09,6.06L11,8.04C11.5,7.92 12,7.5 12,7A2,2 0 0,1 14,9C14,9.5 13.69,9.89 13.23,9.97L11.77,8.5C11.9,8.23 12,7.88 12,7.5V7.45L9.06,4.5C9.6,4.18 10.2,4 10.83,4H10.88L15.38,8.5C15.56,8.22 15.81,8 16.1,7.84L14,5.76C14.88,4.88 15.84,4.24 16.91,4.06C14.75,2.76 12,2 12,2Z" /></svg><span>一起听</span>`;
             document.getElementById('listening-together-display').onclick = null;
        }

        

    });

</script>



</body>



</html> 




